# 腾讯云短信密钥配置说明

## 概述

腾讯云短信服务存在**两套不同的认证体系**，这经常导致开发者在配置时产生混淆。本文档详细解释这两套体系的区别，以及 PolySms 项目中应该使用哪套密钥。PolySms采用轻量级HTTP直连架构，使用新版API接口和TC3-HMAC-SHA256签名算法，提供更高的性能和安全性。

## 📋 重要提示

⚠️ **常见误区**：很多开发者以为短信控制台中显示的"SecretKey"就是项目所需的密钥，但实际上这是两个完全不同的概念！

## 🔐 腾讯云短信的双重认证体系

### 1. 应用级密钥（短信控制台显示）

**位置**：腾讯云控制台 → 短信 → 应用管理

**包含参数**：
- **SdkAppId** - 短信应用ID（如：1400009099）
- **AppKey** - 应用级密钥（用于旧版SDK）

**用途**：
- 旧版短信SDK
- 简化的短信接口
- 直接HTTP签名调用

**特点**：
- 应用级别，每个短信应用有独立的密钥
- 主要用于向后兼容
- **已逐步淘汰，不推荐使用**

### 2. 账号级API密钥（PolySms使用的）⭐

**位置**：腾讯云控制台 → 访问管理 → API密钥管理

**包含参数**：
- **SecretId** - 腾讯云账号API密钥ID
- **SecretKey** - 腾讯云账号API密钥

**用途**：
- 新版API接口（如SendSms API）
- 腾讯云所有服务的统一认证
- 云API签名方法v3（TC3-HMAC-SHA256）

**特点**：
- 账号级别，适用于所有腾讯云服务
- 更安全的TC3签名方法
- **这是PolySms项目使用的认证方式**
- 支持更精细的权限控制

## 🎯 PolySms项目配置

### 必需的参数

PolySms使用新版API调用方式，需要以下4个参数：

```json
{
  "TencentSms": {
    "SecretId": "您的腾讯云API密钥ID",
    "SecretKey": "您的腾讯云API密钥",
    "SmsSdkAppId": "您的短信应用ID",
    "Region": "ap-beijing"
  }
}
```

### 参数获取方法

#### 1. 获取 SecretId 和 SecretKey

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 **访问管理** → **[API密钥管理](https://console.cloud.tencent.com/cam/capi)**
3. 点击 **新建密钥**（如果已有密钥可直接使用）
4. 复制 **SecretId** 和 **SecretKey**

⚠️ **安全提醒**：SecretKey只在创建时显示一次，请妥善保存！

#### 2. 获取 SmsSdkAppId

1. 进入 **短信** → **[应用管理](https://console.cloud.tencent.com/smsv2/app-manage)**
2. 查看或创建短信应用
3. 复制 **SDK AppID**（注意：这里显示的AppKey不是PolySms需要的）

#### 3. 选择 Region（地域）

常用地域：
- `ap-beijing` - 北京
- `ap-shanghai` - 上海
- `ap-guangzhou` - 广州
- `ap-chengdu` - 成都
- `ap-hongkong` - 香港
- `ap-singapore` - 新加坡

## 🚀 PolySms技术优势

### 轻量级HTTP直连架构

PolySms不使用腾讯云官方SDK，而是采用HTTP直接调用的方式：

```
传统方式：
应用 → 腾讯云SDK (数十MB) → HTTP请求 → 腾讯云API

PolySms方式：
应用 → PolySms (约20KB) → HTTP请求 → 腾讯云API
```

### 自研TC3签名算法

PolySms内置了腾讯云TC3-HMAC-SHA256签名算法：

```csharp
// PolySms内部实现的TC3签名算法
public class TencentSignatureHelper
{
    public static string GenerateSignature(
        string secretKey,
        string canonicalRequest,
        string timestamp,
        string date,
        string service,
        string region)
    {
        // TC3-HMAC-SHA256签名实现
        // 1. 构建待签名字符串
        // 2. 计算签名密钥
        // 3. 生成最终签名
    }
}
```

## 📝 完整配置示例

### appsettings.json 配置

```json
{
  "Sms": {
    "DefaultProvider": "Tencent",
    "EnableFailover": true,
    "ProviderPriority": ["Tencent", "Aliyun"]
  },
  "TencentSms": {
    "SecretId": "AKID1234567890abcdefg",
    "SecretKey": "abcdefg1234567890AKID",
    "SmsSdkAppId": "1400009099",
    "Region": "ap-beijing"
  }
}
```

### 环境变量配置（推荐用于生产环境）

```bash
# 设置环境变量
export TENCENT_SECRET_ID="AKID1234567890abcdefg"
export TENCENT_SECRET_KEY="abcdefg1234567890AKID"
export TENCENT_SMS_SDK_APP_ID="1400009099"
export TENCENT_SMS_REGION="ap-beijing"
```

### 代码中配置

```csharp
builder.Services.Configure<TencentSmsOptions>(options =>
{
    options.SecretId = Environment.GetEnvironmentVariable("TENCENT_SECRET_ID");
    options.SecretKey = Environment.GetEnvironmentVariable("TENCENT_SECRET_KEY");
    options.SmsSdkAppId = Environment.GetEnvironmentVariable("TENCENT_SMS_SDK_APP_ID");
    options.Region = Environment.GetEnvironmentVariable("TENCENT_SMS_REGION") ?? "ap-beijing";
});
```

## 🧪 配置验证

### 快速验证配置

```csharp
[ApiController]
[Route("api/[controller]")]
public class ConfigTestController : ControllerBase
{
    private readonly ISmsService _smsService;
    private readonly ILogger<ConfigTestController> _logger;

    public ConfigTestController(ISmsService smsService, ILogger<ConfigTestController> logger)
    {
        _smsService = smsService;
        _logger = logger;
    }

    [HttpGet("validate-tencent-config")]
    public IActionResult ValidateTencentConfig()
    {
        try
        {
            var isTencentAvailable = _smsService.IsProviderAvailable(SmsProvider.Tencent);
            var isTencentAvailableByName = _smsService.IsProviderAvailable("Tencent");

            return Ok(new
            {
                success = true,
                tencentAvailable = isTencentAvailable,
                tencentAvailableByName = isTencentAvailableByName,
                availableProviders = _smsService.GetAvailableProviders()
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "腾讯云配置验证失败");
            return BadRequest(new { success = false, error = ex.Message });
        }
    }

    [HttpPost("test-tencent-sms")]
    public async Task<IActionResult> TestTencentSms([FromBody] TestSmsRequest request)
    {
        try
        {
            var smsRequest = new SmsRequest
            {
                PhoneNumber = request.PhoneNumber,
                TemplateId = request.TemplateId,
                SignName = request.SignName,
                TemplateParams = request.TemplateParams ?? new Dictionary<string, string>()
            };

            // 强制使用腾讯云提供商
            var response = await _smsService.SendSmsAsync(smsRequest, SmsProvider.Tencent);

            if (response.IsSuccess)
            {
                return Ok(new
                {
                    success = true,
                    provider = response.Provider,
                    requestId = response.RequestId,
                    bizId = response.BizId
                });
            }
            else
            {
                return BadRequest(new
                {
                    success = false,
                    error = response.FriendlyErrorMessage,
                    errorCode = response.StandardErrorCode.ToString(),
                    originalError = response.ErrorMessage,
                    isRetryable = response.IsRetryable
                });
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "腾讯云短信测试失败");
            return StatusCode(500, new { success = false, error = ex.Message });
        }
    }
}

public class TestSmsRequest
{
    public string PhoneNumber { get; set; }
    public string TemplateId { get; set; }
    public string SignName { get; set; }
    public Dictionary<string, string> TemplateParams { get; set; }
}
```

### 配置检查工具

```csharp
public static class TencentConfigChecker
{
    public static ConfigCheckResult CheckTencentConfiguration(TencentSmsOptions options)
    {
        var result = new ConfigCheckResult();

        // 检查必需参数
        if (string.IsNullOrEmpty(options.SecretId))
        {
            result.AddError("SecretId 未配置");
        }
        else if (!options.SecretId.StartsWith("AKID"))
        {
            result.AddWarning("SecretId 格式可能不正确，通常以 'AKID' 开头");
        }

        if (string.IsNullOrEmpty(options.SecretKey))
        {
            result.AddError("SecretKey 未配置");
        }

        if (string.IsNullOrEmpty(options.SmsSdkAppId))
        {
            result.AddError("SmsSdkAppId 未配置");
        }
        else if (!int.TryParse(options.SmsSdkAppId, out var appId) || appId <= 0)
        {
            result.AddError("SmsSdkAppId 格式不正确，应为正整数");
        }

        if (string.IsNullOrEmpty(options.Region))
        {
            result.AddWarning("Region 未配置，将使用默认值 'ap-beijing'");
        }

        return result;
    }
}

public class ConfigCheckResult
{
    public List<string> Errors { get; } = new();
    public List<string> Warnings { get; } = new();
    public bool IsValid => !Errors.Any();

    public void AddError(string error) => Errors.Add(error);
    public void AddWarning(string warning) => Warnings.Add(warning);
}
```

## 🔍 常见问题解答

### Q: 短信控制台的"SecretKey"和API密钥的"SecretKey"有什么区别？

**A**: 它们是完全不同的两个概念：
- **短信控制台的"SecretKey"** = 实际是AppKey，用于旧版SDK
- **API密钥的"SecretKey"** = 腾讯云账号级密钥，用于新版API和TC3签名

### Q: 为什么不能只用短信应用的密钥？

**A**: PolySms使用的是腾讯云新版API接口（SendSms），这个接口要求使用账号级的API密钥进行TC3-HMAC-SHA256签名认证，而不是应用级的AppKey。

### Q: 我已经有短信应用了，还需要创建API密钥吗？

**A**: 是的，需要。短信应用提供SmsSdkAppId，API密钥管理提供SecretId和SecretKey，两者缺一不可。

### Q: 一个腾讯云账号可以有多个API密钥吗？

**A**: 可以，主账号最多可以创建2个API密钥，建议为不同项目使用不同的密钥。

### Q: Region参数有什么作用？

**A**: Region指定API请求的地域，影响请求路由和网络延迟。选择离应用服务器最近的地域可以获得更好的性能。

### Q: PolySms相比腾讯云官方SDK有什么优势？

**A**: 主要优势包括：
1. **轻量级**：包体积减少99%以上（从50MB到20KB）
2. **高性能**：启动速度快，内存占用少
3. **零依赖**：无第三方依赖，避免依赖冲突
4. **统一接口**：支持多云提供商，一套代码多个平台
5. **标准化错误处理**：统一错误码和友好错误信息

## 🛡️ 安全最佳实践

### 1. 密钥管理

```bash
# 生产环境使用环境变量
export TENCENT_SECRET_ID="AKID1234567890abcdefg"
export TENCENT_SECRET_KEY="abcdefg1234567890AKID"

# 或使用密钥管理服务（如 Azure Key Vault, AWS Secrets Manager）
```

### 2. 权限最小化

为SMS服务创建专门的子账号，只授予短信相关权限：

1. 进入 **访问管理** → **用户** → **新建用户**
2. 选择 **自定义创建** → **可访问资源并接收消息**
3. 在权限设置中，只添加短信相关策略：
   - `QcloudSMSFullAccess` 或 `QcloudSMSReadOnlyAccess`

### 3. 网络安全

```csharp
// 在生产环境中，可以配置HTTP客户端的安全选项
builder.Services.Configure<TencentSmsOptions>(options =>
{
    options.Timeout = TimeSpan.FromSeconds(30);
    options.EnableHttps = true;  // 强制HTTPS
});
```

### 4. 日志安全

```csharp
// 配置日志时，避免记录敏感信息
builder.Logging.AddFilter("PolySms", LogLevel.Information);
```

## 🚀 性能优化建议

### 1. 连接池配置

```csharp
// PolySms 自动使用 HttpClient 连接池，无需额外配置
builder.Services.AddPolySms(builder.Configuration);
```

### 2. 异步最佳实践

```csharp
// 推荐的异步调用方式
public async Task<SmsResponse> SendVerificationCode(string phoneNumber, string code)
{
    var request = new SmsRequest
    {
        PhoneNumber = phoneNumber,
        TemplateId = "SMS_123456789",
        SignName = "您的应用",
        TemplateParams = new Dictionary<string, string> { { "code", code } }
    };

    // 使用 ConfigureAwait(false) 避免死锁
    return await _smsService.SendSmsAsync(request).ConfigureAwait(false);
}
```

### 3. 错误处理和重试

```csharp
public async Task<SmsResponse> SendSmsWithIntelligentRetry(SmsRequest request)
{
    var response = await _smsService.SendSmsAsync(request, SmsProvider.Tencent);

    // 智能重试逻辑
    var retryCount = 0;
    var maxRetries = 3;

    while (!response.IsSuccess && response.IsRetryable && retryCount < maxRetries)
    {
        var delay = response.StandardErrorCode switch
        {
            StandardErrorCode.RateLimitExceeded => TimeSpan.FromMinutes(1),
            StandardErrorCode.NetworkError => TimeSpan.FromSeconds(5),
            StandardErrorCode.ProviderInternalError => TimeSpan.FromSeconds(10),
            _ => TimeSpan.FromSeconds(3)
        };

        await Task.Delay(delay);
        retryCount++;

        response = await _smsService.SendSmsAsync(request, SmsProvider.Tencent);
    }

    return response;
}
```

## 🔗 相关链接

- [腾讯云API密钥管理](https://console.cloud.tencent.com/cam/capi)
- [短信应用管理](https://console.cloud.tencent.com/smsv2/app-manage)
- [腾讯云短信API文档](https://cloud.tencent.com/document/product/382/43194)
- [API签名方法v3（TC3）](https://cloud.tencent.com/document/api/382/52071)
- [腾讯云地域列表](https://cloud.tencent.com/document/api/382/52071#.E5.9C.B0.E5.9F.9F.E5.88.97.E8.A1.A8)

## 📊 配置对比

| 配置项 | 腾讯云官方SDK | PolySms |
|--------|-------------|---------|
| 包大小 | ~50MB | ~20KB |
| 依赖项 | 多个第三方包 | 零依赖 |
| 签名算法 | SDK内置 | 自研TC3实现 |
| 错误处理 | 原始错误码 | 标准化错误码 |
| 多云支持 | 单一提供商 | 多提供商统一接口 |
| 启动时间 | 较慢 | 极快 |
| 内存占用 | 较高 | 极低 |
| 配置复杂度 | 中等 | 简单 |

## 🎯 总结

PolySms提供了一个轻量级、高性能的腾讯云短信解决方案：

### 关键要点
1. **正确的密钥配置**：使用API密钥管理中的SecretId/SecretKey，而非短信控制台的AppKey
2. **必需的4个参数**：SecretId、SecretKey、SmsSdkAppId、Region
3. **安全最佳实践**：使用环境变量或密钥管理服务存储敏感信息
4. **轻量级架构**：HTTP直连，无需厚重的官方SDK

### 技术优势
- 📦 **超轻量**：包体积减少99.96%
- ⚡ **高性能**：启动快，内存占用少
- 🛡️ **更安全**：自研签名算法，无第三方依赖风险
- 🔄 **标准化**：统一错误码系统，智能重试机制

如果您在配置过程中遇到问题，请参考项目的其他文档或提交Issue。PolySms让腾讯云短信集成变得简单高效！