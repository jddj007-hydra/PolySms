# PolySms 自定义配置文件使用指南

## 概述

PolySms 提供了灵活的自定义配置文件支持，让您可以独立管理短信服务配置。这种方式特别适合生产环境和企业应用，提供了更好的安全性和配置管理灵活性。相比传统SDK方案，PolySms采用轻量级架构，配置更简单，性能更优。

## 快速开始

### 1. 创建配置文件

在项目根目录下创建 `config/sms.json` 文件：

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

### 2. 配置服务

在 `Program.cs` 中使用自定义配置文件：

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// 从自定义配置文件加载PolySms服务
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

var app = builder.Build();
```

### 3. 使用服务

```csharp
[ApiController]
[Route("api/[controller]")]
public class SmsController : ControllerBase
{
    private readonly ISmsService _smsService;

    public SmsController(ISmsService smsService)
    {
        _smsService = smsService;
    }

    [HttpPost("send")]
    public async Task<IActionResult> SendSms([FromBody] SendSmsRequest request)
    {
        var smsRequest = new SmsRequest
        {
            PhoneNumber = request.PhoneNumber,
            TemplateId = request.TemplateId,
            SignName = request.SignName,
            TemplateParams = request.TemplateParams
        };

        // 使用配置文件中的默认提供商
        var response = await _smsService.SendSmsAsync(smsRequest);

        return response.IsSuccess
            ? Ok(new { success = true, provider = response.Provider })
            : BadRequest(new { success = false, error = response.ErrorMessage });
    }
}
```

## 高级配置

### 环境特定配置

为不同环境创建不同的配置文件：

```
config/
├── sms.json                 # 默认配置
├── sms.development.json     # 开发环境
├── sms.staging.json         # 测试环境
├── sms.production.json      # 生产环境
└── sms.local.json          # 本地开发（gitignore）
```

**动态加载环境配置**：

```csharp
var environment = builder.Environment.EnvironmentName.ToLower();
var configFile = $"config/sms.{environment}.json";

// 如果环境特定配置不存在，则使用默认配置
if (!File.Exists(configFile))
{
    configFile = "config/sms.json";
}

builder.Services.AddPolySmsFromConfigFile(configFile);
```

### 分离式配置

为每个提供商创建独立的配置文件：

```
config/
├── sms.json           # 核心SMS配置
├── aliyun.json        # 阿里云配置
└── tencent.json       # 腾讯云配置
```

**config/sms.json**：
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  }
}
```

**config/aliyun.json**：
```json
{
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

**config/tencent.json**：
```json
{
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

**服务注册**：
```csharp
// PolySms 支持统一的配置文件管理，自动整合多个配置文件
var builder = WebApplication.CreateBuilder(args);

// 方法1: 统一配置文件（推荐）
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

// 方法2: 多配置文件方式
builder.Configuration.AddJsonFile("config/sms.json", optional: false, reloadOnChange: true)
                     .AddJsonFile("config/aliyun.json", optional: false, reloadOnChange: true)
                     .AddJsonFile("config/tencent.json", optional: false, reloadOnChange: true);

builder.Services.AddPolySms(builder.Configuration);
```

## 安全最佳实践

### 1. 文件权限控制

```bash
# Linux/macOS 设置文件权限
chmod 600 config/sms.json           # 只有所有者可读写
chown app-user:app-group config/sms.json  # 设置文件所有者
```

### 2. 版本控制排除

**.gitignore**：
```gitignore
# SMS配置文件
config/sms.local.json
config/sms.production.json
config/**/secrets.json

# 或者排除所有敏感配置
config/sms*.json
!config/sms.template.json  # 保留模板文件
```

### 3. 配置模板文件

创建 `config/sms.template.json` 作为配置模板：

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "REPLACE_WITH_ALIYUN_ACCESS_KEY_ID",
    "AccessKeySecret": "REPLACE_WITH_ALIYUN_ACCESS_KEY_SECRET",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "REPLACE_WITH_TENCENT_SECRET_ID",
    "SecretKey": "REPLACE_WITH_TENCENT_SECRET_KEY",
    "Region": "ap-beijing",
    "SmsSdkAppId": "REPLACE_WITH_SMS_SDK_APP_ID"
  }
}
```

### 4. 环境变量结合使用

```json
{
  "Sms": {
    "DefaultProvider": "${SMS_DEFAULT_PROVIDER:Aliyun}",
    "EnableFailover": "${SMS_ENABLE_FAILOVER:true}"
  },
  "AliyunSms": {
    "AccessKeyId": "${ALIYUN_ACCESS_KEY_ID}",
    "AccessKeySecret": "${ALIYUN_ACCESS_KEY_SECRET}"
  },
  "TencentSms": {
    "SecretId": "${TENCENT_SECRET_ID}",
    "SecretKey": "${TENCENT_SECRET_KEY}",
    "SmsSdkAppId": "${TENCENT_SMS_SDK_APP_ID}"
  }
}
```

## 配置验证

### 启动时验证配置

```csharp
using PolySms.Interfaces;
using PolySms.Options;

public static class ConfigurationValidator
{
    public static async Task ValidateSmsConfiguration(IServiceProvider services)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        var smsService = services.GetRequiredService<ISmsService>();
        var smsOptions = services.GetRequiredService<IOptions<SmsOptions>>();
        var aliyunOptions = services.GetRequiredService<IOptions<AliyunSmsOptions>>();
        var tencentOptions = services.GetRequiredService<IOptions<TencentSmsOptions>>();

        try
        {
            logger.LogInformation("开始验证PolySms配置...");

            // 验证基本配置
            var config = smsOptions.Value;
            logger.LogInformation("默认提供商: {DefaultProvider}", config.DefaultProvider);
            logger.LogInformation("故障转移: {EnableFailover}", config.EnableFailover);
            logger.LogInformation("提供商优先级: {Priority}",
                string.Join(", ", config.ProviderPriority));

            // 验证阿里云配置
            if (!string.IsNullOrEmpty(aliyunOptions.Value.AccessKeyId))
            {
                logger.LogInformation("阿里云短信配置: ✅ 已配置");
            }
            else
            {
                logger.LogWarning("阿里云短信配置: ❌ 未配置或不完整");
            }

            // 验证腾讯云配置
            if (!string.IsNullOrEmpty(tencentOptions.Value.SecretId))
            {
                logger.LogInformation("腾讯云短信配置: ✅ 已配置");
            }
            else
            {
                logger.LogWarning("腾讯云短信配置: ❌ 未配置或不完整");
            }

            logger.LogInformation("PolySms配置验证完成");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "PolySms配置验证失败");
        }
    }
}

// 在Program.cs中使用
var app = builder.Build();

// 验证配置
using (var scope = app.Services.CreateScope())
{
    ConfigurationValidator.ValidateSmsConfiguration(scope.ServiceProvider);
}

app.Run();
```

## 配置文件监听和热重载

```csharp
// 启用配置文件监听和热重载
builder.Configuration.AddJsonFile("config/sms.json",
    optional: false,
    reloadOnChange: true);  // 文件变更时自动重新加载

builder.Services.AddPolySms(builder.Configuration);

// 或者直接使用文件配置方式
builder.Services.AddPolySmsFromConfigFile("config/sms.json");
```

## Docker 部署配置

### Dockerfile

```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0

# 创建配置目录
RUN mkdir -p /app/config

# 复制应用文件
COPY . /app
WORKDIR /app

# 设置配置文件权限
RUN chmod 600 /app/config/sms.json

EXPOSE 80
ENTRYPOINT ["dotnet", "YourApp.dll"]
```

### Docker Compose

```yaml
version: '3.8'
services:
  yourapp:
    build: .
    volumes:
      # 将宿主机的配置文件挂载到容器
      - ./config/sms.production.json:/app/config/sms.json:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
    ports:
      - "8080:80"
```

## 故障排除

### 常见问题

1. **配置文件未找到**
   ```
   错误: Unable to find config file 'config/sms.json'
   解决: 确保文件路径正确，或设置 optional: true
   ```

2. **配置格式错误**
   ```
   错误: JSON format error in config file
   解决: 使用JSON验证工具检查文件格式
   ```

3. **权限不足**
   ```
   错误: Access denied to config file
   解决: 检查文件权限设置
   ```

### 调试配置加载

```csharp
using PolySms.Extensions;
using PolySms.Options;

builder.Services.AddPolySmsFromConfigFile("config/sms.json");

// 添加配置调试输出
builder.Services.PostConfigure<SmsOptions>(options =>
{
    var logger = LoggerFactory.Create(b => b.AddConsole()).CreateLogger<Program>();

    logger.LogInformation("PolySms配置加载完成:");
    logger.LogInformation("- 默认提供商: {DefaultProvider}", options.DefaultProvider);
    logger.LogInformation("- 故障转移: {EnableFailover}", options.EnableFailover);
    logger.LogInformation("- 提供商优先级: {Priority}",
        string.Join(", ", options.ProviderPriority));
});

// 验证阿里云配置
builder.Services.PostConfigure<AliyunSmsOptions>(options =>
{
    var logger = LoggerFactory.Create(b => b.AddConsole()).CreateLogger<Program>();

    if (!string.IsNullOrEmpty(options.AccessKeyId))
    {
        logger.LogInformation("阿里云配置: AccessKeyId = {KeyId}***",
            options.AccessKeyId[..Math.Min(8, options.AccessKeyId.Length)]);
    }
});

// 验证腾讯云配置
builder.Services.PostConfigure<TencentSmsOptions>(options =>
{
    var logger = LoggerFactory.Create(b => b.AddConsole()).CreateLogger<Program>();

    if (!string.IsNullOrEmpty(options.SecretId))
    {
        logger.LogInformation("腾讯云配置: SecretId = {SecretId}***, Region = {Region}, SmsSdkAppId = {AppId}",
            options.SecretId[..Math.Min(8, options.SecretId.Length)],
            options.Region,
            options.SmsSdkAppId);
    }
});
```

## 总结

使用自定义配置文件的优势：

1. **🔒 更好的安全性** - 独立的配置文件便于权限管理
2. **📁 清晰的组织结构** - 配置文件分离，职责明确
3. **🌍 灵活的环境管理** - 不同环境使用不同配置文件
4. **🔧 便于维护** - 配置变更不影响主应用配置
5. **🚀 热重载支持** - 配置变更可以动态生效

推荐在生产环境和企业应用中使用自定义配置文件方式来管理PolySms配置。

## ⚡ PolySms 相比传统SDK的优势

使用PolySms自定义配置文件的额外优势：

### 📦 轻量级架构
- **零第三方SDK依赖**：无需阿里云和腾讯云的厚重SDK包
- **包体积极小**：从传统的50MB减少到约20KB（99.96%减少）
- **配置更简单**：统一的配置格式，无需分别配置多个SDK

### 🚀 性能优势
- **启动更快**：无需加载大型SDK程序集
- **内存占用更少**：HTTP直接调用，减少80%内存开销
- **部署体积更小**：Docker镜像和部署包大幅减小

### 🔧 技术实现
- **HTTP直接调用**：绕过SDK，直接调用云服务API
- **自研签名算法**：内置阿里云RPC和腾讯云TC3-HMAC-SHA256签名
- **统一抽象接口**：为不同云厂商提供一致的使用体验

### 🔄 无缝迁移
从PolySms迁移到PolySms，配置文件格式完全兼容，无需修改现有配置文件！