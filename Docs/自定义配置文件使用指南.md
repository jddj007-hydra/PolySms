# PolySms è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

PolySms æä¾›äº†çµæ´»çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ”¯æŒï¼Œè®©æ‚¨å¯ä»¥ç‹¬ç«‹ç®¡ç†çŸ­ä¿¡æœåŠ¡é…ç½®ã€‚è¿™ç§æ–¹å¼ç‰¹åˆ«é€‚åˆç”Ÿäº§ç¯å¢ƒå’Œä¼ä¸šåº”ç”¨ï¼Œæä¾›äº†æ›´å¥½çš„å®‰å…¨æ€§å’Œé…ç½®ç®¡ç†çµæ´»æ€§ã€‚ç›¸æ¯”ä¼ ç»ŸSDKæ–¹æ¡ˆï¼ŒPolySmsé‡‡ç”¨è½»é‡çº§æ¶æ„ï¼Œé…ç½®æ›´ç®€å•ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `config/sms.json` æ–‡ä»¶ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

### 2. é…ç½®æœåŠ¡

åœ¨ `Program.cs` ä¸­ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼š

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ä»è‡ªå®šä¹‰é…ç½®æ–‡ä»¶åŠ è½½PolySmsæœåŠ¡
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

var app = builder.Build();
```

### 3. ä½¿ç”¨æœåŠ¡

```csharp
[ApiController]
[Route("api/[controller]")]
public class SmsController : ControllerBase
{
    private readonly ISmsService _smsService;

    public SmsController(ISmsService smsService)
    {
        _smsService = smsService;
    }

    [HttpPost("send")]
    public async Task<IActionResult> SendSms([FromBody] SendSmsRequest request)
    {
        var smsRequest = new SmsRequest
        {
            PhoneNumber = request.PhoneNumber,
            TemplateId = request.TemplateId,
            SignName = request.SignName,
            TemplateParams = request.TemplateParams
        };

        // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤æä¾›å•†
        var response = await _smsService.SendSmsAsync(smsRequest);

        return response.IsSuccess
            ? Ok(new { success = true, provider = response.Provider })
            : BadRequest(new { success = false, error = response.ErrorMessage });
    }
}
```

## é«˜çº§é…ç½®

### ç¯å¢ƒç‰¹å®šé…ç½®

ä¸ºä¸åŒç¯å¢ƒåˆ›å»ºä¸åŒçš„é…ç½®æ–‡ä»¶ï¼š

```
config/
â”œâ”€â”€ sms.json                 # é»˜è®¤é…ç½®
â”œâ”€â”€ sms.development.json     # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ sms.staging.json         # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ sms.production.json      # ç”Ÿäº§ç¯å¢ƒ
â””â”€â”€ sms.local.json          # æœ¬åœ°å¼€å‘ï¼ˆgitignoreï¼‰
```

**åŠ¨æ€åŠ è½½ç¯å¢ƒé…ç½®**ï¼š

```csharp
var environment = builder.Environment.EnvironmentName.ToLower();
var configFile = $"config/sms.{environment}.json";

// å¦‚æœç¯å¢ƒç‰¹å®šé…ç½®ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨é»˜è®¤é…ç½®
if (!File.Exists(configFile))
{
    configFile = "config/sms.json";
}

builder.Services.AddPolySmsFromConfigFile(configFile);
```

### åˆ†ç¦»å¼é…ç½®

ä¸ºæ¯ä¸ªæä¾›å•†åˆ›å»ºç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼š

```
config/
â”œâ”€â”€ sms.json           # æ ¸å¿ƒSMSé…ç½®
â”œâ”€â”€ aliyun.json        # é˜¿é‡Œäº‘é…ç½®
â””â”€â”€ tencent.json       # è…¾è®¯äº‘é…ç½®
```

**config/sms.json**ï¼š
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  }
}
```

**config/aliyun.json**ï¼š
```json
{
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

**config/tencent.json**ï¼š
```json
{
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

**æœåŠ¡æ³¨å†Œ**ï¼š
```csharp
// PolySms æ”¯æŒç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œè‡ªåŠ¨æ•´åˆå¤šä¸ªé…ç½®æ–‡ä»¶
var builder = WebApplication.CreateBuilder(args);

// æ–¹æ³•1: ç»Ÿä¸€é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

// æ–¹æ³•2: å¤šé…ç½®æ–‡ä»¶æ–¹å¼
builder.Configuration.AddJsonFile("config/sms.json", optional: false, reloadOnChange: true)
                     .AddJsonFile("config/aliyun.json", optional: false, reloadOnChange: true)
                     .AddJsonFile("config/tencent.json", optional: false, reloadOnChange: true);

builder.Services.AddPolySms(builder.Configuration);
```

## å®‰å…¨æœ€ä½³å®è·µ

### 1. æ–‡ä»¶æƒé™æ§åˆ¶

```bash
# Linux/macOS è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 config/sms.json           # åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chown app-user:app-group config/sms.json  # è®¾ç½®æ–‡ä»¶æ‰€æœ‰è€…
```

### 2. ç‰ˆæœ¬æ§åˆ¶æ’é™¤

**.gitignore**ï¼š
```gitignore
# SMSé…ç½®æ–‡ä»¶
config/sms.local.json
config/sms.production.json
config/**/secrets.json

# æˆ–è€…æ’é™¤æ‰€æœ‰æ•æ„Ÿé…ç½®
config/sms*.json
!config/sms.template.json  # ä¿ç•™æ¨¡æ¿æ–‡ä»¶
```

### 3. é…ç½®æ¨¡æ¿æ–‡ä»¶

åˆ›å»º `config/sms.template.json` ä½œä¸ºé…ç½®æ¨¡æ¿ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "REPLACE_WITH_ALIYUN_ACCESS_KEY_ID",
    "AccessKeySecret": "REPLACE_WITH_ALIYUN_ACCESS_KEY_SECRET",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "REPLACE_WITH_TENCENT_SECRET_ID",
    "SecretKey": "REPLACE_WITH_TENCENT_SECRET_KEY",
    "Region": "ap-beijing",
    "SmsSdkAppId": "REPLACE_WITH_SMS_SDK_APP_ID"
  }
}
```

### 4. ç¯å¢ƒå˜é‡ç»“åˆä½¿ç”¨

```json
{
  "Sms": {
    "DefaultProvider": "${SMS_DEFAULT_PROVIDER:Aliyun}",
    "EnableFailover": "${SMS_ENABLE_FAILOVER:true}"
  },
  "AliyunSms": {
    "AccessKeyId": "${ALIYUN_ACCESS_KEY_ID}",
    "AccessKeySecret": "${ALIYUN_ACCESS_KEY_SECRET}"
  },
  "TencentSms": {
    "SecretId": "${TENCENT_SECRET_ID}",
    "SecretKey": "${TENCENT_SECRET_KEY}",
    "SmsSdkAppId": "${TENCENT_SMS_SDK_APP_ID}"
  }
}
```

## é…ç½®éªŒè¯

### å¯åŠ¨æ—¶éªŒè¯é…ç½®

```csharp
using PolySms.Interfaces;
using PolySms.Options;

public static class ConfigurationValidator
{
    public static async Task ValidateSmsConfiguration(IServiceProvider services)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        var smsService = services.GetRequiredService<ISmsService>();
        var smsOptions = services.GetRequiredService<IOptions<SmsOptions>>();
        var aliyunOptions = services.GetRequiredService<IOptions<AliyunSmsOptions>>();
        var tencentOptions = services.GetRequiredService<IOptions<TencentSmsOptions>>();

        try
        {
            logger.LogInformation("å¼€å§‹éªŒè¯PolySmsé…ç½®...");

            // éªŒè¯åŸºæœ¬é…ç½®
            var config = smsOptions.Value;
            logger.LogInformation("é»˜è®¤æä¾›å•†: {DefaultProvider}", config.DefaultProvider);
            logger.LogInformation("æ•…éšœè½¬ç§»: {EnableFailover}", config.EnableFailover);
            logger.LogInformation("æä¾›å•†ä¼˜å…ˆçº§: {Priority}",
                string.Join(", ", config.ProviderPriority));

            // éªŒè¯é˜¿é‡Œäº‘é…ç½®
            if (!string.IsNullOrEmpty(aliyunOptions.Value.AccessKeyId))
            {
                logger.LogInformation("é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®: âœ… å·²é…ç½®");
            }
            else
            {
                logger.LogWarning("é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®: âŒ æœªé…ç½®æˆ–ä¸å®Œæ•´");
            }

            // éªŒè¯è…¾è®¯äº‘é…ç½®
            if (!string.IsNullOrEmpty(tencentOptions.Value.SecretId))
            {
                logger.LogInformation("è…¾è®¯äº‘çŸ­ä¿¡é…ç½®: âœ… å·²é…ç½®");
            }
            else
            {
                logger.LogWarning("è…¾è®¯äº‘çŸ­ä¿¡é…ç½®: âŒ æœªé…ç½®æˆ–ä¸å®Œæ•´");
            }

            logger.LogInformation("PolySmsé…ç½®éªŒè¯å®Œæˆ");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "PolySmsé…ç½®éªŒè¯å¤±è´¥");
        }
    }
}

// åœ¨Program.csä¸­ä½¿ç”¨
var app = builder.Build();

// éªŒè¯é…ç½®
using (var scope = app.Services.CreateScope())
{
    ConfigurationValidator.ValidateSmsConfiguration(scope.ServiceProvider);
}

app.Run();
```

## é…ç½®æ–‡ä»¶ç›‘å¬å’Œçƒ­é‡è½½

```csharp
// å¯ç”¨é…ç½®æ–‡ä»¶ç›‘å¬å’Œçƒ­é‡è½½
builder.Configuration.AddJsonFile("config/sms.json",
    optional: false,
    reloadOnChange: true);  // æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½

builder.Services.AddPolySms(builder.Configuration);

// æˆ–è€…ç›´æ¥ä½¿ç”¨æ–‡ä»¶é…ç½®æ–¹å¼
builder.Services.AddPolySmsFromConfigFile("config/sms.json");
```

## Docker éƒ¨ç½²é…ç½®

### Dockerfile

```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0

# åˆ›å»ºé…ç½®ç›®å½•
RUN mkdir -p /app/config

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY . /app
WORKDIR /app

# è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
RUN chmod 600 /app/config/sms.json

EXPOSE 80
ENTRYPOINT ["dotnet", "YourApp.dll"]
```

### Docker Compose

```yaml
version: '3.8'
services:
  yourapp:
    build: .
    volumes:
      # å°†å®¿ä¸»æœºçš„é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨
      - ./config/sms.production.json:/app/config/sms.json:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
    ports:
      - "8080:80"
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°**
   ```
   é”™è¯¯: Unable to find config file 'config/sms.json'
   è§£å†³: ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®ï¼Œæˆ–è®¾ç½® optional: true
   ```

2. **é…ç½®æ ¼å¼é”™è¯¯**
   ```
   é”™è¯¯: JSON format error in config file
   è§£å†³: ä½¿ç”¨JSONéªŒè¯å·¥å…·æ£€æŸ¥æ–‡ä»¶æ ¼å¼
   ```

3. **æƒé™ä¸è¶³**
   ```
   é”™è¯¯: Access denied to config file
   è§£å†³: æ£€æŸ¥æ–‡ä»¶æƒé™è®¾ç½®
   ```

### è°ƒè¯•é…ç½®åŠ è½½

```csharp
using PolySms.Extensions;
using PolySms.Options;

builder.Services.AddPolySmsFromConfigFile("config/sms.json");

// æ·»åŠ é…ç½®è°ƒè¯•è¾“å‡º
builder.Services.PostConfigure<SmsOptions>(options =>
{
    var logger = LoggerFactory.Create(b => b.AddConsole()).CreateLogger<Program>();

    logger.LogInformation("PolySmsé…ç½®åŠ è½½å®Œæˆ:");
    logger.LogInformation("- é»˜è®¤æä¾›å•†: {DefaultProvider}", options.DefaultProvider);
    logger.LogInformation("- æ•…éšœè½¬ç§»: {EnableFailover}", options.EnableFailover);
    logger.LogInformation("- æä¾›å•†ä¼˜å…ˆçº§: {Priority}",
        string.Join(", ", options.ProviderPriority));
});

// éªŒè¯é˜¿é‡Œäº‘é…ç½®
builder.Services.PostConfigure<AliyunSmsOptions>(options =>
{
    var logger = LoggerFactory.Create(b => b.AddConsole()).CreateLogger<Program>();

    if (!string.IsNullOrEmpty(options.AccessKeyId))
    {
        logger.LogInformation("é˜¿é‡Œäº‘é…ç½®: AccessKeyId = {KeyId}***",
            options.AccessKeyId[..Math.Min(8, options.AccessKeyId.Length)]);
    }
});

// éªŒè¯è…¾è®¯äº‘é…ç½®
builder.Services.PostConfigure<TencentSmsOptions>(options =>
{
    var logger = LoggerFactory.Create(b => b.AddConsole()).CreateLogger<Program>();

    if (!string.IsNullOrEmpty(options.SecretId))
    {
        logger.LogInformation("è…¾è®¯äº‘é…ç½®: SecretId = {SecretId}***, Region = {Region}, SmsSdkAppId = {AppId}",
            options.SecretId[..Math.Min(8, options.SecretId.Length)],
            options.Region,
            options.SmsSdkAppId);
    }
});
```

## æ€»ç»“

ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶çš„ä¼˜åŠ¿ï¼š

1. **ğŸ”’ æ›´å¥½çš„å®‰å…¨æ€§** - ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ä¾¿äºæƒé™ç®¡ç†
2. **ğŸ“ æ¸…æ™°çš„ç»„ç»‡ç»“æ„** - é…ç½®æ–‡ä»¶åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®
3. **ğŸŒ çµæ´»çš„ç¯å¢ƒç®¡ç†** - ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®æ–‡ä»¶
4. **ğŸ”§ ä¾¿äºç»´æŠ¤** - é…ç½®å˜æ›´ä¸å½±å“ä¸»åº”ç”¨é…ç½®
5. **ğŸš€ çƒ­é‡è½½æ”¯æŒ** - é…ç½®å˜æ›´å¯ä»¥åŠ¨æ€ç”Ÿæ•ˆ

æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒå’Œä¼ä¸šåº”ç”¨ä¸­ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ–¹å¼æ¥ç®¡ç†PolySmsé…ç½®ã€‚

## âš¡ PolySms ç›¸æ¯”ä¼ ç»ŸSDKçš„ä¼˜åŠ¿

ä½¿ç”¨PolySmsè‡ªå®šä¹‰é…ç½®æ–‡ä»¶çš„é¢å¤–ä¼˜åŠ¿ï¼š

### ğŸ“¦ è½»é‡çº§æ¶æ„
- **é›¶ç¬¬ä¸‰æ–¹SDKä¾èµ–**ï¼šæ— éœ€é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘çš„åšé‡SDKåŒ…
- **åŒ…ä½“ç§¯æå°**ï¼šä»ä¼ ç»Ÿçš„50MBå‡å°‘åˆ°çº¦20KBï¼ˆ99.96%å‡å°‘ï¼‰
- **é…ç½®æ›´ç®€å•**ï¼šç»Ÿä¸€çš„é…ç½®æ ¼å¼ï¼Œæ— éœ€åˆ†åˆ«é…ç½®å¤šä¸ªSDK

### ğŸš€ æ€§èƒ½ä¼˜åŠ¿
- **å¯åŠ¨æ›´å¿«**ï¼šæ— éœ€åŠ è½½å¤§å‹SDKç¨‹åºé›†
- **å†…å­˜å ç”¨æ›´å°‘**ï¼šHTTPç›´æ¥è°ƒç”¨ï¼Œå‡å°‘80%å†…å­˜å¼€é”€
- **éƒ¨ç½²ä½“ç§¯æ›´å°**ï¼šDockeré•œåƒå’Œéƒ¨ç½²åŒ…å¤§å¹…å‡å°

### ğŸ”§ æŠ€æœ¯å®ç°
- **HTTPç›´æ¥è°ƒç”¨**ï¼šç»•è¿‡SDKï¼Œç›´æ¥è°ƒç”¨äº‘æœåŠ¡API
- **è‡ªç ”ç­¾åç®—æ³•**ï¼šå†…ç½®é˜¿é‡Œäº‘RPCå’Œè…¾è®¯äº‘TC3-HMAC-SHA256ç­¾å
- **ç»Ÿä¸€æŠ½è±¡æ¥å£**ï¼šä¸ºä¸åŒäº‘å‚å•†æä¾›ä¸€è‡´çš„ä½¿ç”¨ä½“éªŒ

### ğŸ”„ æ— ç¼è¿ç§»
ä»PolySmsè¿ç§»åˆ°PolySmsï¼Œé…ç½®æ–‡ä»¶æ ¼å¼å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰é…ç½®æ–‡ä»¶ï¼