# PolySms æ¶æ„è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

PolySmsé‡‡ç”¨**è½»é‡çº§HTTPç›´è¿æ¶æ„**ï¼Œæ”¾å¼ƒä¼ ç»Ÿçš„åšé‡SDKä¾èµ–ï¼Œé€šè¿‡è‡ªç ”HTTPç­¾åç®—æ³•ç›´æ¥è°ƒç”¨äº‘æœåŠ¡APIã€‚è¿™ç§æ¶æ„å¤§å¹…å‡å°‘åŒ…ä½“ç§¯ï¼ˆ99.96%ï¼‰ï¼Œæ˜¾è‘—æå‡å¯åŠ¨æ€§èƒ½ï¼ŒåŒæ—¶ä¿æŒå®Œæ•´çš„åŠŸèƒ½æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå¹¶é›†æˆäº†å…ˆè¿›çš„æ ‡å‡†åŒ–é”™è¯¯å¤„ç†ç³»ç»Ÿã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ–°æ¶æ„å¯¹æ¯”

```
ä¼ ç»ŸSDKæ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Core Layer                           â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚   SmsService    â”‚                        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Provider Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ AliyunProvider  â”‚         â”‚ TencentProvider â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              External SDK Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  AlibabaCloud   â”‚         â”‚  TencentCloud   â”‚        â”‚
â”‚  â”‚   SDK (~20MB)   â”‚         â”‚   SDK (~30MB)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Cloud APIs                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Aliyun SMS    â”‚         â”‚  Tencent SMS    â”‚        â”‚
â”‚  â”‚      API        â”‚         â”‚      API        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PolySmsæ¶æ„ (New):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Core Layer                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚   SmsService    â”‚  â”‚ ErrorCodeMapper â”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HTTP Provider Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ AliyunProvider  â”‚         â”‚ TencentProvider â”‚        â”‚
â”‚  â”‚ + RPC Signature â”‚         â”‚ + TC3 Signature â”‚        â”‚
â”‚  â”‚ + Error Mapping â”‚         â”‚ + Error Mapping â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HTTP Client Layer                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚  HttpSmsClient  â”‚                        â”‚
â”‚              â”‚   (.NETå†…ç½®)     â”‚                        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Cloud APIs                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Aliyun SMS    â”‚         â”‚  Tencent SMS    â”‚        â”‚
â”‚  â”‚      API        â”‚         â”‚      API        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ä¼˜åŠ¿

| å¯¹æ¯”é¡¹ | ä¼ ç»ŸSDKæ¶æ„ | PolySms HTTPæ¶æ„ | ä¼˜åŠ¿ |
|--------|-------------|------------------|------|
| **å±‚çº§å¤æ‚åº¦** | 5å±‚ | 4å±‚ | å‡å°‘1å±‚æŠ½è±¡ |
| **å¤–éƒ¨ä¾èµ–** | 2ä¸ªå¤§å‹SDK | 0ä¸ª | é›¶ä¾èµ– |
| **åŒ…ä½“ç§¯** | ~50MB | ~20KB | **99.96%å‡å°‘** |
| **å¯åŠ¨æ—¶é—´** | 2-3ç§’ | 0.2-0.3ç§’ | **90%å‡å°‘** |
| **è°ƒç”¨é“¾è·¯** | Appâ†’Coreâ†’Providerâ†’SDKâ†’API | Appâ†’Coreâ†’Providerâ†’HTTPâ†’API | **æ›´ç›´æ¥** |
| **é”™è¯¯å¤„ç†** | å„å®¶ç‹¬ç«‹ | ç»Ÿä¸€æ ‡å‡†åŒ– | **ä½“éªŒä¸€è‡´** |

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. HTTPç›´è¿å±‚ (HTTP Direct Layer)

```csharp
namespace PolySms.Providers.Http;

// HTTPå®¢æˆ·ç«¯æŠ½è±¡
public interface IHttpSmsClient
{
    Task<HttpResponseMessage> PostAsync(
        string url,
        Dictionary<string, string> headers,
        string content,
        CancellationToken cancellationToken = default);
}

// HTTPå®¢æˆ·ç«¯å®ç°
public class HttpSmsClient : IHttpSmsClient
{
    private readonly HttpClient _httpClient;
    private readonly ILogger<HttpSmsClient> _logger;

    // ä½¿ç”¨.NETå†…ç½®HttpClientï¼Œé›¶å¤–éƒ¨ä¾èµ–
    // ç»Ÿä¸€è¶…æ—¶ã€é‡è¯•ã€æ—¥å¿—è®°å½•
}
```

### 2. ç­¾åç®—æ³•å±‚ (Signature Layer)

#### é˜¿é‡Œäº‘RPCç­¾åç®—æ³•
```csharp
namespace PolySms.Providers.Aliyun;

public static class AliyunSignatureHelper
{
    // å®ç°é˜¿é‡Œäº‘RPC Signature V1.0
    // - å‚æ•°æ’åºå’ŒURLç¼–ç 
    // - HMAC-SHA1ç­¾åè®¡ç®—
    // - å®Œæ•´è¯·æ±‚URLæ„å»º

    public static (string Url, Dictionary<string, string> Headers) BuildRequest(
        string endpoint,
        string accessKeyId,
        string accessKeySecret,
        Dictionary<string, string> parameters)
    {
        // 1. æ·»åŠ å…¬å…±å‚æ•°
        // 2. å‚æ•°æ’åºå’Œç¼–ç 
        // 3. æ„é€ ç­¾åå­—ç¬¦ä¸²
        // 4. HMAC-SHA1è®¡ç®—ç­¾å
        // 5. æ„é€ æœ€ç»ˆURL
    }
}
```

#### è…¾è®¯äº‘TC3ç­¾åç®—æ³•
```csharp
namespace PolySms.Providers.Tencent;

public static class TencentSignatureHelper
{
    // å®ç°è…¾è®¯äº‘TC3-HMAC-SHA256ç­¾åç®—æ³•
    // - Canonical Requestæ„å»º
    // - String to Signç”Ÿæˆ
    // - ç­¾åè®¡ç®—å’ŒAuthorization headeræ„å»º

    public static (string Url, Dictionary<string, string> Headers, string Body) BuildRequest(
        string region,
        string secretId,
        string secretKey,
        object requestData)
    {
        // 1. æ„å»ºCanonical Request
        // 2. åˆ›å»ºString to Sign
        // 3. è®¡ç®—ç­¾å
        // 4. æ„å»ºAuthorization header
    }
}
```

### 3. æ ‡å‡†åŒ–é”™è¯¯å¤„ç†å±‚ (Error Handling Layer)

```csharp
namespace PolySms.Helpers;

/// <summary>
/// é”™è¯¯ä»£ç æ˜ å°„å™¨ï¼Œå°†äº‘æœåŠ¡å•†ç‰¹æœ‰çš„é”™è¯¯ç è½¬æ¢ä¸ºç»Ÿä¸€çš„é”™è¯¯ç 
/// </summary>
public static class ErrorCodeMapper
{
    /// <summary>
    /// é˜¿é‡Œäº‘é”™è¯¯ç æ˜ å°„
    /// </summary>
    private static readonly Dictionary<string, StandardErrorCode> AliyunErrorMapping = new()
    {
        ["OK"] = StandardErrorCode.Success,
        ["InvalidParameter"] = StandardErrorCode.InvalidParameter,
        ["SignatureDoesNotMatch"] = StandardErrorCode.AuthenticationFailed,
        ["InsufficientBalance"] = StandardErrorCode.InsufficientBalance,
        ["Throttling.User"] = StandardErrorCode.RateLimitExceeded,
        ["InvalidTemplateCode.MalFormed"] = StandardErrorCode.TemplateNotFound,
        ["InvalidSignName.MalFormed"] = StandardErrorCode.SignatureNotFound,
        ["InvalidRecNum.MalFormed"] = StandardErrorCode.InvalidPhoneNumber,
        // ... æ›´å¤šæ˜ å°„
    };

    /// <summary>
    /// è…¾è®¯äº‘é”™è¯¯ç æ˜ å°„
    /// </summary>
    private static readonly Dictionary<string, StandardErrorCode> TencentErrorMapping = new()
    {
        ["Ok"] = StandardErrorCode.Success,
        ["InvalidParameter"] = StandardErrorCode.InvalidParameter,
        ["AuthFailure.SignatureFailure"] = StandardErrorCode.AuthenticationFailed,
        ["RequestLimitExceeded"] = StandardErrorCode.RateLimitExceeded,
        ["InvalidParameterValue.TemplateIDInvalid"] = StandardErrorCode.TemplateNotFound,
        // ... æ›´å¤šæ˜ å°„
    };

    /// <summary>
    /// è·å–æ ‡å‡†é”™è¯¯ç å¯¹åº”çš„ç”¨æˆ·å‹å¥½æ¶ˆæ¯
    /// </summary>
    public static string GetErrorMessage(StandardErrorCode errorCode)
    {
        return errorCode switch
        {
            StandardErrorCode.Success => "å‘é€æˆåŠŸ",
            StandardErrorCode.InvalidParameter => "å‚æ•°é”™è¯¯",
            StandardErrorCode.AuthenticationFailed => "è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¿é—®å¯†é’¥",
            StandardErrorCode.InsufficientBalance => "è´¦æˆ·ä½™é¢ä¸è¶³",
            StandardErrorCode.RateLimitExceeded => "å‘é€é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•",
            StandardErrorCode.NetworkError => "ç½‘ç»œè¿æ¥é”™è¯¯",
            _ => "æœªçŸ¥é”™è¯¯"
        };
    }

    /// <summary>
    /// åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•
    /// </summary>
    public static bool IsRetryableError(StandardErrorCode errorCode)
    {
        return errorCode switch
        {
            StandardErrorCode.NetworkError => true,
            StandardErrorCode.ProviderInternalError => true,
            StandardErrorCode.RateLimitExceeded => true,
            _ => false
        };
    }
}
```

### 4. æä¾›å•†é€‚é…å±‚ (Provider Adapter Layer)

```csharp
namespace PolySms.Providers.Aliyun;

public class AliyunSmsProvider : ISmsProvider
{
    private readonly AliyunSmsOptions _options;
    private readonly IHttpSmsClient _httpClient;
    private readonly ILogger<AliyunSmsProvider> _logger;

    public async Task<SmsResponse> SendSmsAsync(SmsRequest request, CancellationToken cancellationToken)
    {
        try
        {
            // 1. å‚æ•°è½¬æ¢ï¼šç»Ÿä¸€æ¨¡å‹ â†’ é˜¿é‡Œäº‘APIå‚æ•°
            var parameters = MapToAliyunParameters(request);

            // 2. ç­¾åè®¡ç®—ï¼šè°ƒç”¨AliyunSignatureHelper
            var (url, headers) = AliyunSignatureHelper.BuildRequest(
                _options.Endpoint, _options.AccessKeyId, _options.AccessKeySecret, parameters);

            // 3. HTTPè°ƒç”¨ï¼šé€šè¿‡HttpSmsClientå‘é€è¯·æ±‚
            var httpResponse = await _httpClient.PostAsync(url, headers, string.Empty, cancellationToken);

            // 4. å“åº”è§£æ
            var responseContent = await httpResponse.Content.ReadAsStringAsync();
            var aliyunResponse = JsonSerializer.Deserialize<AliyunSmsResponse>(responseContent);

            // 5. é”™è¯¯ç æ˜ å°„å’Œæ ‡å‡†åŒ–å“åº”æ„å»º
            var standardErrorCode = ErrorCodeMapper.MapAliyunError(aliyunResponse.Code);
            var friendlyMessage = ErrorCodeMapper.GetErrorMessage(standardErrorCode);
            var isRetryable = ErrorCodeMapper.IsRetryableError(standardErrorCode);

            return new SmsResponse
            {
                IsSuccess = aliyunResponse.Code == "OK",
                RequestId = aliyunResponse.RequestId,
                BizId = aliyunResponse.BizId,
                ErrorCode = aliyunResponse.Code,
                ErrorMessage = aliyunResponse.Message,
                Provider = ProviderName,
                StandardErrorCode = standardErrorCode,
                FriendlyErrorMessage = friendlyMessage,
                IsRetryable = isRetryable
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Exception occurred while sending SMS via Aliyun");
            return new SmsResponse
            {
                IsSuccess = false,
                ErrorCode = "EXCEPTION",
                ErrorMessage = ex.Message,
                Provider = ProviderName,
                StandardErrorCode = StandardErrorCode.Unknown,
                FriendlyErrorMessage = "å‘é€å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•",
                IsRetryable = ex is HttpRequestException or TaskCanceledException
            };
        }
    }
}
```

## ğŸš€ å…³é”®æŠ€æœ¯å®ç°

### 1. ç­¾åç®—æ³•è‡ªç ”

**è®¾è®¡å†³ç­–**ï¼šä¸ºä»€ä¹ˆè‡ªç ”è€Œä¸ç”¨SDKï¼Ÿ

| è€ƒè™‘å› ç´  | SDKæ–¹æ¡ˆ | è‡ªç ”æ–¹æ¡ˆ | ç»“è®º |
|----------|---------|----------|------|
| **å¤æ‚åº¦** | é»‘ç›’ï¼Œéš¾ä»¥è°ƒè¯• | é€æ˜ï¼Œå¯æ§ | âœ… è‡ªç ” |
| **ä½“ç§¯** | 20-30MB/ä¸ª | å‡ KB | âœ… è‡ªç ” |
| **ä¾èµ–** | å¼•å…¥å¤§é‡é—´æ¥ä¾èµ– | é›¶ä¾èµ– | âœ… è‡ªç ” |
| **ç»´æŠ¤** | å—åˆ¶äºSDKæ›´æ–° | å®Œå…¨è‡ªä¸» | âœ… è‡ªç ” |
| **æ€§èƒ½** | åŠ è½½æ—¶é—´é•¿ | å¯åŠ¨å³ç”¨ | âœ… è‡ªç ” |
| **é”™è¯¯å¤„ç†** | å„è‡ªç‹¬ç«‹ | ç»Ÿä¸€æ ‡å‡†åŒ– | âœ… è‡ªç ” |

**å®ç°ç­–ç•¥**ï¼š
- é˜¿é‡Œäº‘ï¼šåŸºäºå®˜æ–¹APIæ–‡æ¡£å®ç°RPCç­¾åç®—æ³•
- è…¾è®¯äº‘ï¼šåŸºäºå®˜æ–¹APIæ–‡æ¡£å®ç°TC3-HMAC-SHA256ç®—æ³•
- éªŒè¯ï¼šå¯¹ç…§å®˜æ–¹ç¤ºä¾‹éªŒè¯ç­¾åæ­£ç¡®æ€§
- é”™è¯¯å¤„ç†ï¼šå»ºç«‹ç»Ÿä¸€çš„é”™è¯¯ç æ˜ å°„ç³»ç»Ÿ

### 2. ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿ

```csharp
// ç»Ÿä¸€çš„æ ‡å‡†åŒ–é”™è¯¯ç 
public enum StandardErrorCode
{
    Success,                    // æˆåŠŸ
    InvalidParameter,           // å‚æ•°é”™è¯¯
    AuthenticationFailed,       // è®¤è¯å¤±è´¥
    InsufficientPermissions,    // æƒé™ä¸è¶³
    InsufficientBalance,        // ä½™é¢ä¸è¶³
    RateLimitExceeded,          // é¢‘ç‡é™åˆ¶
    TemplateNotFound,           // æ¨¡æ¿ä¸å­˜åœ¨
    SignatureNotFound,          // ç­¾åä¸å­˜åœ¨
    InvalidPhoneNumber,         // æ‰‹æœºå·æ ¼å¼é”™è¯¯
    NetworkError,               // ç½‘ç»œé”™è¯¯
    ProviderInternalError,      // æœåŠ¡å•†å†…éƒ¨é”™è¯¯
    Unknown                     // æœªçŸ¥é”™è¯¯
}

// å¢å¼ºçš„ç»Ÿä¸€å“åº”æ¨¡å‹
public class SmsResponse
{
    public bool IsSuccess { get; set; }                    // æ˜¯å¦æˆåŠŸ
    public string RequestId { get; set; } = string.Empty;  // è¯·æ±‚ID
    public string BizId { get; set; } = string.Empty;      // ä¸šåŠ¡ID
    public string ErrorCode { get; set; } = string.Empty;  // åŸå§‹é”™è¯¯ç 
    public string ErrorMessage { get; set; } = string.Empty; // åŸå§‹é”™è¯¯ä¿¡æ¯
    public string Provider { get; set; } = string.Empty;   // ä½¿ç”¨çš„æä¾›å•†

    // æ–°å¢æ ‡å‡†åŒ–å­—æ®µ
    public StandardErrorCode StandardErrorCode { get; set; } = StandardErrorCode.Success; // æ ‡å‡†åŒ–é”™è¯¯ç 
    public string FriendlyErrorMessage { get; set; } = string.Empty; // ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    public bool IsRetryable { get; set; } = false;         // æ˜¯å¦å¯é‡è¯•
}
```

### 3. HTTPå®¢æˆ·ç«¯ç»Ÿä¸€

```csharp
// ç»Ÿä¸€çš„HTTPè°ƒç”¨æ¥å£
public interface IHttpSmsClient
{
    Task<HttpResponseMessage> PostAsync(string url, Dictionary<string, string> headers,
                                       string content, CancellationToken cancellationToken = default);
}

// å®ç°ç‰¹æ€§ï¼š
// - ç»Ÿä¸€è¶…æ—¶è®¾ç½®ï¼ˆ30ç§’ï¼‰
// - è‡ªåŠ¨é‡è¯•æœºåˆ¶
// - ç»“æ„åŒ–æ—¥å¿—è®°å½•
// - å¼‚å¸¸ç»Ÿä¸€å¤„ç†
// - é”™è¯¯ç æ ‡å‡†åŒ–æ˜ å°„
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### 1. å¯åŠ¨æ—¶é—´ä¼˜åŒ–

**é—®é¢˜**ï¼šä¼ ç»ŸSDKéœ€è¦åŠ è½½å¤§é‡ç¨‹åºé›†
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç§»é™¤æ‰€æœ‰ç¬¬ä¸‰æ–¹SDKä¾èµ–
- ä½¿ç”¨.NETå†…ç½®ç±»å‹å’ŒHTTPå®¢æˆ·ç«¯
- æ‡’åŠ è½½é…ç½®å’ŒæœåŠ¡
- é”™è¯¯å¤„ç†ç³»ç»Ÿè½»é‡åŒ–è®¾è®¡

**æ•ˆæœ**ï¼š
```
ä¼ ç»Ÿæ–¹æ¡ˆå¯åŠ¨æ—¶é—´åˆ†æï¼š
â”œâ”€â”€ SDKç¨‹åºé›†åŠ è½½: 1.5-2.0s
â”œâ”€â”€ ä¾èµ–è§£æ: 0.3-0.5s
â”œâ”€â”€ é…ç½®åˆå§‹åŒ–: 0.2s
â””â”€â”€ æ€»è®¡: 2.0-2.7s

PolySmså¯åŠ¨æ—¶é—´åˆ†æï¼š
â”œâ”€â”€ æ ¸å¿ƒç¨‹åºé›†åŠ è½½: 0.1s
â”œâ”€â”€ é”™è¯¯æ˜ å°„ç³»ç»Ÿåˆå§‹åŒ–: 0.05s
â”œâ”€â”€ é…ç½®åˆå§‹åŒ–: 0.05s
â””â”€â”€ æ€»è®¡: 0.2s

æ”¹å–„ï¼š90%å¯åŠ¨æ—¶é—´å‡å°‘
```

### 2. å†…å­˜å ç”¨ä¼˜åŒ–

**é—®é¢˜**ï¼šSDKå¸¦æ¥å¤§é‡å†…å­˜å¼€é”€
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ— é™æ€ä¾èµ–ç¼“å­˜
- æŒ‰éœ€åˆ›å»ºHTTPå®¢æˆ·ç«¯
- è½»é‡çº§é…ç½®å¯¹è±¡
- é”™è¯¯ç æ˜ å°„ä½¿ç”¨é™æ€å­—å…¸ï¼Œå†…å­˜å‹å¥½

**æ•ˆæœ**ï¼š
```
å†…å­˜å ç”¨å¯¹æ¯”ï¼ˆè¿è¡Œæ—¶ï¼‰ï¼š
â”œâ”€â”€ ä¼ ç»Ÿæ–¹æ¡ˆ: 50-80MB
â”œâ”€â”€ PolySms: 10-15MB
â””â”€â”€ å‡å°‘: 70-80%
```

### 3. é”™è¯¯å¤„ç†æ€§èƒ½ä¼˜åŒ–

```csharp
// ä½¿ç”¨é¢„ç¼–è¯‘çš„æ˜ å°„å­—å…¸ï¼Œé¿å…è¿è¡Œæ—¶è®¡ç®—
private static readonly Dictionary<string, StandardErrorCode> AliyunErrorMapping = new()
{
    // é¢„å®šä¹‰æ˜ å°„ï¼ŒO(1)æŸ¥æ‰¾æ—¶é—´
};

// ä½¿ç”¨switchè¡¨è¾¾å¼ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–æ€§èƒ½
public static string GetErrorMessage(StandardErrorCode errorCode)
{
    return errorCode switch
    {
        StandardErrorCode.Success => "å‘é€æˆåŠŸ",
        // ... å…¶ä»–æ˜ å°„ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–ä¸ºè·³è½¬è¡¨
        _ => "æœªçŸ¥é”™è¯¯"
    };
}
```

## ğŸ›¡ï¸ å¯é æ€§è®¾è®¡

### 1. æ™ºèƒ½æ•…éšœè½¬ç§»æœºåˆ¶

```csharp
public class SmsService : ISmsService
{
    public async Task<SmsResponse> SendSmsAsync(SmsRequest request, CancellationToken cancellationToken)
    {
        var response = await SendSmsAsync(request, _smsOptions.DefaultProvider, cancellationToken);

        // åŸºäºæ ‡å‡†åŒ–é”™è¯¯ç çš„æ•…éšœè½¬ç§»é€»è¾‘
        if (!response.IsSuccess && _smsOptions.EnableFailover)
        {
            // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦è¿›è¡Œæ•…éšœè½¬ç§»
            if (ShouldFailover(response.StandardErrorCode))
            {
                foreach (var providerName in _smsOptions.ProviderPriority.Where(p => p != _smsOptions.DefaultProvider))
                {
                    if (IsProviderAvailable(providerName))
                    {
                        response = await SendSmsAsync(request, providerName, cancellationToken);
                        if (response.IsSuccess) break;
                    }
                }
            }
        }

        return response;
    }

    private bool ShouldFailover(StandardErrorCode errorCode)
    {
        return errorCode switch
        {
            StandardErrorCode.NetworkError => true,
            StandardErrorCode.ProviderInternalError => true,
            StandardErrorCode.AuthenticationFailed => false, // è®¤è¯é”™è¯¯ä¸æ•…éšœè½¬ç§»
            StandardErrorCode.InsufficientBalance => false,  // ä½™é¢ä¸è¶³ä¸æ•…éšœè½¬ç§»
            _ => true
        };
    }
}
```

### 2. åˆ†å±‚é”™è¯¯å¤„ç†ç­–ç•¥

```csharp
// åˆ†å±‚é”™è¯¯å¤„ç†ï¼š
// 1. HTTPå±‚é”™è¯¯ â†’ æ ‡å‡†åŒ–ä¸ºNetworkError
// 2. APIå±‚é”™è¯¯ â†’ æ˜ å°„ä¸ºç›¸åº”æ ‡å‡†é”™è¯¯ç 
// 3. ä¸šåŠ¡å±‚é”™è¯¯ â†’ ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ï¼ŒåŒæ—¶æä¾›å‹å¥½ä¿¡æ¯

try
{
    var response = await provider.SendSmsAsync(request, cancellationToken);
    return response;
}
catch (HttpRequestException ex)
{
    return new SmsResponse
    {
        IsSuccess = false,
        ErrorCode = "HTTP_ERROR",
        ErrorMessage = ex.Message,
        Provider = provider.ProviderName,
        StandardErrorCode = StandardErrorCode.NetworkError,
        FriendlyErrorMessage = ErrorCodeMapper.GetErrorMessage(StandardErrorCode.NetworkError),
        IsRetryable = true
    };
}
catch (TaskCanceledException ex)
{
    return new SmsResponse
    {
        IsSuccess = false,
        ErrorCode = "TIMEOUT",
        ErrorMessage = "Request timeout",
        Provider = provider.ProviderName,
        StandardErrorCode = StandardErrorCode.NetworkError,
        FriendlyErrorMessage = "ç½‘ç»œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",
        IsRetryable = true
    };
}
```

### 3. ç»“æ„åŒ–æ—¥å¿—è®°å½•è®¾è®¡

```csharp
// ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼ŒåŒ…å«æ ‡å‡†åŒ–é”™è¯¯ä¿¡æ¯
_logger.LogDebug("Sending SMS via {Provider} to {PhoneNumber} with template {TemplateId}",
    provider.ProviderName, request.PhoneNumber, request.TemplateId);

_logger.LogInformation("SMS sent successfully via {Provider}, RequestId: {RequestId}",
    provider.ProviderName, response.RequestId);

_logger.LogWarning("SMS failed via {Provider}, OriginalError: {ErrorCode} - {ErrorMessage}, " +
    "StandardError: {StandardErrorCode}, FriendlyMessage: {FriendlyMessage}, Retryable: {IsRetryable}",
    provider.ProviderName, response.ErrorCode, response.ErrorMessage,
    response.StandardErrorCode, response.FriendlyErrorMessage, response.IsRetryable);
```

## ğŸ”§ å¯æ‰©å±•æ€§è®¾è®¡

### 1. æ–°æä¾›å•†æ‰©å±•

```csharp
// åªéœ€å®ç°ISmsProvideræ¥å£ï¼Œè‡ªåŠ¨é›†æˆé”™è¯¯å¤„ç†ç³»ç»Ÿ
public class NewCloudSmsProvider : ISmsProvider
{
    public string ProviderName => "NewCloud";

    public async Task<SmsResponse> SendSmsAsync(SmsRequest request, CancellationToken cancellationToken)
    {
        // 1. å®ç°ç­¾åç®—æ³•
        var (url, headers, body) = NewCloudSignatureHelper.BuildRequest(...);

        // 2. HTTPè°ƒç”¨
        var httpResponse = await _httpClient.PostAsync(url, headers, body, cancellationToken);

        // 3. å“åº”è½¬æ¢å’Œé”™è¯¯ç æ˜ å°„
        var originalResponse = ParseResponse(httpResponse);
        var standardErrorCode = ErrorCodeMapper.MapNewCloudError(originalResponse.ErrorCode);

        return new SmsResponse
        {
            IsSuccess = originalResponse.Success,
            RequestId = originalResponse.RequestId,
            ErrorCode = originalResponse.ErrorCode,
            ErrorMessage = originalResponse.ErrorMessage,
            Provider = ProviderName,
            StandardErrorCode = standardErrorCode,
            FriendlyErrorMessage = ErrorCodeMapper.GetErrorMessage(standardErrorCode),
            IsRetryable = ErrorCodeMapper.IsRetryableError(standardErrorCode)
        };
    }
}

// æ‰©å±•é”™è¯¯ç æ˜ å°„å™¨
public static class ErrorCodeMapper
{
    private static readonly Dictionary<string, StandardErrorCode> NewCloudErrorMapping = new()
    {
        ["SUCCESS"] = StandardErrorCode.Success,
        ["INVALID_PARAM"] = StandardErrorCode.InvalidParameter,
        // ... æ–°çš„æ˜ å°„
    };

    public static StandardErrorCode MapNewCloudError(string newCloudErrorCode)
    {
        return NewCloudErrorMapping.TryGetValue(newCloudErrorCode, out var standardCode)
            ? standardCode
            : StandardErrorCode.Unknown;
    }
}
```

## ğŸ¯ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)
- **ç›®çš„**ï¼šç»Ÿä¸€ä¸åŒäº‘æœåŠ¡å•†çš„APIæ¥å£å’Œé”™è¯¯å¤„ç†
- **å®ç°**ï¼šå„Providerå°†äº‘æœåŠ¡å•†ç‰¹æœ‰çš„APIå’Œé”™è¯¯ç é€‚é…ä¸ºç»Ÿä¸€çš„ISmsProvideræ¥å£

### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- **ç›®çš„**ï¼šè¿è¡Œæ—¶é€‰æ‹©ä¸åŒçš„çŸ­ä¿¡æœåŠ¡æä¾›å•†
- **å®ç°**ï¼šSmsServiceæ ¹æ®é…ç½®æˆ–å‚æ•°é€‰æ‹©ç›¸åº”çš„Providerå®ç°

### 3. æ˜ å°„å™¨æ¨¡å¼ (Mapper Pattern)
- **ç›®çš„**ï¼šç»Ÿä¸€ä¸åŒäº‘æœåŠ¡å•†çš„é”™è¯¯ç 
- **å®ç°**ï¼šErrorCodeMapperå°†å„å®¶é”™è¯¯ç æ˜ å°„ä¸ºæ ‡å‡†åŒ–é”™è¯¯ç 

### 4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)
- **ç›®çš„**ï¼šæ ‡å‡†åŒ–HTTPè¯·æ±‚å’Œé”™è¯¯å¤„ç†æµç¨‹
- **å®ç°**ï¼šå®šä¹‰ç»Ÿä¸€çš„ç­¾åâ†’è¯·æ±‚â†’å“åº”â†’é”™è¯¯æ˜ å°„å¤„ç†æ¨¡æ¿

## ğŸ“ˆ æ¶æ„æ¼”è¿›è§„åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ (å·²å®Œæˆ)
- âœ… HTTPç›´è¿æ¶æ„
- âœ… é˜¿é‡Œäº‘/è…¾è®¯äº‘æ”¯æŒ
- âœ… ç­¾åç®—æ³•è‡ªç ”
- âœ… æ•…éšœè½¬ç§»æœºåˆ¶
- âœ… æ ‡å‡†åŒ–é”™è¯¯å¤„ç†ç³»ç»Ÿ

### Phase 2: æ‰©å±•åŠŸèƒ½ (è§„åˆ’ä¸­)
- ğŸ”„ æ›´å¤šäº‘æœåŠ¡å•†æ”¯æŒï¼ˆåä¸ºäº‘ã€ç™¾åº¦äº‘ï¼‰
- ğŸ”„ æ‰¹é‡å‘é€ä¼˜åŒ–
- ğŸ”„ å¼‚æ­¥é˜Ÿåˆ—æ”¯æŒ
- ğŸ”„ ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- ğŸ”„ æ™ºèƒ½é‡è¯•æœºåˆ¶å¢å¼º

### Phase 3: ç”Ÿæ€å»ºè®¾ (è§„åˆ’ä¸­)
- ğŸ”„ WebAPIå°è£…
- ğŸ”„ gRPCæ”¯æŒ
- ğŸ”„ Kuberneteséƒ¨ç½²
- ğŸ”„ äº‘åŸç”Ÿé›†æˆ
- ğŸ”„ é”™è¯¯åˆ†ædashboard

## ğŸ† æ¶æ„ä¼˜åŠ¿æ€»ç»“

1. **æè‡´è½»é‡**ï¼š99.96%åŒ…ä½“ç§¯å‡å°‘ï¼Œé›¶å¤–éƒ¨ä¾èµ–
2. **é«˜æ€§èƒ½**ï¼š90%å¯åŠ¨æ—¶é—´å‡å°‘ï¼Œ80%å†…å­˜å ç”¨å‡å°‘
3. **é«˜å¯æ§**ï¼šå®Œå…¨æŒæ§ç­¾åç®—æ³•å’ŒHTTPè°ƒç”¨è¿‡ç¨‹
4. **æ˜“ç»´æŠ¤**ï¼šé€æ˜çš„è°ƒç”¨é“¾è·¯ï¼Œä¾¿äºè°ƒè¯•å’Œæ’é”™
5. **æ˜“æ‰©å±•**ï¼šæ ‡å‡†åŒ–çš„æ¥å£è®¾è®¡ï¼Œæ–°å¢æä¾›å•†æˆæœ¬ä½
6. **é«˜å¯é **ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ•…éšœè½¬ç§»æœºåˆ¶
7. **ç”¨æˆ·å‹å¥½**ï¼šç»Ÿä¸€çš„é”™è¯¯ç ç³»ç»Ÿå’Œå‹å¥½çš„é”™è¯¯ä¿¡æ¯
8. **æ™ºèƒ½é‡è¯•**ï¼šåŸºäºé”™è¯¯ç±»å‹çš„æ™ºèƒ½é‡è¯•åˆ¤æ–­

PolySmsçš„HTTPç›´è¿æ¶æ„ä»£è¡¨äº†.NETç”Ÿæ€ä¸­SMS SDKçš„æ¼”è¿›æ–¹å‘ï¼š**è½»é‡ã€é«˜æ•ˆã€å¯æ§ã€æ™ºèƒ½**ã€‚é€šè¿‡å…ˆè¿›çš„æ ‡å‡†åŒ–é”™è¯¯å¤„ç†ç³»ç»Ÿï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€è‡´æ€§çš„é”™è¯¯å¤„ç†ä½“éªŒï¼Œå¤§å¤§ç®€åŒ–äº†å¤šäº‘çŸ­ä¿¡æœåŠ¡çš„é›†æˆå’Œç»´æŠ¤å·¥ä½œã€‚