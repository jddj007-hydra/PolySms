# PolySms å¿«é€Ÿå¼€å§‹æŒ‡å—

æ¬¢è¿ä½¿ç”¨PolySmsï¼æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å¿«é€Ÿä¸Šæ‰‹è¿™ä¸ªè½»é‡çº§çš„å¤šäº‘çŸ­ä¿¡SDKã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹© PolySmsï¼Ÿ

### ä¼ ç»ŸSDKçš„é—®é¢˜
- ğŸ“¦ **åŒ…ä½“ç§¯å·¨å¤§**ï¼šé˜¿é‡Œäº‘å’Œè…¾è®¯äº‘SDKåŠ èµ·æ¥è¶…è¿‡50MB
- ğŸŒ **å¯åŠ¨ç¼“æ…¢**ï¼šéœ€è¦åŠ è½½å¤§é‡ç¨‹åºé›†
- ğŸ”— **ä¾èµ–å¤æ‚**ï¼šå¼•å…¥å¤§é‡ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¢åŠ å®‰å…¨é£é™©
- ğŸ”„ **APIä¸ç»Ÿä¸€**ï¼šä¸åŒäº‘æœåŠ¡å•†éœ€è¦å­¦ä¹ ä¸åŒçš„API

### PolySmsçš„ä¼˜åŠ¿
- ğŸª¶ **è¶…è½»é‡çº§**ï¼šä»…çº¦20KBï¼ŒåŒ…ä½“ç§¯å‡å°‘99.96%
- âš¡ **å¯åŠ¨è¿…é€Ÿ**ï¼šHTTPç›´æ¥è°ƒç”¨ï¼Œå¯åŠ¨é€Ÿåº¦æå‡80%
- ğŸ›¡ï¸ **é›¶ä¾èµ–é£é™©**ï¼šæ— ç¬¬ä¸‰æ–¹SDKä¾èµ–ï¼Œå®‰å…¨å¯æ§
- ğŸ¨ **ç»Ÿä¸€API**ï¼šä¸€å¥—ä»£ç æ”¯æŒå¤šä¸ªäº‘æœåŠ¡å•†

## ğŸ“¦ å®‰è£…

```bash
# åªéœ€å®‰è£…ä¸€ä¸ªåŒ…ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½
dotnet add package PolySms
```

## âš™ï¸ é…ç½®æ–¹å¼è¯¦è§£

### æ–¹å¼ä¸€ï¼šç‹¬ç«‹é…ç½®æ–‡ä»¶ï¼ˆå¼ºçƒˆæ¨èï¼‰

#### 1. åˆ›å»ºé…ç½®æ–‡ä»¶
åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `config/sms.json`ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "æ‚¨çš„åº”ç”¨"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

#### 2. åœ¨Program.csä¸­æ³¨å†ŒæœåŠ¡

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ä»ç‹¬ç«‹é…ç½®æ–‡ä»¶åŠ è½½PolySmsæœåŠ¡
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

var app = builder.Build();
app.Run();
```

#### 3. å¤šç¯å¢ƒé…ç½®

```csharp
// æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©é…ç½®æ–‡ä»¶
var environment = builder.Environment.EnvironmentName.ToLower();
var configFile = $"config/sms.{environment}.json";

// å¦‚æœç¯å¢ƒç‰¹å®šé…ç½®ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨é»˜è®¤é…ç½®
if (!File.Exists(configFile))
{
    configFile = "config/sms.json";
}

builder.Services.AddPolySmsFromConfigFile(configFile);
```

### æ–¹å¼äºŒï¼šä»£ç é…ç½®ï¼ˆç®€å•åœºæ™¯ï¼‰

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };
        sms.DefaultSignName = "æ‚¨çš„åº”ç”¨";
    },
    aliyun => {
        aliyun.AccessKeyId = "your-aliyun-access-key-id";
        aliyun.AccessKeySecret = "your-aliyun-access-key-secret";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "your-tencent-secret-id";
        tencent.SecretKey = "your-tencent-secret-key";
        tencent.Region = "ap-beijing";
        tencent.SmsSdkAppId = "your-sms-sdk-app-id";
    });

var app = builder.Build();
```

## ğŸ¯ åŸºæœ¬ä½¿ç”¨

### åˆ›å»ºæ§åˆ¶å™¨

```csharp
using PolySms.Interfaces;
using PolySms.Models;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class SmsController : ControllerBase
{
    private readonly ISmsService _smsService;
    private readonly ILogger<SmsController> _logger;

    public SmsController(ISmsService smsService, ILogger<SmsController> logger)
    {
        _smsService = smsService;
        _logger = logger;
    }

    [HttpPost("send-verification-code")]
    public async Task<IActionResult> SendVerificationCode([FromBody] SendCodeRequest request)
    {
        try
        {
            var smsRequest = new SmsRequest
            {
                PhoneNumber = request.PhoneNumber,
                TemplateId = "SMS_VERIFICATION",      // æ‚¨åœ¨äº‘æœåŠ¡å•†å¤„ç”³è¯·çš„æ¨¡æ¿ID
                SignName = "æ‚¨çš„åº”ç”¨",                  // çŸ­ä¿¡ç­¾å
                TemplateParams = new Dictionary<string, string>
                {
                    { "code", GenerateCode() },        // éªŒè¯ç 
                    { "expire", "5" }                  // è¿‡æœŸæ—¶é—´(åˆ†é’Ÿ)
                }
            };

            // ä½¿ç”¨é…ç½®çš„é»˜è®¤æä¾›å•†å‘é€
            var response = await _smsService.SendSmsAsync(smsRequest);

            if (response.IsSuccess)
            {
                _logger.LogInformation("çŸ­ä¿¡å‘é€æˆåŠŸï¼ŒRequestId: {RequestId}, Provider: {Provider}",
                    response.RequestId, response.Provider);

                return Ok(new {
                    success = true,
                    requestId = response.RequestId,
                    provider = response.Provider,
                    message = "éªŒè¯ç å‘é€æˆåŠŸ"
                });
            }
            else
            {
                _logger.LogWarning("çŸ­ä¿¡å‘é€å¤±è´¥: {ErrorCode} - {ErrorMessage}",
                    response.StandardErrorCode, response.FriendlyErrorMessage);

                return BadRequest(new {
                    success = false,
                    errorCode = response.StandardErrorCode.ToString(),
                    errorMessage = response.FriendlyErrorMessage,
                    isRetryable = response.IsRetryable,
                    provider = response.Provider
                });
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å‘é€éªŒè¯ç æ—¶å‘ç”Ÿå¼‚å¸¸");
            return StatusCode(500, new {
                success = false,
                message = "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"
            });
        }
    }

    private string GenerateCode()
    {
        return new Random().Next(100000, 999999).ToString();
    }
}

public class SendCodeRequest
{
    public string PhoneNumber { get; set; }
}
```

### æŒ‡å®šæä¾›å•†å‘é€

```csharp
[HttpPost("send-with-provider")]
public async Task<IActionResult> SendWithSpecificProvider([FromBody] SendWithProviderRequest request)
{
    var smsRequest = new SmsRequest
    {
        PhoneNumber = request.PhoneNumber,
        TemplateId = request.TemplateId,
        SignName = request.SignName,
        TemplateParams = request.TemplateParams
    };

    // æ–¹å¼1: å­—ç¬¦ä¸²æŒ‡å®šæä¾›å•†
    var response1 = await _smsService.SendSmsAsync(smsRequest, "Aliyun");
    var response2 = await _smsService.SendSmsAsync(smsRequest, "Tencent");

    // æ–¹å¼2: æšä¸¾æŒ‡å®šæä¾›å•†ï¼ˆç±»å‹å®‰å…¨ï¼Œæ¨èï¼‰
    var response3 = await _smsService.SendSmsAsync(smsRequest, SmsProvider.Aliyun);
    var response4 = await _smsService.SendSmsAsync(smsRequest, SmsProvider.Tencent);

    return Ok(new { message = "å‘é€å®Œæˆ" });
}
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### æ•…éšœè½¬ç§»æœºåˆ¶

å½“å¯ç”¨ `EnableFailover = true` æ—¶ï¼Œå¦‚æœé»˜è®¤æä¾›å•†å‘é€å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ç…§ `ProviderPriority` çš„é¡ºåºå°è¯•å…¶ä»–æä¾›å•†ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  }
}
```

### æ™ºèƒ½é”™è¯¯å¤„ç†å’Œé‡è¯•ç­–ç•¥

```csharp
[HttpPost("send-with-retry")]
public async Task<IActionResult> SendWithRetry([FromBody] SendCodeRequest request)
{
    var smsRequest = new SmsRequest
    {
        PhoneNumber = request.PhoneNumber,
        TemplateId = "SMS_VERIFICATION",
        SignName = "æ‚¨çš„åº”ç”¨",
        TemplateParams = new Dictionary<string, string>
        {
            { "code", GenerateCode() },
            { "expire", "5" }
        }
    };

    var response = await _smsService.SendSmsAsync(smsRequest);

    // æ™ºèƒ½é‡è¯•é€»è¾‘
    var retryCount = 0;
    var maxRetries = 3;

    while (!response.IsSuccess && response.IsRetryable && retryCount < maxRetries)
    {
        // æ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©åˆé€‚çš„å»¶è¿Ÿæ—¶é—´
        var delay = response.StandardErrorCode switch
        {
            StandardErrorCode.RateLimitExceeded => TimeSpan.FromMinutes(1),
            StandardErrorCode.NetworkError => TimeSpan.FromSeconds(5),
            StandardErrorCode.ProviderInternalError => TimeSpan.FromSeconds(10),
            _ => TimeSpan.FromSeconds(3)
        };

        _logger.LogInformation("é‡è¯•å‘é€çŸ­ä¿¡ï¼Œç¬¬{RetryCount}æ¬¡ï¼Œå»¶è¿Ÿ{Delay}ç§’",
            retryCount + 1, delay.TotalSeconds);

        await Task.Delay(delay);
        retryCount++;

        response = await _smsService.SendSmsAsync(smsRequest);
    }

    if (response.IsSuccess)
    {
        return Ok(new {
            success = true,
            provider = response.Provider,
            retryCount = retryCount,
            message = retryCount > 0 ? $"é‡è¯•{retryCount}æ¬¡åå‘é€æˆåŠŸ" : "å‘é€æˆåŠŸ"
        });
    }
    else
    {
        return BadRequest(new {
            success = false,
            error = response.FriendlyErrorMessage,
            retryCount = retryCount,
            isRetryable = response.IsRetryable
        });
    }
}
```

## ğŸ“ˆ ä¸‹ä¸€æ­¥

æ­å–œï¼æ‚¨å·²ç»æŒæ¡äº†PolySmsçš„åŸºæœ¬ä½¿ç”¨ã€‚æ¥ä¸‹æ¥å¯ä»¥ï¼š

1. **æ·±å…¥å­¦ä¹ **ï¼šæŸ¥çœ‹ [é…ç½®è¯´æ˜](é…ç½®è¯´æ˜.md) äº†è§£æ›´å¤šé…ç½®é€‰é¡¹
2. **ä¼ä¸šçº§éƒ¨ç½²**ï¼šå‚è€ƒ [è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æŒ‡å—](è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä½¿ç”¨æŒ‡å—.md)
3. **æ¶æ„ç†è§£**ï¼šé˜…è¯» [æ¶æ„è®¾è®¡](æ¶æ„è®¾è®¡.md) äº†è§£è½»é‡çº§è®¾è®¡åŸç†
4. **é—®é¢˜æ’æŸ¥**ï¼šå‚è€ƒ [æ‰€æœ‰æ–‡æ¡£](INDEX.md) è§£å†³å…·ä½“é—®é¢˜

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨GitHub Issuesä¸­æé—®ï¼