# PolySms å¿«é€Ÿå¼€å§‹æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å¿«é€Ÿé›†æˆPolySmsåˆ°é¡¹ç›®ä¸­ï¼Œäº«å—è½»é‡çº§ã€é«˜æ€§èƒ½çš„å¤šäº‘çŸ­ä¿¡æœåŠ¡ã€‚

## ğŸ“¦ å®‰è£…

PolySmsåªéœ€è¦ä¸€ä¸ªåŒ…ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼š

### NuGet Package Manager
```bash
dotnet add package PolySms
```

### Package Manager Console
```powershell
Install-Package PolySms
```

### PackageReference (æ¨è)
```xml
<PackageReference Include="PolySms" Version="1.0.0" />
```

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿé›†æˆ

### æ­¥éª¤1: å®‰è£…åŒ…

```bash
dotnet add package PolySms
```

### æ­¥éª¤2: é…ç½®æœåŠ¡

åœ¨`Program.cs`ä¸­æ·»åŠ æœåŠ¡æ³¨å†Œï¼š

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// æ·»åŠ PolySmsæœåŠ¡
builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

### æ­¥éª¤3: é…ç½®å‚æ•°

åœ¨`appsettings.json`ä¸­æ·»åŠ é…ç½®ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing"
  }
}
```

### æ­¥éª¤4: ä½¿ç”¨æœåŠ¡

```csharp
using PolySms.Interfaces;
using PolySms.Models;

[ApiController]
[Route("api/[controller]")]
public class SmsController : ControllerBase
{
    private readonly ISmsService _smsService;

    public SmsController(ISmsService smsService)
    {
        _smsService = smsService;
    }

    [HttpPost("send")]
    public async Task<IActionResult> SendSms([FromBody] SendSmsRequest request)
    {
        var smsRequest = new SmsRequest
        {
            PhoneNumber = request.PhoneNumber,
            TemplateId = request.TemplateId,
            SignName = request.SignName,
            TemplateParams = request.TemplateParams
        };

        var response = await _smsService.SendSmsAsync(smsRequest);

        if (response.IsSuccess)
        {
            return Ok(new { success = true, requestId = response.RequestId });
        }

        return BadRequest(new { success = false, error = response.ErrorMessage });
    }
}

public class SendSmsRequest
{
    public string PhoneNumber { get; set; } = string.Empty;
    public string TemplateId { get; set; } = string.Empty;
    public string SignName { get; set; } = string.Empty;
    public Dictionary<string, string> TemplateParams { get; set; } = new();
}
```

## ğŸ’¡ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: éªŒè¯ç å‘é€

```csharp
public class VerificationService
{
    private readonly ISmsService _smsService;

    public VerificationService(ISmsService smsService)
    {
        _smsService = smsService;
    }

    public async Task<bool> SendVerificationCode(string phoneNumber)
    {
        var code = GenerateRandomCode(6);

        var request = new SmsRequest
        {
            PhoneNumber = phoneNumber,
            TemplateId = "SMS_VERIFICATION_001", // æ‚¨çš„éªŒè¯ç æ¨¡æ¿ID
            SignName = "æ‚¨çš„åº”ç”¨",
            TemplateParams = new Dictionary<string, string>
            {
                { "code", code },
                { "expire", "5" } // 5åˆ†é’Ÿè¿‡æœŸ
            }
        };

        var response = await _smsService.SendSmsAsync(request);

        if (response.IsSuccess)
        {
            // ä¿å­˜éªŒè¯ç åˆ°ç¼“å­˜/æ•°æ®åº“
            await SaveVerificationCode(phoneNumber, code);
            return true;
        }

        return false;
    }

    private string GenerateRandomCode(int length)
    {
        var random = new Random();
        return string.Join("", Enumerable.Range(0, length)
            .Select(_ => random.Next(0, 10).ToString()));
    }

    private async Task SaveVerificationCode(string phoneNumber, string code)
    {
        // å®ç°éªŒè¯ç ä¿å­˜é€»è¾‘
    }
}
```

### åœºæ™¯2: æŒ‡å®šæä¾›å•†å‘é€

```csharp
public class SmsBusinessService
{
    private readonly ISmsService _smsService;

    public SmsBusinessService(ISmsService smsService)
    {
        _smsService = smsService;
    }

    public async Task<SmsResponse> SendMarketingSms(string phoneNumber, string content)
    {
        var request = new SmsRequest
        {
            PhoneNumber = phoneNumber,
            TemplateId = "MARKETING_001",
            SignName = "è¥é”€ä¸­å¿ƒ",
            TemplateParams = new Dictionary<string, string>
            {
                { "content", content }
            }
        };

        // è¥é”€çŸ­ä¿¡ä½¿ç”¨è…¾è®¯äº‘
        return await _smsService.SendSmsAsync(request, "Tencent");
    }

    public async Task<SmsResponse> SendSystemNotification(string phoneNumber, string message)
    {
        var request = new SmsRequest
        {
            PhoneNumber = phoneNumber,
            TemplateId = "SYSTEM_001",
            SignName = "ç³»ç»Ÿé€šçŸ¥",
            TemplateParams = new Dictionary<string, string>
            {
                { "message", message }
            }
        };

        // ç³»ç»Ÿé€šçŸ¥ä½¿ç”¨é˜¿é‡Œäº‘
        return await _smsService.SendSmsAsync(request, SmsProvider.Aliyun);
    }
}
```

### åœºæ™¯3: æ‰¹é‡å‘é€ï¼ˆå¸¦æ•…éšœè½¬ç§»ï¼‰

```csharp
public class BatchSmsService
{
    private readonly ISmsService _smsService;
    private readonly ILogger<BatchSmsService> _logger;

    public BatchSmsService(ISmsService smsService, ILogger<BatchSmsService> logger)
    {
        _smsService = smsService;
        _logger = logger;
    }

    public async Task<BatchSmsResult> SendBatchSms(
        List<string> phoneNumbers,
        string templateId,
        string signName,
        Dictionary<string, string> templateParams)
    {
        var results = new List<SmsResponse>();
        var successCount = 0;

        foreach (var phoneNumber in phoneNumbers)
        {
            try
            {
                var request = new SmsRequest
                {
                    PhoneNumber = phoneNumber,
                    TemplateId = templateId,
                    SignName = signName,
                    TemplateParams = templateParams
                };

                var response = await _smsService.SendSmsAsync(request);
                results.Add(response);

                if (response.IsSuccess)
                {
                    successCount++;
                    _logger.LogInformation("SMS sent successfully to {PhoneNumber}", phoneNumber);
                }
                else
                {
                    _logger.LogWarning("Failed to send SMS to {PhoneNumber}: {Error}",
                        phoneNumber, response.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Exception occurred while sending SMS to {PhoneNumber}", phoneNumber);
                results.Add(new SmsResponse
                {
                    IsSuccess = false,
                    ErrorCode = "EXCEPTION",
                    ErrorMessage = ex.Message
                });
            }

            // é¿å…é¢‘ç‡é™åˆ¶
            await Task.Delay(100);
        }

        return new BatchSmsResult
        {
            TotalCount = phoneNumbers.Count,
            SuccessCount = successCount,
            FailureCount = phoneNumbers.Count - successCount,
            Results = results
        };
    }
}

public class BatchSmsResult
{
    public int TotalCount { get; set; }
    public int SuccessCount { get; set; }
    public int FailureCount { get; set; }
    public List<SmsResponse> Results { get; set; } = new();
}
```

## ğŸ”§ é«˜çº§é…ç½®

### ä»£ç é…ç½®æ–¹å¼

å¦‚æœæ‚¨æ›´å–œæ¬¢åœ¨ä»£ç ä¸­é…ç½®ï¼š

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };
    },
    aliyun => {
        aliyun.AccessKeyId = "your-access-key-id";
        aliyun.AccessKeySecret = "your-access-key-secret";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "your-secret-id";
        tencent.SecretKey = "your-secret-key";
        tencent.SmsSdkAppId = "1400000000";
        tencent.Region = "ap-beijing";
    }
);
```

### ç¯å¢ƒå˜é‡é…ç½®

é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æ•æ„Ÿä¿¡æ¯ï¼š

```bash
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜1: ä¾èµ–æ³¨å…¥å¤±è´¥

**é”™è¯¯**: `Unable to resolve service for type 'ISmsService'`

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿å·²æ­£ç¡®æ³¨å†ŒæœåŠ¡
```csharp
builder.Services.AddPolySms(builder.Configuration);
```

### å¸¸è§é—®é¢˜2: é…ç½®å‚æ•°ç¼ºå¤±

**é”™è¯¯**: å‘é€å¤±è´¥ï¼Œé”™è¯¯ç ä¸ºé…ç½®ç›¸å…³

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥é…ç½®å‚æ•°æ˜¯å¦å®Œæ•´
```json
{
  "AliyunSms": {
    "AccessKeyId": "å¿…å¡«",
    "AccessKeySecret": "å¿…å¡«"
  },
  "TencentSms": {
    "SecretId": "å¿…å¡«",
    "SecretKey": "å¿…å¡«",
    "SmsSdkAppId": "å¿…å¡«"
  }
}
```

### å¸¸è§é—®é¢˜3: ç­¾åæˆ–æ¨¡æ¿é—®é¢˜

**é”™è¯¯**: ç­¾åä¸å­˜åœ¨æˆ–æ¨¡æ¿ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**:
1. åœ¨äº‘æœåŠ¡å•†æ§åˆ¶å°åˆ›å»ºçŸ­ä¿¡ç­¾å
2. åˆ›å»ºå¹¶å®¡æ ¸é€šè¿‡çŸ­ä¿¡æ¨¡æ¿
3. ç¡®ä¿`SignName`å’Œ`TemplateId`æ­£ç¡®

## ğŸ” æ—¥å¿—å’Œç›‘æ§

å¯ç”¨è¯¦ç»†æ—¥å¿—ä»¥ä¾¿è°ƒè¯•ï¼š

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "PolySms": "Debug"
    }
  }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŠ¿

ç›¸æ¯”ä¼ ç»ŸSDKæ–¹æ¡ˆï¼ŒPolySmså…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ï¼š

| æŒ‡æ ‡ | ä¼ ç»ŸSDKæ–¹æ¡ˆ | PolySms | æ”¹è¿› |
|------|------------|---------|------|
| åŒ…ä½“ç§¯ | ~50MB | ~20KB | â†“99.96% |
| å¯åŠ¨æ—¶é—´ | 2-3ç§’ | 0.2-0.3ç§’ | â†“90% |
| å†…å­˜å ç”¨ | 50-80MB | 10-15MB | â†“80% |
| ä¾èµ–å†²çª | ç»å¸¸å‘ç”Ÿ | å‡ ä¹æ²¡æœ‰ | æ˜¾è‘—æ”¹å–„ |

## ğŸ”„ ä»PolySmsè¿ç§»

å¦‚æœæ‚¨ä¹‹å‰ä½¿ç”¨PolySmsï¼Œè¿ç§»éå¸¸ç®€å•ï¼š

### 1. æ›¿æ¢åŒ…å¼•ç”¨
```xml
<!-- åˆ é™¤ -->
<PackageReference Include="PolySms.Core" />
<PackageReference Include="PolySms.Providers.Aliyun" />
<PackageReference Include="PolySms.Providers.Tencent" />

<!-- æ›¿æ¢ä¸º -->
<PackageReference Include="PolySms" Version="1.0.0" />
```

### 2. æ›´æ–°å‘½åç©ºé—´
```csharp
// æ—§çš„
using PolySms.Core.Extensions;
using PolySms.Core.Interfaces;
using PolySms.Core.Models;

// æ–°çš„
using PolySms.Extensions;
using PolySms.Interfaces;
using PolySms.Models;
```

### 3. æ›´æ–°æœåŠ¡æ³¨å†Œ
```csharp
// æ—§çš„
builder.Services.AddMergeSms(builder.Configuration)
                .AddAliyunSms(builder.Configuration)
                .AddTencentSms(builder.Configuration);

// æ–°çš„ï¼ˆæ¨èï¼‰
builder.Services.AddPolySms(builder.Configuration);

// æˆ–å…¼å®¹æ–¹å¼ï¼ˆè¿‡æ¸¡æœŸä½¿ç”¨ï¼‰
builder.Services.AddMergeSms(builder.Configuration); // ä¼šæ˜¾ç¤ºè¿‡æ—¶è­¦å‘Š
```

### 4. é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹
ç°æœ‰çš„`appsettings.json`é…ç½®æ ¼å¼å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ï¼

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨å·²ç»æˆåŠŸé›†æˆäº†PolySmsï¼äº«å—ï¼š

- **99.96%çš„åŒ…ä½“ç§¯å‡å°‘**
- **æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦**
- **æ›´å°‘çš„ä¾èµ–å†²çª**
- **å®Œå…¨ç›¸åŒçš„åŠŸèƒ½**

## ğŸ“š è¿›ä¸€æ­¥é˜…è¯»

- [æ¶æ„è®¾è®¡æ–‡æ¡£](æ¶æ„è®¾è®¡.md) - äº†è§£PolySmsçš„æŠ€æœ¯æ¶æ„
- [é…ç½®è¯´æ˜æ–‡æ¡£](é…ç½®è¯´æ˜.md) - è¯¦ç»†çš„é…ç½®é€‰é¡¹è¯´æ˜
- [APIå·®å¼‚å¤„ç†æ–‡æ¡£](APIå·®å¼‚å¤„ç†.md) - äº†è§£å†…éƒ¨å®ç°è¯¦æƒ…
- [ç¤ºä¾‹é¡¹ç›®](../Example/Program.cs) - è·å–æ›´å¤šä½¿ç”¨ç¤ºä¾‹

å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒå…¶ä»–æ–‡æ¡£æˆ–æäº¤Issueã€‚