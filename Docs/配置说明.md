# PolySms é…ç½®è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»PolySmsçš„æ‰€æœ‰é…ç½®é€‰é¡¹å’Œä½¿ç”¨æ–¹å¼ï¼Œå¸®åŠ©æ‚¨æ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©æœ€ä½³çš„é…ç½®æ–¹æ¡ˆã€‚

## ğŸ›ï¸ é…ç½®æ–¹å¼æ¦‚è§ˆ

PolySmsæ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼Œæ‚¨å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆï¼š

| é…ç½®æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|----------|------|------|
| é…ç½®æ–‡ä»¶ | ç”Ÿäº§ç¯å¢ƒã€ä¼ä¸šçº§åº”ç”¨ | æ˜“ç®¡ç†ã€æ”¯æŒå¤šç¯å¢ƒ | éœ€è¦é…ç½®æ–‡ä»¶ |
| ä»£ç é…ç½® | ç®€å•åº”ç”¨ã€å¿«é€ŸåŸå‹ | ä»£ç å³é…ç½®ã€ç±»å‹å®‰å…¨ | ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ |
| ç¯å¢ƒå˜é‡ | å®¹å™¨åŒ–éƒ¨ç½²ã€CI/CD | å®‰å…¨æ€§é«˜ã€éƒ¨ç½²çµæ´» | é…ç½®åˆ†æ•£ |
| æ··åˆé…ç½® | å¤æ‚ä¼ä¸šåº”ç”¨ | çµæ´»æ€§æœ€é«˜ | é…ç½®å¤æ‚ |

## ğŸ“ é…ç½®æ–‡ä»¶æ–¹å¼

### åŸºç¡€é…ç½®

åœ¨ `appsettings.json` ä¸­é…ç½®ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "æ‚¨çš„åº”ç”¨"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing"
  }
}
```

ç„¶ååœ¨ `Program.cs` ä¸­æ³¨å†ŒæœåŠ¡ï¼š

```csharp
builder.Services.AddPolySms(builder.Configuration);
```

### å¤šç¯å¢ƒé…ç½®

#### å¼€å‘ç¯å¢ƒ (`appsettings.Development.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": false,
    "DefaultSignName": "æµ‹è¯•åº”ç”¨"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Debug"
    }
  }
}
```

#### æµ‹è¯•ç¯å¢ƒ (`appsettings.Staging.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Tencent",
    "EnableFailover": true,
    "ProviderPriority": ["Tencent", "Aliyun"],
    "DefaultSignName": "é¢„å‘å¸ƒåº”ç”¨"
  }
}
```

#### ç”Ÿäº§ç¯å¢ƒ (`appsettings.Production.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "ç”Ÿäº§åº”ç”¨"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Warning"
    }
  }
}
```

## ğŸ’» ä»£ç é…ç½®æ–¹å¼

### åŸºç¡€ä»£ç é…ç½®

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Aliyun";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Aliyun", "Tencent" };
        sms.DefaultSignName = "æ‚¨çš„åº”ç”¨";
    },
    aliyun => {
        aliyun.AccessKeyId = "your-aliyun-access-key-id";
        aliyun.AccessKeySecret = "your-aliyun-access-key-secret";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "your-tencent-secret-id";
        tencent.SecretKey = "your-tencent-secret-key";
        tencent.SmsSdkAppId = "your-sms-sdk-app-id";
        tencent.Region = "ap-beijing";
    }
);
```

### é«˜çº§ä»£ç é…ç½®

```csharp
builder.Services.AddPolySms(
    sms => {
        // åŸºç¡€é…ç½®
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;

        // æä¾›å•†ä¼˜å…ˆçº§ï¼ˆæ•…éšœè½¬ç§»é¡ºåºï¼‰
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };

        // é»˜è®¤ç­¾åï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥åœ¨æ¯æ¬¡å‘é€æ—¶æŒ‡å®šï¼‰
        sms.DefaultSignName = "æ‚¨çš„åº”ç”¨";
    },
    aliyun => {
        // é˜¿é‡Œäº‘é…ç½®
        aliyun.AccessKeyId = GetSecret("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = GetSecret("ALIYUN_ACCESS_KEY_SECRET");
        aliyun.Endpoint = "dysmsapi.aliyuncs.com"; // é»˜è®¤endpoint
    },
    tencent => {
        // è…¾è®¯äº‘é…ç½®
        tencent.SecretId = GetSecret("TENCENT_SECRET_ID");
        tencent.SecretKey = GetSecret("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = GetSecret("TENCENT_SMS_SDK_APP_ID");
        tencent.Region = "ap-beijing"; // é»˜è®¤åœ°åŸŸ
    }
);

// ä»å®‰å…¨å­˜å‚¨è·å–å¯†é’¥çš„ç¤ºä¾‹æ–¹æ³•
static string GetSecret(string key)
{
    // å¯ä»¥ä»Azure Key Vaultã€AWS Secrets Managerç­‰è·å–
    return Environment.GetEnvironmentVariable(key)
           ?? throw new InvalidOperationException($"Missing secret: {key}");
}
```

## ğŸŒ ç¯å¢ƒå˜é‡é…ç½®

### ç¯å¢ƒå˜é‡å‘½åè§„åˆ™

PolySmséµå¾ª.NETé…ç½®ç³»ç»Ÿçš„æ ‡å‡†å‘½åçº¦å®šï¼š

```bash
# SMSåŸºç¡€é…ç½®
export Sms__DefaultProvider="Aliyun"
export Sms__EnableFailover="true"
export Sms__DefaultSignName="æ‚¨çš„åº”ç”¨"

# é˜¿é‡Œäº‘é…ç½®
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export AliyunSms__Endpoint="dysmsapi.aliyuncs.com"

# è…¾è®¯äº‘é…ç½®
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
export TencentSms__Region="ap-beijing"
```

### Dockerç¯å¢ƒå˜é‡é…ç½®

```dockerfile
# Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0
# ... å…¶ä»–é…ç½®

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV Sms__DefaultProvider=Aliyun
ENV Sms__EnableFailover=true
ENV AliyunSms__AccessKeyId=${ALIYUN_ACCESS_KEY_ID}
ENV AliyunSms__AccessKeySecret=${ALIYUN_ACCESS_KEY_SECRET}
ENV TencentSms__SecretId=${TENCENT_SECRET_ID}
ENV TencentSms__SecretKey=${TENCENT_SECRET_KEY}
ENV TencentSms__SmsSdkAppId=${TENCENT_SMS_SDK_APP_ID}
```

### Docker Composeé…ç½®

```yaml
version: '3.8'
services:
  app:
    image: your-app
    environment:
      - Sms__DefaultProvider=Aliyun
      - Sms__EnableFailover=true
      - AliyunSms__AccessKeyId=${ALIYUN_ACCESS_KEY_ID}
      - AliyunSms__AccessKeySecret=${ALIYUN_ACCESS_KEY_SECRET}
      - TencentSms__SecretId=${TENCENT_SECRET_ID}
      - TencentSms__SecretKey=${TENCENT_SECRET_KEY}
      - TencentSms__SmsSdkAppId=${TENCENT_SMS_SDK_APP_ID}
    env_file:
      - .env
```

### Kubernetes ConfigMapå’ŒSecret

```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sms-config
data:
  Sms__DefaultProvider: "Aliyun"
  Sms__EnableFailover: "true"
  AliyunSms__Endpoint: "dysmsapi.aliyuncs.com"
  TencentSms__Region: "ap-beijing"

---
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: sms-secrets
type: Opaque
stringData:
  AliyunSms__AccessKeyId: "your-aliyun-access-key-id"
  AliyunSms__AccessKeySecret: "your-aliyun-access-key-secret"
  TencentSms__SecretId: "your-tencent-secret-id"
  TencentSms__SecretKey: "your-tencent-secret-key"
  TencentSms__SmsSdkAppId: "your-sms-sdk-app-id"

---
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: your-app
spec:
  template:
    spec:
      containers:
      - name: app
        image: your-app
        envFrom:
        - configMapRef:
            name: sms-config
        - secretRef:
            name: sms-secrets
```

## ğŸ”€ æ··åˆé…ç½®æ–¹å¼

### é…ç½®æ–‡ä»¶ + ç¯å¢ƒå˜é‡

é€‚ç”¨äºåŸºç¡€é…ç½®ä½¿ç”¨æ–‡ä»¶ï¼Œæ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡çš„åœºæ™¯ï¼š

```json
// appsettings.json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "æ‚¨çš„åº”ç”¨"
  },
  "AliyunSms": {
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "Region": "ap-beijing"
  }
}
```

```bash
# æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡æä¾›
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
```

### ä»£ç é…ç½® + å¤–éƒ¨å¯†é’¥ç®¡ç†

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = builder.Configuration["Sms:DefaultProvider"] ?? "Aliyun";
        sms.EnableFailover = builder.Configuration.GetValue<bool>("Sms:EnableFailover", true);
        sms.ProviderPriority = builder.Configuration.GetSection("Sms:ProviderPriority")
            .Get<List<string>>() ?? new List<string> { "Aliyun", "Tencent" };
    },
    aliyun => {
        // ä»Azure Key Vaultè·å–å¯†é’¥
        aliyun.AccessKeyId = builder.Configuration["AliyunAccessKeyId"];
        aliyun.AccessKeySecret = builder.Configuration["AliyunAccessKeySecret"];
        aliyun.Endpoint = builder.Configuration["AliyunSms:Endpoint"] ?? "dysmsapi.aliyuncs.com";
    },
    tencent => {
        // ä»AWS Secrets Managerè·å–å¯†é’¥
        tencent.SecretId = builder.Configuration["TencentSecretId"];
        tencent.SecretKey = builder.Configuration["TencentSecretKey"];
        tencent.SmsSdkAppId = builder.Configuration["TencentSmsSdkAppId"];
        tencent.Region = builder.Configuration["TencentSms:Region"] ?? "ap-beijing";
    }
);
```

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### SMSæ ¸å¿ƒé…ç½® (SmsOptions)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `DefaultProvider` | string | "Aliyun" | é»˜è®¤çŸ­ä¿¡æä¾›å•† |
| `EnableFailover` | bool | false | æ˜¯å¦å¯ç”¨æ•…éšœè½¬ç§» |
| `ProviderPriority` | List&lt;string&gt; | ["Aliyun", "Tencent"] | æä¾›å•†ä¼˜å…ˆçº§ï¼ˆæ•…éšœè½¬ç§»é¡ºåºï¼‰ |
| `DefaultSignName` | string | null | é»˜è®¤çŸ­ä¿¡ç­¾å |

```csharp
public class SmsOptions
{
    /// <summary>
    /// é»˜è®¤æä¾›å•† ("Aliyun" æˆ– "Tencent")
    /// </summary>
    public string DefaultProvider { get; set; } = "Aliyun";

    /// <summary>
    /// å¯ç”¨æ•…éšœè½¬ç§»
    /// </summary>
    public bool EnableFailover { get; set; } = false;

    /// <summary>
    /// æä¾›å•†ä¼˜å…ˆçº§ï¼ˆæ•…éšœè½¬ç§»é¡ºåºï¼‰
    /// </summary>
    public List<string> ProviderPriority { get; set; } = new() { "Aliyun", "Tencent" };

    /// <summary>
    /// é»˜è®¤ç­¾ååç§°ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    public string? DefaultSignName { get; set; }
}
```

### é˜¿é‡Œäº‘é…ç½® (AliyunSmsOptions)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜ |
|------|------|--------|------|------|
| `AccessKeyId` | string | - | âœ… | é˜¿é‡Œäº‘è®¿é—®å¯†é’¥ID |
| `AccessKeySecret` | string | - | âœ… | é˜¿é‡Œäº‘è®¿é—®å¯†é’¥Secret |
| `Endpoint` | string | "dysmsapi.aliyuncs.com" | âŒ | APIç«¯ç‚¹ |

```csharp
public class AliyunSmsOptions
{
    /// <summary>
    /// é˜¿é‡Œäº‘AccessKey ID
    /// </summary>
    public string AccessKeyId { get; set; } = string.Empty;

    /// <summary>
    /// é˜¿é‡Œäº‘AccessKey Secret
    /// </summary>
    public string AccessKeySecret { get; set; } = string.Empty;

    /// <summary>
    /// çŸ­ä¿¡æœåŠ¡APIç«¯ç‚¹
    /// </summary>
    public string Endpoint { get; set; } = "dysmsapi.aliyuncs.com";
}
```

### è…¾è®¯äº‘é…ç½® (TencentSmsOptions)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜ |
|------|------|--------|------|------|
| `SecretId` | string | - | âœ… | è…¾è®¯äº‘å¯†é’¥ID |
| `SecretKey` | string | - | âœ… | è…¾è®¯äº‘å¯†é’¥Key |
| `SmsSdkAppId` | string | - | âœ… | çŸ­ä¿¡åº”ç”¨ID |
| `Region` | string | "ap-beijing" | âŒ | åœ°åŸŸ |

```csharp
public class TencentSmsOptions
{
    /// <summary>
    /// è…¾è®¯äº‘SecretId
    /// </summary>
    public string SecretId { get; set; } = string.Empty;

    /// <summary>
    /// è…¾è®¯äº‘SecretKey
    /// </summary>
    public string SecretKey { get; set; } = string.Empty;

    /// <summary>
    /// çŸ­ä¿¡SdkAppId
    /// </summary>
    public string SmsSdkAppId { get; set; } = string.Empty;

    /// <summary>
    /// è…¾è®¯äº‘åœ°åŸŸ
    /// </summary>
    public string Region { get; set; } = "ap-beijing";
}
```

## ğŸ”§ é«˜çº§é…ç½®åœºæ™¯

### å¤šç§Ÿæˆ·é…ç½®

```csharp
// æ³¨å†Œå¤šä¸ªé…ç½®å®ä¾‹
builder.Services.Configure<SmsOptions>("tenant1", config =>
{
    config.DefaultProvider = "Aliyun";
    config.DefaultSignName = "ç§Ÿæˆ·1";
});

builder.Services.Configure<SmsOptions>("tenant2", config =>
{
    config.DefaultProvider = "Tencent";
    config.DefaultSignName = "ç§Ÿæˆ·2";
});

// ä½¿ç”¨æ—¶é€šè¿‡IOptionsSnapshotè·å–ç‰¹å®šç§Ÿæˆ·é…ç½®
public class MultiTenantSmsService
{
    private readonly IOptionsSnapshot<SmsOptions> _options;
    private readonly ISmsService _smsService;

    public MultiTenantSmsService(IOptionsSnapshot<SmsOptions> options, ISmsService smsService)
    {
        _options = options;
        _smsService = smsService;
    }

    public async Task<SmsResponse> SendSmsForTenant(string tenantId, SmsRequest request)
    {
        var tenantOptions = _options.Get(tenantId);

        // ä½¿ç”¨ç§Ÿæˆ·ç‰¹å®šçš„é…ç½®
        if (!string.IsNullOrEmpty(tenantOptions.DefaultSignName))
        {
            request.SignName = tenantOptions.DefaultSignName;
        }

        return await _smsService.SendSmsAsync(request, tenantOptions.DefaultProvider);
    }
}
```

### åŠ¨æ€é…ç½®æ›´æ–°

```csharp
// æ”¯æŒé…ç½®çƒ­æ›´æ–°
builder.Services.Configure<SmsOptions>(builder.Configuration.GetSection("Sms"));

// ä½¿ç”¨IOptionsMonitorç›‘å¬é…ç½®å˜åŒ–
public class ConfigurableSmsService
{
    private readonly IOptionsMonitor<SmsOptions> _options;
    private readonly ISmsService _smsService;
    private readonly ILogger<ConfigurableSmsService> _logger;

    public ConfigurableSmsService(
        IOptionsMonitor<SmsOptions> options,
        ISmsService smsService,
        ILogger<ConfigurableSmsService> logger)
    {
        _options = options;
        _smsService = smsService;
        _logger = logger;

        // ç›‘å¬é…ç½®å˜åŒ–
        _options.OnChange(OnConfigurationChanged);
    }

    private void OnConfigurationChanged(SmsOptions newOptions)
    {
        _logger.LogInformation("SMSé…ç½®å·²æ›´æ–°: DefaultProvider={DefaultProvider}, EnableFailover={EnableFailover}",
            newOptions.DefaultProvider, newOptions.EnableFailover);
    }
}
```

### æ¡ä»¶é…ç½®

```csharp
// æ ¹æ®ç¯å¢ƒåŠ¨æ€é…ç½®
var isDevelopment = builder.Environment.IsDevelopment();

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = isDevelopment ? "Aliyun" : "Tencent";
        sms.EnableFailover = !isDevelopment; // å¼€å‘ç¯å¢ƒå…³é—­æ•…éšœè½¬ç§»
        sms.DefaultSignName = isDevelopment ? "æµ‹è¯•åº”ç”¨" : "ç”Ÿäº§åº”ç”¨";
    },
    aliyun => {
        // å¼€å‘ç¯å¢ƒä½¿ç”¨æµ‹è¯•å¯†é’¥ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­£å¼å¯†é’¥
        aliyun.AccessKeyId = isDevelopment
            ? "test-access-key-id"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = isDevelopment
            ? "test-access-key-secret"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_SECRET");
    },
    tencent => {
        tencent.SecretId = isDevelopment
            ? "test-secret-id"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_ID");
        tencent.SecretKey = isDevelopment
            ? "test-secret-key"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = isDevelopment
            ? "test-sdk-app-id"
            : Environment.GetEnvironmentVariable("TENCENT_SMS_SDK_APP_ID");
    }
);
```

## ğŸ›¡ï¸ å®‰å…¨æ€§æœ€ä½³å®è·µ

### 1. å¯†é’¥ç®¡ç†

**âŒ ä¸æ¨èï¼šç¡¬ç¼–ç å¯†é’¥**
```csharp
aliyun.AccessKeyId = "LTAI4FxxxxxxxxxxxxxxhFp4"; // ä¸å®‰å…¨ï¼
```

**âœ… æ¨èï¼šç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡**
```csharp
aliyun.AccessKeyId = Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
// æˆ–ä½¿ç”¨Azure Key Vaultã€AWS Secrets Managerç­‰
```

### 2. é…ç½®æ–‡ä»¶å®‰å…¨

```json
// âŒ ä¸è¦åœ¨appsettings.jsonä¸­å­˜å‚¨å¯†é’¥
{
  "AliyunSms": {
    "AccessKeyId": "actual-key-id"  // ä¸å®‰å…¨ï¼
  }
}

// âœ… ä½¿ç”¨å ä½ç¬¦ï¼Œå®é™…å€¼é€šè¿‡ç¯å¢ƒå˜é‡æä¾›
{
  "AliyunSms": {
    "AccessKeyId": "${ALIYUN_ACCESS_KEY_ID}",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

### 3. è®¿é—®æƒé™æ§åˆ¶

```csharp
// é…ç½®æœ€å°æƒé™åŸåˆ™
public class SecureConfiguration
{
    public static void ConfigureSms(WebApplicationBuilder builder)
    {
        // åªå…è®¸ç‰¹å®šè§’è‰²çš„ç”¨æˆ·è®¿é—®SMSé…ç½®
        builder.Services.AddAuthorization(options =>
        {
            options.AddPolicy("SmsAdmin", policy =>
                policy.RequireRole("Administrator", "SmsOperator"));
        });

        // æ³¨å†ŒSMSæœåŠ¡æ—¶æ·»åŠ å®‰å…¨æ£€æŸ¥
        builder.Services.AddPolySms(builder.Configuration);
    }
}
```

## ğŸ” é…ç½®éªŒè¯

### å¯åŠ¨æ—¶é…ç½®éªŒè¯

```csharp
builder.Services.PostConfigure<SmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.DefaultProvider))
    {
        throw new InvalidOperationException("DefaultProvider must be specified");
    }

    if (!new[] { "Aliyun", "Tencent" }.Contains(options.DefaultProvider))
    {
        throw new InvalidOperationException($"Invalid DefaultProvider: {options.DefaultProvider}");
    }
});

builder.Services.PostConfigure<AliyunSmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.AccessKeyId) || string.IsNullOrEmpty(options.AccessKeySecret))
    {
        throw new InvalidOperationException("Aliyun AccessKeyId and AccessKeySecret must be provided");
    }
});
```

### è¿è¡Œæ—¶é…ç½®è¯Šæ–­

```csharp
public class SmsConfigurationDiagnostics : IHostedService
{
    private readonly IOptionsMonitor<SmsOptions> _smsOptions;
    private readonly IOptionsMonitor<AliyunSmsOptions> _aliyunOptions;
    private readonly IOptionsMonitor<TencentSmsOptions> _tencentOptions;
    private readonly ILogger<SmsConfigurationDiagnostics> _logger;

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        var smsConfig = _smsOptions.CurrentValue;
        _logger.LogInformation("SMSé…ç½®è¯Šæ–­:");
        _logger.LogInformation("- é»˜è®¤æä¾›å•†: {DefaultProvider}", smsConfig.DefaultProvider);
        _logger.LogInformation("- æ•…éšœè½¬ç§»: {EnableFailover}", smsConfig.EnableFailover);
        _logger.LogInformation("- æä¾›å•†ä¼˜å…ˆçº§: {Priority}", string.Join(", ", smsConfig.ProviderPriority));

        // éªŒè¯å¿…è¦çš„é…ç½®é¡¹
        if (smsConfig.ProviderPriority.Contains("Aliyun"))
        {
            var aliyunConfig = _aliyunOptions.CurrentValue;
            var hasValidConfig = !string.IsNullOrEmpty(aliyunConfig.AccessKeyId) &&
                               !string.IsNullOrEmpty(aliyunConfig.AccessKeySecret);
            _logger.LogInformation("- é˜¿é‡Œäº‘é…ç½®: {Status}", hasValidConfig ? "âœ… æœ‰æ•ˆ" : "âŒ æ— æ•ˆ");
        }

        if (smsConfig.ProviderPriority.Contains("Tencent"))
        {
            var tencentConfig = _tencentOptions.CurrentValue;
            var hasValidConfig = !string.IsNullOrEmpty(tencentConfig.SecretId) &&
                               !string.IsNullOrEmpty(tencentConfig.SecretKey) &&
                               !string.IsNullOrEmpty(tencentConfig.SmsSdkAppId);
            _logger.LogInformation("- è…¾è®¯äº‘é…ç½®: {Status}", hasValidConfig ? "âœ… æœ‰æ•ˆ" : "âŒ æ— æ•ˆ");
        }
    }

    public Task StopAsync(CancellationToken cancellationToken) => Task.CompletedTask;
}

// æ³¨å†Œè¯Šæ–­æœåŠ¡
builder.Services.AddHostedService<SmsConfigurationDiagnostics>();
```

## â“ å¸¸è§é…ç½®é—®é¢˜

### Q: å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„æä¾›å•†ï¼Ÿ

**A:** ä½¿ç”¨ç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼š

```json
// appsettings.Development.json - å¼€å‘ç¯å¢ƒç”¨é˜¿é‡Œäº‘
{
  "Sms": {
    "DefaultProvider": "Aliyun"
  }
}

// appsettings.Production.json - ç”Ÿäº§ç¯å¢ƒç”¨è…¾è®¯äº‘
{
  "Sms": {
    "DefaultProvider": "Tencent"
  }
}
```

### Q: é…ç½®æ›´æ–°åéœ€è¦é‡å¯åº”ç”¨å—ï¼Ÿ

**A:** ä¸éœ€è¦ã€‚PolySmsä½¿ç”¨`IOptionsSnapshot`ï¼Œæ”¯æŒé…ç½®çƒ­æ›´æ–°ï¼š

```csharp
// é…ç½®ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ï¼Œæ— éœ€é‡å¯åº”ç”¨
public class SmsController : ControllerBase
{
    private readonly IOptionsSnapshot<SmsOptions> _options;

    // æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè·å–æœ€æ–°é…ç½®
    public async Task<IActionResult> Send()
    {
        var currentConfig = _options.Value; // è·å–æœ€æ–°é…ç½®
        // ...
    }
}
```

### Q: å¦‚ä½•å®ç°A/Bæµ‹è¯•é…ç½®ï¼Ÿ

**A:** ä½¿ç”¨æ¡ä»¶é…ç½®æˆ–Feature Flagsï¼š

```csharp
// ä½¿ç”¨Feature Flags
builder.Services.AddFeatureManagement();

builder.Services.AddPolySms(sms =>
{
    var featureManager = builder.Services.BuildServiceProvider()
        .GetRequiredService<IFeatureManager>();

    sms.DefaultProvider = featureManager.IsEnabledAsync("UseTencentSms").Result
        ? "Tencent"
        : "Aliyun";
});
```

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹é…ç½®é¡¹ï¼š

### âœ… åŸºç¡€é…ç½®
- [ ] `DefaultProvider` å·²è®¾ç½®ä¸”æœ‰æ•ˆ
- [ ] å¿…è¦çš„æä¾›å•†å¯†é’¥å·²é…ç½®
- [ ] `EnableFailover` æ ¹æ®ç¯å¢ƒéœ€æ±‚è®¾ç½®
- [ ] `ProviderPriority` é¡ºåºç¬¦åˆä¸šåŠ¡éœ€æ±‚

### âœ… å®‰å…¨é…ç½®
- [ ] ç”Ÿäº§ç¯å¢ƒæœªç¡¬ç¼–ç å¯†é’¥
- [ ] ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡å·²é…ç½®
- [ ] é…ç½®æ–‡ä»¶æœªåŒ…å«æ•æ„Ÿä¿¡æ¯
- [ ] è®¿é—®æƒé™å·²æ­£ç¡®è®¾ç½®

### âœ… ç›‘æ§é…ç½®
- [ ] æ—¥å¿—çº§åˆ«é€‚åˆç¯å¢ƒ
- [ ] é…ç½®è¯Šæ–­å·²å¯ç”¨
- [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
- [ ] é”™è¯¯å¤„ç†ç­–ç•¥å·²è®¾ç½®

ä½¿ç”¨æ­¤é…ç½®æŒ‡å—ï¼Œæ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚çµæ´»é…ç½®PolySmsï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚