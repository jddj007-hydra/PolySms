# PolySms é…ç½®è¯´æ˜æ–‡æ¡£

## æ¦‚è¿°

PolySmsæ”¯æŒå¤šç§çµæ´»çš„é…ç½®æ–¹å¼ï¼Œæ‚¨å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚å’Œéƒ¨ç½²ç¯å¢ƒé€‰æ‹©æœ€é€‚åˆçš„é…ç½®æ–¹æ³•ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å„ç§é…ç½®é€‰é¡¹ã€æœ€ä½³å®è·µå’Œå®‰å…¨å»ºè®®ã€‚

## ğŸ› ï¸ é…ç½®æ–¹å¼å¯¹æ¯”

| é…ç½®æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | å®‰å…¨æ€§ |
|----------|----------|------|--------|
| **ä»£ç é…ç½®** | å¼€å‘/æµ‹è¯•ç¯å¢ƒ | ç®€å•ç›´æ¥ | âš ï¸ ä¸­ç­‰ |
| **appsettings.json** | å°å‹é¡¹ç›® | .NETæ ‡å‡†æ–¹å¼ | âš ï¸ ä¸­ç­‰ |
| **è‡ªå®šä¹‰é…ç½®æ–‡ä»¶** | ç”Ÿäº§ç¯å¢ƒ | ç‹¬ç«‹ç®¡ç† | âœ… é«˜ |
| **ç¯å¢ƒå˜é‡** | å®¹å™¨åŒ–éƒ¨ç½² | äº‘åŸç”Ÿå‹å¥½ | âœ… é«˜ |
| **Azure Key Vault** | ä¼ä¸šçº§éƒ¨ç½² | æœ€é«˜å®‰å…¨æ€§ | ğŸ”’ æœ€é«˜ |

## ğŸ“‹ é…ç½®é€‰é¡¹è¯¦è§£

### æ ¸å¿ƒé…ç½® (SmsOptions)

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",           // é»˜è®¤æä¾›å•†ï¼šAliyun | Tencent
    "EnableFailover": true,               // æ˜¯å¦å¯ç”¨æ•…éšœè½¬ç§»
    "ProviderPriority": ["Aliyun", "Tencent"]  // æä¾›å•†ä¼˜å…ˆçº§é¡ºåº
  }
}
```

**é€‰é¡¹è¯´æ˜ï¼š**

- **DefaultProvider**: é»˜è®¤ä½¿ç”¨çš„çŸ­ä¿¡æä¾›å•†
  - å¯é€‰å€¼ï¼š`"Aliyun"`ã€`"Tencent"`
  - é»˜è®¤å€¼ï¼š`"Aliyun"`

- **EnableFailover**: æ•…éšœè½¬ç§»å¼€å…³
  - `true`: ä¸»æä¾›å•†å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æä¾›å•†
  - `false`: ä¸å¯ç”¨æ•…éšœè½¬ç§»ï¼Œåªä½¿ç”¨æŒ‡å®šçš„æä¾›å•†
  - é»˜è®¤å€¼ï¼š`true`

- **ProviderPriority**: æä¾›å•†å°è¯•é¡ºåº
  - æ•°ç»„å½¢å¼ï¼ŒæŒ‰é¡ºåºå°è¯•
  - åªæœ‰åœ¨`EnableFailover=true`æ—¶ç”Ÿæ•ˆ
  - é»˜è®¤å€¼ï¼š`["Aliyun", "Tencent"]`

### é˜¿é‡Œäº‘é…ç½® (AliyunSmsOptions)

```json
{
  "AliyunSms": {
    "AccessKeyId": "your-access-key-id",
    "AccessKeySecret": "your-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

**é€‰é¡¹è¯´æ˜ï¼š**

- **AccessKeyId**: é˜¿é‡Œäº‘è®¿é—®å¯†é’¥ID ï¼ˆå¿…å¡«ï¼‰
- **AccessKeySecret**: é˜¿é‡Œäº‘è®¿é—®å¯†é’¥Secret ï¼ˆå¿…å¡«ï¼‰
- **Endpoint**: APIç«¯ç‚¹åœ°å€
  - é»˜è®¤å€¼ï¼š`"dysmsapi.aliyuncs.com"`
  - ä¸€èˆ¬æ— éœ€ä¿®æ”¹

### è…¾è®¯äº‘é…ç½® (TencentSmsOptions)

```json
{
  "TencentSms": {
    "SecretId": "your-secret-id",
    "SecretKey": "your-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

**é€‰é¡¹è¯´æ˜ï¼š**

- **SecretId**: è…¾è®¯äº‘å¯†é’¥ID ï¼ˆå¿…å¡«ï¼‰
- **SecretKey**: è…¾è®¯äº‘å¯†é’¥Key ï¼ˆå¿…å¡«ï¼‰
- **SmsSdkAppId**: çŸ­ä¿¡åº”ç”¨ID ï¼ˆå¿…å¡«ï¼‰
- **Region**: åœ°åŸŸè®¾ç½®
  - å¯é€‰å€¼ï¼š`"ap-beijing"`ã€`"ap-guangzhou"`ã€`"ap-nanjing"`ç­‰
  - é»˜è®¤å€¼ï¼š`"ap-beijing"`

## ğŸ”§ é…ç½®æ–¹æ³•è¯¦è§£

### æ–¹æ³•1: ä»£ç é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒæ¨èï¼‰

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };
    },
    aliyun => {
        aliyun.AccessKeyId = "LTAIxxxxxxxxxxxxx";
        aliyun.AccessKeySecret = "xxxxxxxxxxxxxxxxxxxxxxx";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "AKIDxxxxxxxxxxxxxx";
        tencent.SecretKey = "xxxxxxxxxxxxxxxxxxxxxxx";
        tencent.SmsSdkAppId = "1400000000";
        tencent.Region = "ap-beijing";
    }
);

var app = builder.Build();
```

**ä¼˜åŠ¿ï¼š**
- ç®€å•ç›´æ¥ï¼Œé€‚åˆå¿«é€Ÿå¼€å‘
- ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- æ˜“äºè°ƒè¯•

**åŠ£åŠ¿ï¼š**
- æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ

### æ–¹æ³•2: appsettings.jsoné…ç½®

**appsettings.json:**
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "LTAIxxxxxxxxxxxxx",
    "AccessKeySecret": "xxxxxxxxxxxxxxxxxxxxxxx",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "AKIDxxxxxxxxxxxxxx",
    "SecretKey": "xxxxxxxxxxxxxxxxxxxxxxx",
    "SmsSdkAppId": "1400000000",
    "Region": "ap-beijing"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Information"
    }
  }
}
```

**Program.cs:**
```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ä»é…ç½®æ–‡ä»¶è¯»å–
builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

### æ–¹æ³•3: è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰

**config/sms.json:**
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "LTAIxxxxxxxxxxxxx",
    "AccessKeySecret": "xxxxxxxxxxxxxxxxxxxxxxx"
  },
  "TencentSms": {
    "SecretId": "AKIDxxxxxxxxxxxxxx",
    "SecretKey": "xxxxxxxxxxxxxxxxxxxxxxx",
    "SmsSdkAppId": "1400000000"
  }
}
```

**Program.cs:**
```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ä»è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è¯»å–
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

var app = builder.Build();
```

**ä¼˜åŠ¿ï¼š**
- ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç®¡ç†
- å¯ä»¥è®¾ç½®ä¸åŒçš„æ–‡ä»¶æƒé™
- ä¾¿äºCI/CDæµç¨‹ä¸­çš„é…ç½®ç®¡ç†

### æ–¹æ³•4: ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå®¹å™¨åŒ–æ¨èï¼‰

**è®¾ç½®ç¯å¢ƒå˜é‡:**
```bash
# Linux/macOS
export Sms__DefaultProvider="Aliyun"
export Sms__EnableFailover="true"
export AliyunSms__AccessKeyId="LTAIxxxxxxxxxxxxx"
export AliyunSms__AccessKeySecret="xxxxxxxxxxxxxxxxxxxxxxx"
export TencentSms__SecretId="AKIDxxxxxxxxxxxxxx"
export TencentSms__SecretKey="xxxxxxxxxxxxxxxxxxxxxxx"
export TencentSms__SmsSdkAppId="1400000000"

# Windows
set Sms__DefaultProvider=Aliyun
set Sms__EnableFailover=true
set AliyunSms__AccessKeyId=LTAIxxxxxxxxxxxxx
set AliyunSms__AccessKeySecret=xxxxxxxxxxxxxxxxxxxxxxx
```

**Docker Compose:**
```yaml
version: '3.8'
services:
  myapp:
    image: myapp:latest
    environment:
      - Sms__DefaultProvider=Aliyun
      - Sms__EnableFailover=true
      - AliyunSms__AccessKeyId=${ALIYUN_ACCESS_KEY_ID}
      - AliyunSms__AccessKeySecret=${ALIYUN_ACCESS_KEY_SECRET}
      - TencentSms__SecretId=${TENCENT_SECRET_ID}
      - TencentSms__SecretKey=${TENCENT_SECRET_KEY}
      - TencentSms__SmsSdkAppId=${TENCENT_SMS_SDK_APP_ID}
```

**Program.cs:**
```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨è¢«.NETé…ç½®ç³»ç»Ÿè¯»å–
builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

### æ–¹æ³•5: Azure Key Vaulté›†æˆï¼ˆä¼ä¸šçº§æ¨èï¼‰

**Program.cs:**
```csharp
using Azure.Identity;
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// æ·»åŠ Azure Key Vaulté…ç½®æº
builder.Configuration.AddAzureKeyVault(
    new Uri("https://your-keyvault.vault.azure.net/"),
    new DefaultAzureCredential());

builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

**Key Vaultä¸­çš„å¯†é’¥å‘½å:**
```
AliyunSms--AccessKeyId
AliyunSms--AccessKeySecret
TencentSms--SecretId
TencentSms--SecretKey
TencentSms--SmsSdkAppId
```

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

### 1. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

```csharp
// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
builder.Services.AddPolySms(
    sms => { },
    aliyun => {
        aliyun.AccessKeyId = "LTAI4FmxxxxxxxxxxxxD4";  // ä¸è¦è¿™æ ·åšï¼
        aliyun.AccessKeySecret = "kLQxxxxxxxxxxxxxxx5k";  // ä¸è¦è¿™æ ·åšï¼
    },
    tencent => { }
);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®ç³»ç»Ÿ
builder.Services.AddPolySms(builder.Configuration);
```

### 2. é…ç½®æ–‡ä»¶æƒé™è®¾ç½®

```bash
# Linuxæ–‡ä»¶æƒé™è®¾ç½®
chmod 600 config/sms.json  # åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chown appuser:appgroup config/sms.json

# æ·»åŠ åˆ°.gitignore
echo "config/sms.json" >> .gitignore
echo "appsettings.Production.json" >> .gitignore
```

### 3. ä¸åŒç¯å¢ƒçš„é…ç½®åˆ†ç¦»

```
é¡¹ç›®ç»“æ„ï¼š
â”œâ”€â”€ appsettings.json                    # åŸºç¡€é…ç½®
â”œâ”€â”€ appsettings.Development.json        # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ appsettings.Staging.json           # æµ‹è¯•ç¯å¢ƒé…ç½®
â”œâ”€â”€ appsettings.Production.json        # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
â””â”€â”€ config/
    â”œâ”€â”€ sms.development.json
    â”œâ”€â”€ sms.staging.json
    â””â”€â”€ sms.production.json            # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
```

## ğŸ“ é…ç½®éªŒè¯

### è¿è¡Œæ—¶é…ç½®éªŒè¯

```csharp
public class SmsOptionsValidator : IValidateOptions<SmsOptions>
{
    public ValidateOptionsResult Validate(string name, SmsOptions options)
    {
        var errors = new List<string>();

        if (string.IsNullOrEmpty(options.DefaultProvider))
            errors.Add("DefaultProvider is required");

        if (options.ProviderPriority == null || !options.ProviderPriority.Any())
            errors.Add("ProviderPriority must contain at least one provider");

        return errors.Count > 0
            ? ValidateOptionsResult.Fail(errors)
            : ValidateOptionsResult.Success;
    }
}

// æ³¨å†ŒéªŒè¯å™¨
builder.Services.AddSingleton<IValidateOptions<SmsOptions>, SmsOptionsValidator>();
```

### å¯åŠ¨æ—¶é…ç½®æ£€æŸ¥

```csharp
public class ConfigurationHealthCheck : IHealthCheck
{
    private readonly IOptions<AliyunSmsOptions> _aliyunOptions;
    private readonly IOptions<TencentSmsOptions> _tencentOptions;

    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        var errors = new List<string>();

        if (string.IsNullOrEmpty(_aliyunOptions.Value.AccessKeyId))
            errors.Add("Aliyun AccessKeyId is not configured");

        if (string.IsNullOrEmpty(_tencentOptions.Value.SecretId))
            errors.Add("Tencent SecretId is not configured");

        return errors.Count == 0
            ? HealthCheckResult.Healthy()
            : HealthCheckResult.Unhealthy(string.Join("; ", errors));
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–é…ç½®

### HTTPå®¢æˆ·ç«¯é…ç½®

```csharp
builder.Services.AddHttpClient<IHttpSmsClient, HttpSmsClient>(client =>
{
    client.Timeout = TimeSpan.FromSeconds(30);
    client.DefaultRequestHeaders.Add("User-Agent", "PolySms/1.0.0");
})
.ConfigurePrimaryHttpMessageHandler(() =>
{
    return new HttpClientHandler
    {
        MaxConnectionsPerServer = 10,
        UseCookies = false,
        UseProxy = false
    };
});
```

### æ—¥å¿—é…ç½®ä¼˜åŒ–

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "PolySms.Services": "Information",
      "PolySms.Providers": "Warning",
      "PolySms.Providers.Http": "Error"
    }
  }
}
```

## ğŸ“Š é…ç½®ç›‘æ§

### é…ç½®å˜æ›´ç›‘å¬

```csharp
public class SmsConfigurationMonitor : IHostedService
{
    private readonly IOptionsMonitor<SmsOptions> _optionsMonitor;
    private readonly ILogger<SmsConfigurationMonitor> _logger;
    private IDisposable? _listener;

    public Task StartAsync(CancellationToken cancellationToken)
    {
        _listener = _optionsMonitor.OnChange((options, name) =>
        {
            _logger.LogInformation("SMS configuration changed: DefaultProvider={DefaultProvider}",
                options.DefaultProvider);
        });

        return Task.CompletedTask;
    }

    public Task StopAsync(CancellationToken cancellationToken)
    {
        _listener?.Dispose();
        return Task.CompletedTask;
    }
}
```

## ğŸ”„ ä»PolySmsè¿ç§»é…ç½®

### é…ç½®æ–‡ä»¶è¿ç§»

```diff
// æ—§çš„æœåŠ¡æ³¨å†Œæ–¹å¼
- builder.Services.AddMergeSms(builder.Configuration)
-                 .AddAliyunSms(builder.Configuration)
-                 .AddTencentSms(builder.Configuration);

// æ–°çš„æœåŠ¡æ³¨å†Œæ–¹å¼
+ builder.Services.AddPolySms(builder.Configuration);

// é…ç½®æ–‡ä»¶æ ¼å¼ä¿æŒä¸å˜ï¼Œæ— éœ€ä¿®æ”¹ï¼
```

### å‘½åç©ºé—´è¿ç§»

```diff
- using PolySms.Core.Extensions;
+ using PolySms.Extensions;
```

é…ç½®æ–‡ä»¶çš„JSONç»“æ„å®Œå…¨ä¿æŒå…¼å®¹ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ï¼

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] æ‰€æœ‰å¿…å¡«é…ç½®é¡¹å·²è®¾ç½®
- [ ] æ•æ„Ÿä¿¡æ¯æœªç¡¬ç¼–ç åœ¨æºä»£ç ä¸­
- [ ] é…ç½®æ–‡ä»¶æƒé™å·²æ­£ç¡®è®¾ç½®
- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶å·²æ’é™¤åœ¨ç‰ˆæœ¬æ§åˆ¶å¤–
- [ ] é…ç½®éªŒè¯å™¨å·²æ³¨å†Œå¹¶æµ‹è¯•
- [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
- [ ] æ—¥å¿—çº§åˆ«å·²é€‚å½“è®¾ç½®
- [ ] ä¸åŒç¯å¢ƒçš„é…ç½®å·²åˆ†ç¦»

å®Œæ•´çš„é…ç½®ä¸ºPolySmsæä¾›äº†å¼ºå¤§çš„çµæ´»æ€§å’Œå®‰å…¨æ€§ä¿éšœï¼