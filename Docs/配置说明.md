# PolySms 配置说明文档

## 概述

PolySms支持多种灵活的配置方式，您可以根据项目需求和部署环境选择最适合的配置方法。本文档详细介绍各种配置选项、最佳实践和安全建议。

## 🛠️ 配置方式对比

| 配置方式 | 适用场景 | 优势 | 安全性 |
|----------|----------|------|--------|
| **代码配置** | 开发/测试环境 | 简单直接 | ⚠️ 中等 |
| **appsettings.json** | 小型项目 | .NET标准方式 | ⚠️ 中等 |
| **自定义配置文件** | 生产环境 | 独立管理 | ✅ 高 |
| **环境变量** | 容器化部署 | 云原生友好 | ✅ 高 |
| **Azure Key Vault** | 企业级部署 | 最高安全性 | 🔒 最高 |

## 📋 配置选项详解

### 核心配置 (SmsOptions)

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",           // 默认提供商：Aliyun | Tencent
    "EnableFailover": true,               // 是否启用故障转移
    "ProviderPriority": ["Aliyun", "Tencent"]  // 提供商优先级顺序
  }
}
```

**选项说明：**

- **DefaultProvider**: 默认使用的短信提供商
  - 可选值：`"Aliyun"`、`"Tencent"`
  - 默认值：`"Aliyun"`

- **EnableFailover**: 故障转移开关
  - `true`: 主提供商失败时自动切换到备用提供商
  - `false`: 不启用故障转移，只使用指定的提供商
  - 默认值：`true`

- **ProviderPriority**: 提供商尝试顺序
  - 数组形式，按顺序尝试
  - 只有在`EnableFailover=true`时生效
  - 默认值：`["Aliyun", "Tencent"]`

### 阿里云配置 (AliyunSmsOptions)

```json
{
  "AliyunSms": {
    "AccessKeyId": "your-access-key-id",
    "AccessKeySecret": "your-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

**选项说明：**

- **AccessKeyId**: 阿里云访问密钥ID （必填）
- **AccessKeySecret**: 阿里云访问密钥Secret （必填）
- **Endpoint**: API端点地址
  - 默认值：`"dysmsapi.aliyuncs.com"`
  - 一般无需修改

### 腾讯云配置 (TencentSmsOptions)

```json
{
  "TencentSms": {
    "SecretId": "your-secret-id",
    "SecretKey": "your-secret-key",
    "Region": "ap-beijing",
    "SmsSdkAppId": "your-sms-sdk-app-id"
  }
}
```

**选项说明：**

- **SecretId**: 腾讯云密钥ID （必填）
- **SecretKey**: 腾讯云密钥Key （必填）
- **SmsSdkAppId**: 短信应用ID （必填）
- **Region**: 地域设置
  - 可选值：`"ap-beijing"`、`"ap-guangzhou"`、`"ap-nanjing"`等
  - 默认值：`"ap-beijing"`

## 🔧 配置方法详解

### 方法1: 代码配置（开发环境推荐）

```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };
    },
    aliyun => {
        aliyun.AccessKeyId = "LTAIxxxxxxxxxxxxx";
        aliyun.AccessKeySecret = "xxxxxxxxxxxxxxxxxxxxxxx";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "AKIDxxxxxxxxxxxxxx";
        tencent.SecretKey = "xxxxxxxxxxxxxxxxxxxxxxx";
        tencent.SmsSdkAppId = "1400000000";
        tencent.Region = "ap-beijing";
    }
);

var app = builder.Build();
```

**优势：**
- 简单直接，适合快速开发
- 类型安全，编译时检查
- 易于调试

**劣势：**
- 敏感信息硬编码在代码中
- 不适合生产环境

### 方法2: appsettings.json配置

**appsettings.json:**
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "LTAIxxxxxxxxxxxxx",
    "AccessKeySecret": "xxxxxxxxxxxxxxxxxxxxxxx",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "AKIDxxxxxxxxxxxxxx",
    "SecretKey": "xxxxxxxxxxxxxxxxxxxxxxx",
    "SmsSdkAppId": "1400000000",
    "Region": "ap-beijing"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Information"
    }
  }
}
```

**Program.cs:**
```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// 从配置文件读取
builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

### 方法3: 自定义配置文件（生产环境推荐）

**config/sms.json:**
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "LTAIxxxxxxxxxxxxx",
    "AccessKeySecret": "xxxxxxxxxxxxxxxxxxxxxxx"
  },
  "TencentSms": {
    "SecretId": "AKIDxxxxxxxxxxxxxx",
    "SecretKey": "xxxxxxxxxxxxxxxxxxxxxxx",
    "SmsSdkAppId": "1400000000"
  }
}
```

**Program.cs:**
```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// 从自定义配置文件读取
builder.Services.AddPolySmsFromConfigFile("config/sms.json");

var app = builder.Build();
```

**优势：**
- 独立的配置文件，便于管理
- 可以设置不同的文件权限
- 便于CI/CD流程中的配置管理

### 方法4: 环境变量配置（容器化推荐）

**设置环境变量:**
```bash
# Linux/macOS
export Sms__DefaultProvider="Aliyun"
export Sms__EnableFailover="true"
export AliyunSms__AccessKeyId="LTAIxxxxxxxxxxxxx"
export AliyunSms__AccessKeySecret="xxxxxxxxxxxxxxxxxxxxxxx"
export TencentSms__SecretId="AKIDxxxxxxxxxxxxxx"
export TencentSms__SecretKey="xxxxxxxxxxxxxxxxxxxxxxx"
export TencentSms__SmsSdkAppId="1400000000"

# Windows
set Sms__DefaultProvider=Aliyun
set Sms__EnableFailover=true
set AliyunSms__AccessKeyId=LTAIxxxxxxxxxxxxx
set AliyunSms__AccessKeySecret=xxxxxxxxxxxxxxxxxxxxxxx
```

**Docker Compose:**
```yaml
version: '3.8'
services:
  myapp:
    image: myapp:latest
    environment:
      - Sms__DefaultProvider=Aliyun
      - Sms__EnableFailover=true
      - AliyunSms__AccessKeyId=${ALIYUN_ACCESS_KEY_ID}
      - AliyunSms__AccessKeySecret=${ALIYUN_ACCESS_KEY_SECRET}
      - TencentSms__SecretId=${TENCENT_SECRET_ID}
      - TencentSms__SecretKey=${TENCENT_SECRET_KEY}
      - TencentSms__SmsSdkAppId=${TENCENT_SMS_SDK_APP_ID}
```

**Program.cs:**
```csharp
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// 环境变量会自动被.NET配置系统读取
builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

### 方法5: Azure Key Vault集成（企业级推荐）

**Program.cs:**
```csharp
using Azure.Identity;
using PolySms.Extensions;

var builder = WebApplication.CreateBuilder(args);

// 添加Azure Key Vault配置源
builder.Configuration.AddAzureKeyVault(
    new Uri("https://your-keyvault.vault.azure.net/"),
    new DefaultAzureCredential());

builder.Services.AddPolySms(builder.Configuration);

var app = builder.Build();
```

**Key Vault中的密钥命名:**
```
AliyunSms--AccessKeyId
AliyunSms--AccessKeySecret
TencentSms--SecretId
TencentSms--SecretKey
TencentSms--SmsSdkAppId
```

## 🔐 安全最佳实践

### 1. 敏感信息保护

```csharp
// ❌ 错误：硬编码敏感信息
builder.Services.AddPolySms(
    sms => { },
    aliyun => {
        aliyun.AccessKeyId = "LTAI4FmxxxxxxxxxxxxD4";  // 不要这样做！
        aliyun.AccessKeySecret = "kLQxxxxxxxxxxxxxxx5k";  // 不要这样做！
    },
    tencent => { }
);

// ✅ 正确：使用配置系统
builder.Services.AddPolySms(builder.Configuration);
```

### 2. 配置文件权限设置

```bash
# Linux文件权限设置
chmod 600 config/sms.json  # 只有所有者可读写
chown appuser:appgroup config/sms.json

# 添加到.gitignore
echo "config/sms.json" >> .gitignore
echo "appsettings.Production.json" >> .gitignore
```

### 3. 不同环境的配置分离

```
项目结构：
├── appsettings.json                    # 基础配置
├── appsettings.Development.json        # 开发环境配置
├── appsettings.Staging.json           # 测试环境配置
├── appsettings.Production.json        # 生产环境配置（不提交到版本控制）
└── config/
    ├── sms.development.json
    ├── sms.staging.json
    └── sms.production.json            # 生产环境配置（不提交到版本控制）
```

## 📝 配置验证

### 运行时配置验证

```csharp
public class SmsOptionsValidator : IValidateOptions<SmsOptions>
{
    public ValidateOptionsResult Validate(string name, SmsOptions options)
    {
        var errors = new List<string>();

        if (string.IsNullOrEmpty(options.DefaultProvider))
            errors.Add("DefaultProvider is required");

        if (options.ProviderPriority == null || !options.ProviderPriority.Any())
            errors.Add("ProviderPriority must contain at least one provider");

        return errors.Count > 0
            ? ValidateOptionsResult.Fail(errors)
            : ValidateOptionsResult.Success;
    }
}

// 注册验证器
builder.Services.AddSingleton<IValidateOptions<SmsOptions>, SmsOptionsValidator>();
```

### 启动时配置检查

```csharp
public class ConfigurationHealthCheck : IHealthCheck
{
    private readonly IOptions<AliyunSmsOptions> _aliyunOptions;
    private readonly IOptions<TencentSmsOptions> _tencentOptions;

    public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        var errors = new List<string>();

        if (string.IsNullOrEmpty(_aliyunOptions.Value.AccessKeyId))
            errors.Add("Aliyun AccessKeyId is not configured");

        if (string.IsNullOrEmpty(_tencentOptions.Value.SecretId))
            errors.Add("Tencent SecretId is not configured");

        return errors.Count == 0
            ? HealthCheckResult.Healthy()
            : HealthCheckResult.Unhealthy(string.Join("; ", errors));
    }
}
```

## 🚀 性能优化配置

### HTTP客户端配置

```csharp
builder.Services.AddHttpClient<IHttpSmsClient, HttpSmsClient>(client =>
{
    client.Timeout = TimeSpan.FromSeconds(30);
    client.DefaultRequestHeaders.Add("User-Agent", "PolySms/1.0.0");
})
.ConfigurePrimaryHttpMessageHandler(() =>
{
    return new HttpClientHandler
    {
        MaxConnectionsPerServer = 10,
        UseCookies = false,
        UseProxy = false
    };
});
```

### 日志配置优化

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "PolySms.Services": "Information",
      "PolySms.Providers": "Warning",
      "PolySms.Providers.Http": "Error"
    }
  }
}
```

## 📊 配置监控

### 配置变更监听

```csharp
public class SmsConfigurationMonitor : IHostedService
{
    private readonly IOptionsMonitor<SmsOptions> _optionsMonitor;
    private readonly ILogger<SmsConfigurationMonitor> _logger;
    private IDisposable? _listener;

    public Task StartAsync(CancellationToken cancellationToken)
    {
        _listener = _optionsMonitor.OnChange((options, name) =>
        {
            _logger.LogInformation("SMS configuration changed: DefaultProvider={DefaultProvider}",
                options.DefaultProvider);
        });

        return Task.CompletedTask;
    }

    public Task StopAsync(CancellationToken cancellationToken)
    {
        _listener?.Dispose();
        return Task.CompletedTask;
    }
}
```

## 🔄 从PolySms迁移配置

### 配置文件迁移

```diff
// 旧的服务注册方式
- builder.Services.AddMergeSms(builder.Configuration)
-                 .AddAliyunSms(builder.Configuration)
-                 .AddTencentSms(builder.Configuration);

// 新的服务注册方式
+ builder.Services.AddPolySms(builder.Configuration);

// 配置文件格式保持不变，无需修改！
```

### 命名空间迁移

```diff
- using PolySms.Core.Extensions;
+ using PolySms.Extensions;
```

配置文件的JSON结构完全保持兼容，无需任何修改！

## 📋 配置检查清单

部署前请确认以下项目：

- [ ] 所有必填配置项已设置
- [ ] 敏感信息未硬编码在源代码中
- [ ] 配置文件权限已正确设置
- [ ] 生产环境配置文件已排除在版本控制外
- [ ] 配置验证器已注册并测试
- [ ] 健康检查已配置
- [ ] 日志级别已适当设置
- [ ] 不同环境的配置已分离

完整的配置为PolySms提供了强大的灵活性和安全性保障！