# PolySms é…ç½®æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»PolySmsçš„æ‰€æœ‰é…ç½®æ–¹å¼å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿé…ç½®å’Œä½¿ç”¨PolySmsçŸ­ä¿¡æœåŠ¡ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šé…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

åœ¨ `appsettings.json` ä¸­é…ç½®ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "æ‚¨çš„åº”ç”¨"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing",
    "Endpoint": "sms.tencentcloudapi.com"
  }
}
```

åœ¨ `Program.cs` ä¸­æ³¨å†ŒæœåŠ¡ï¼š

```csharp
builder.Services.AddPolySms(builder.Configuration);
```

### æ–¹å¼äºŒï¼šä»£ç é…ç½®

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Aliyun";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Aliyun", "Tencent" };
        sms.DefaultSignName = "æ‚¨çš„åº”ç”¨";
    },
    aliyun => {
        aliyun.AccessKeyId = "your-aliyun-access-key-id";
        aliyun.AccessKeySecret = "your-aliyun-access-key-secret";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "your-tencent-secret-id";
        tencent.SecretKey = "your-tencent-secret-key";
        tencent.SmsSdkAppId = "your-sms-sdk-app-id";
        tencent.Region = "ap-beijing";
        tencent.Endpoint = "sms.tencentcloudapi.com";
    }
);
```

### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

```csharp
[ApiController]
[Route("api/[controller]")]
public class SmsController : ControllerBase
{
    private readonly ISmsService _smsService;

    public SmsController(ISmsService smsService)
    {
        _smsService = smsService;
    }

    [HttpPost("send")]
    public async Task<IActionResult> SendSms([FromBody] SendSmsRequest request)
    {
        var smsRequest = new SmsRequest
        {
            PhoneNumber = request.PhoneNumber,
            TemplateId = request.TemplateId,
            SignName = request.SignName,
            TemplateParams = request.TemplateParams
        };

        var response = await _smsService.SendSmsAsync(smsRequest);

        if (response.IsSuccess)
        {
            return Ok(new
            {
                success = true,
                provider = response.Provider,
                requestId = response.RequestId,
                bizId = response.BizId
            });
        }
        else
        {
            return BadRequest(new
            {
                success = false,
                error = response.FriendlyErrorMessage,
                errorCode = response.StandardErrorCode.ToString()
            });
        }
    }
}
```

## ğŸ›ï¸ é…ç½®æ–¹å¼è¯¦è§£

PolySmsæ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼Œæ‚¨å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆï¼š

| é…ç½®æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|----------|------|------|
| é…ç½®æ–‡ä»¶ | ç”Ÿäº§ç¯å¢ƒã€ä¼ä¸šçº§åº”ç”¨ | æ˜“ç®¡ç†ã€æ”¯æŒå¤šç¯å¢ƒ | éœ€è¦é…ç½®æ–‡ä»¶ |
| ä»£ç é…ç½® | ç®€å•åº”ç”¨ã€å¿«é€ŸåŸå‹ | ä»£ç å³é…ç½®ã€ç±»å‹å®‰å…¨ | ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ |
| ç¯å¢ƒå˜é‡ | å®¹å™¨åŒ–éƒ¨ç½²ã€CI/CD | å®‰å…¨æ€§é«˜ã€éƒ¨ç½²çµæ´» | é…ç½®åˆ†æ•£ |
| æ··åˆé…ç½® | å¤æ‚ä¼ä¸šåº”ç”¨ | çµæ´»æ€§æœ€é«˜ | é…ç½®å¤æ‚ |

### ğŸ“ é…ç½®æ–‡ä»¶æ–¹å¼

#### åŸºç¡€é…ç½®

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "æ‚¨çš„åº”ç”¨"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing",
    "Endpoint": "sms.tencentcloudapi.com"
  }
}
```

#### è‡ªå®šä¹‰é…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `config/sms.json` æ–‡ä»¶ï¼š

```csharp
// ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
builder.Services.AddPolySmsFromConfigFile("config/sms.json");
```

### ğŸ’» ä»£ç é…ç½®æ–¹å¼

```csharp
builder.Services.AddPolySms(
    sms => {
        // åŸºç¡€é…ç½®
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };
        sms.DefaultSignName = "æ‚¨çš„åº”ç”¨";
    },
    aliyun => {
        // é˜¿é‡Œäº‘é…ç½®ï¼ˆä»å®‰å…¨å­˜å‚¨è·å–ï¼‰
        aliyun.AccessKeyId = GetSecret("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = GetSecret("ALIYUN_ACCESS_KEY_SECRET");
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        // è…¾è®¯äº‘é…ç½®
        tencent.SecretId = GetSecret("TENCENT_SECRET_ID");
        tencent.SecretKey = GetSecret("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = GetSecret("TENCENT_SMS_SDK_APP_ID");
        tencent.Region = "ap-beijing";
        tencent.Endpoint = "sms.tencentcloudapi.com";
    }
);

// ä»å®‰å…¨å­˜å‚¨è·å–å¯†é’¥çš„ç¤ºä¾‹æ–¹æ³•
static string GetSecret(string key)
{
    return Environment.GetEnvironmentVariable(key)
           ?? throw new InvalidOperationException($"Missing secret: {key}");
}
```

### ğŸŒ ç¯å¢ƒå˜é‡é…ç½®

PolySmséµå¾ª.NETé…ç½®ç³»ç»Ÿçš„æ ‡å‡†å‘½åçº¦å®šï¼š

```bash
# SMSåŸºç¡€é…ç½®
export Sms__DefaultProvider="Aliyun"
export Sms__EnableFailover="true"
export Sms__DefaultSignName="æ‚¨çš„åº”ç”¨"

# é˜¿é‡Œäº‘é…ç½®
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export AliyunSms__Endpoint="dysmsapi.aliyuncs.com"

# è…¾è®¯äº‘é…ç½®
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
export TencentSms__Region="ap-beijing"
export TencentSms__Endpoint="sms.tencentcloudapi.com"
```

### ğŸ”€ æ··åˆé…ç½®æ–¹å¼

#### é…ç½®æ–‡ä»¶ + ç¯å¢ƒå˜é‡

é€‚ç”¨äºåŸºç¡€é…ç½®ä½¿ç”¨æ–‡ä»¶ï¼Œæ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡çš„åœºæ™¯ï¼š

```json
// appsettings.json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "æ‚¨çš„åº”ç”¨"
  },
  "AliyunSms": {
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "Region": "ap-beijing"
  }
}
```

```bash
# æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡æä¾›
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
```

#### ä»£ç é…ç½® + å¤–éƒ¨å¯†é’¥ç®¡ç†

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = builder.Configuration["Sms:DefaultProvider"] ?? "Aliyun";
        sms.EnableFailover = builder.Configuration.GetValue<bool>("Sms:EnableFailover", true);
        sms.ProviderPriority = builder.Configuration.GetSection("Sms:ProviderPriority")
            .Get<List<string>>() ?? new List<string> { "Aliyun", "Tencent" };
    },
    aliyun => {
        // ä»å¯†é’¥ç®¡ç†æœåŠ¡è·å–
        aliyun.AccessKeyId = builder.Configuration["AliyunAccessKeyId"];
        aliyun.AccessKeySecret = builder.Configuration["AliyunAccessKeySecret"];
        aliyun.Endpoint = builder.Configuration["AliyunSms:Endpoint"] ?? "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = builder.Configuration["TencentSecretId"];
        tencent.SecretKey = builder.Configuration["TencentSecretKey"];
        tencent.SmsSdkAppId = builder.Configuration["TencentSmsSdkAppId"];
        tencent.Region = builder.Configuration["TencentSms:Region"] ?? "ap-beijing";
        tencent.Endpoint = builder.Configuration["TencentSms:Endpoint"] ?? "sms.tencentcloudapi.com";
    }
);
```

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### SMSæ ¸å¿ƒé…ç½® (SmsOptions)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `DefaultProvider` | string | "Aliyun" | é»˜è®¤çŸ­ä¿¡æä¾›å•† |
| `EnableFailover` | bool | false | æ˜¯å¦å¯ç”¨æ•…éšœè½¬ç§» |
| `ProviderPriority` | List&lt;string&gt; | ["Aliyun", "Tencent"] | æä¾›å•†ä¼˜å…ˆçº§ï¼ˆæ•…éšœè½¬ç§»é¡ºåºï¼‰ |
| `DefaultSignName` | string | null | é»˜è®¤çŸ­ä¿¡ç­¾å |

```csharp
public class SmsOptions
{
    /// <summary>
    /// é»˜è®¤æä¾›å•† ("Aliyun" æˆ– "Tencent")
    /// </summary>
    public string DefaultProvider { get; set; } = "Aliyun";

    /// <summary>
    /// å¯ç”¨æ•…éšœè½¬ç§»
    /// </summary>
    public bool EnableFailover { get; set; } = false;

    /// <summary>
    /// æä¾›å•†ä¼˜å…ˆçº§ï¼ˆæ•…éšœè½¬ç§»é¡ºåºï¼‰
    /// </summary>
    public List<string> ProviderPriority { get; set; } = new() { "Aliyun", "Tencent" };

    /// <summary>
    /// é»˜è®¤ç­¾ååç§°ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    public string? DefaultSignName { get; set; }
}
```

### é˜¿é‡Œäº‘é…ç½® (AliyunSmsOptions)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜ |
|------|------|--------|------|------|
| `AccessKeyId` | string | - | âœ… | é˜¿é‡Œäº‘è®¿é—®å¯†é’¥ID |
| `AccessKeySecret` | string | - | âœ… | é˜¿é‡Œäº‘è®¿é—®å¯†é’¥Secret |
| `Endpoint` | string | "dysmsapi.aliyuncs.com" | âŒ | APIç«¯ç‚¹ |

```csharp
public class AliyunSmsOptions
{
    /// <summary>
    /// é˜¿é‡Œäº‘AccessKey ID
    /// </summary>
    public string AccessKeyId { get; set; } = string.Empty;

    /// <summary>
    /// é˜¿é‡Œäº‘AccessKey Secret
    /// </summary>
    public string AccessKeySecret { get; set; } = string.Empty;

    /// <summary>
    /// çŸ­ä¿¡æœåŠ¡APIç«¯ç‚¹
    /// </summary>
    public string Endpoint { get; set; } = "dysmsapi.aliyuncs.com";
}
```

### è…¾è®¯äº‘é…ç½® (TencentSmsOptions)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜ |
|------|------|--------|------|------|
| `SecretId` | string | - | âœ… | è…¾è®¯äº‘å¯†é’¥ID |
| `SecretKey` | string | - | âœ… | è…¾è®¯äº‘å¯†é’¥Key |
| `SmsSdkAppId` | string | - | âœ… | çŸ­ä¿¡åº”ç”¨ID |
| `Region` | string | "ap-beijing" | âŒ | åœ°åŸŸ |
| `Endpoint` | string | "sms.tencentcloudapi.com" | âŒ | APIç«¯ç‚¹ |

```csharp
public class TencentSmsOptions
{
    /// <summary>
    /// è…¾è®¯äº‘SecretId
    /// </summary>
    public string SecretId { get; set; } = string.Empty;

    /// <summary>
    /// è…¾è®¯äº‘SecretKey
    /// </summary>
    public string SecretKey { get; set; } = string.Empty;

    /// <summary>
    /// çŸ­ä¿¡SdkAppId
    /// </summary>
    public string SmsSdkAppId { get; set; } = string.Empty;

    /// <summary>
    /// è…¾è®¯äº‘åœ°åŸŸ
    /// </summary>
    public string Region { get; set; } = "ap-beijing";

    /// <summary>
    /// çŸ­ä¿¡æœåŠ¡APIç«¯ç‚¹
    /// </summary>
    public string Endpoint { get; set; } = "sms.tencentcloudapi.com";
}
```

## ğŸŒ å¤šç¯å¢ƒé…ç½®

### ç¯å¢ƒç‰¹å®šé…ç½®æ–‡ä»¶

#### å¼€å‘ç¯å¢ƒ (`appsettings.Development.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": false,
    "DefaultSignName": "æµ‹è¯•åº”ç”¨"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Debug"
    }
  }
}
```

#### æµ‹è¯•ç¯å¢ƒ (`appsettings.Staging.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Tencent",
    "EnableFailover": true,
    "ProviderPriority": ["Tencent", "Aliyun"],
    "DefaultSignName": "é¢„å‘å¸ƒåº”ç”¨"
  }
}
```

#### ç”Ÿäº§ç¯å¢ƒ (`appsettings.Production.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "ç”Ÿäº§åº”ç”¨"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Warning"
    }
  }
}
```

### åŠ¨æ€ç¯å¢ƒé…ç½®

```csharp
var environment = builder.Environment.EnvironmentName.ToLower();
var configFile = $"config/sms.{environment}.json";

// å¦‚æœç¯å¢ƒç‰¹å®šé…ç½®ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨é»˜è®¤é…ç½®
if (!File.Exists(configFile))
{
    configFile = "config/sms.json";
}

builder.Services.AddPolySmsFromConfigFile(configFile);
```

### æ¡ä»¶é…ç½®

```csharp
// æ ¹æ®ç¯å¢ƒåŠ¨æ€é…ç½®
var isDevelopment = builder.Environment.IsDevelopment();

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = isDevelopment ? "Aliyun" : "Tencent";
        sms.EnableFailover = !isDevelopment; // å¼€å‘ç¯å¢ƒå…³é—­æ•…éšœè½¬ç§»
        sms.DefaultSignName = isDevelopment ? "æµ‹è¯•åº”ç”¨" : "ç”Ÿäº§åº”ç”¨";
    },
    aliyun => {
        // å¼€å‘ç¯å¢ƒä½¿ç”¨æµ‹è¯•å¯†é’¥ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­£å¼å¯†é’¥
        aliyun.AccessKeyId = isDevelopment
            ? "test-access-key-id"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = isDevelopment
            ? "test-access-key-secret"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_SECRET");
    },
    tencent => {
        tencent.SecretId = isDevelopment
            ? "test-secret-id"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_ID");
        tencent.SecretKey = isDevelopment
            ? "test-secret-key"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = isDevelopment
            ? "test-sdk-app-id"
            : Environment.GetEnvironmentVariable("TENCENT_SMS_SDK_APP_ID");
    }
);
```

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. å¯†é’¥ç®¡ç†

**âŒ ä¸æ¨èï¼šç¡¬ç¼–ç å¯†é’¥**
```csharp
aliyun.AccessKeyId = "LTAI4FxxxxxxxxxxxxxxhFp4"; // ä¸å®‰å…¨ï¼
```

**âœ… æ¨èï¼šç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡**
```csharp
aliyun.AccessKeyId = Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
// æˆ–ä½¿ç”¨Azure Key Vaultã€AWS Secrets Managerç­‰
```

### 2. é…ç½®æ–‡ä»¶å®‰å…¨

```json
// âŒ ä¸è¦åœ¨appsettings.jsonä¸­å­˜å‚¨å¯†é’¥
{
  "AliyunSms": {
    "AccessKeyId": "actual-key-id"  // ä¸å®‰å…¨ï¼
  }
}

// âœ… ä½¿ç”¨å ä½ç¬¦ï¼Œå®é™…å€¼é€šè¿‡ç¯å¢ƒå˜é‡æä¾›
{
  "AliyunSms": {
    "AccessKeyId": "${ALIYUN_ACCESS_KEY_ID}",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

### 3. ç‰ˆæœ¬æ§åˆ¶æ’é™¤

**.gitignore**ï¼š
```gitignore
# SMSé…ç½®æ–‡ä»¶
config/sms.local.json
config/sms.production.json
config/**/secrets.json

# æˆ–è€…æ’é™¤æ‰€æœ‰æ•æ„Ÿé…ç½®
config/sms*.json
!config/sms.template.json  # ä¿ç•™æ¨¡æ¿æ–‡ä»¶
```

### 4. é…ç½®æ¨¡æ¿æ–‡ä»¶

åˆ›å»º `config/sms.template.json` ä½œä¸ºé…ç½®æ¨¡æ¿ï¼š

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "REPLACE_WITH_ALIYUN_ACCESS_KEY_ID",
    "AccessKeySecret": "REPLACE_WITH_ALIYUN_ACCESS_KEY_SECRET",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "REPLACE_WITH_TENCENT_SECRET_ID",
    "SecretKey": "REPLACE_WITH_TENCENT_SECRET_KEY",
    "Region": "ap-beijing",
    "SmsSdkAppId": "REPLACE_WITH_SMS_SDK_APP_ID",
    "Endpoint": "sms.tencentcloudapi.com"
  }
}
```

## ğŸ” é…ç½®éªŒè¯å’Œç›‘æ§

### å¯åŠ¨æ—¶é…ç½®éªŒè¯

```csharp
builder.Services.PostConfigure<SmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.DefaultProvider))
    {
        throw new InvalidOperationException("DefaultProvider must be specified");
    }

    if (!new[] { "Aliyun", "Tencent" }.Contains(options.DefaultProvider))
    {
        throw new InvalidOperationException($"Invalid DefaultProvider: {options.DefaultProvider}");
    }
});

builder.Services.PostConfigure<AliyunSmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.AccessKeyId) || string.IsNullOrEmpty(options.AccessKeySecret))
    {
        throw new InvalidOperationException("Aliyun AccessKeyId and AccessKeySecret must be provided");
    }
});
```

### é…ç½®éªŒè¯æœåŠ¡

```csharp
public static class ConfigurationValidator
{
    public static async Task ValidateSmsConfiguration(IServiceProvider services)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        var smsService = services.GetRequiredService<ISmsService>();

        try
        {
            logger.LogInformation("å¼€å§‹éªŒè¯PolySmsé…ç½®...");

            // æ£€æŸ¥å¯ç”¨çš„æä¾›å•†
            var availableProviders = smsService.GetAvailableProviders().ToList();
            logger.LogInformation("å¯ç”¨æä¾›å•†: {Providers}", string.Join(", ", availableProviders));

            foreach (var provider in availableProviders)
            {
                var isAvailable = smsService.IsProviderAvailable(provider);
                logger.LogInformation("æä¾›å•† {Provider}: {Status}",
                    provider, isAvailable ? "âœ… å¯ç”¨" : "âŒ ä¸å¯ç”¨");
            }

            logger.LogInformation("PolySmsé…ç½®éªŒè¯å®Œæˆ");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "PolySmsé…ç½®éªŒè¯å¤±è´¥");
            throw;
        }
    }
}

// åœ¨Program.csä¸­ä½¿ç”¨
var app = builder.Build();

// éªŒè¯é…ç½®
using (var scope = app.Services.CreateScope())
{
    await ConfigurationValidator.ValidateSmsConfiguration(scope.ServiceProvider);
}

app.Run();
```

### å¥åº·æ£€æŸ¥

```csharp
// æ·»åŠ å¥åº·æ£€æŸ¥
builder.Services.AddHealthChecks()
    .AddCheck<SmsHealthCheck>("sms");

// è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
public class SmsHealthCheck : IHealthCheck
{
    private readonly ISmsService _smsService;
    private readonly ILogger<SmsHealthCheck> _logger;

    public SmsHealthCheck(ISmsService smsService, ILogger<SmsHealthCheck> logger)
    {
        _smsService = smsService;
        _logger = logger;
    }

    public Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var availableProviders = _smsService.GetAvailableProviders().ToList();

            if (!availableProviders.Any())
            {
                return Task.FromResult(HealthCheckResult.Unhealthy("æ²¡æœ‰å¯ç”¨çš„çŸ­ä¿¡æä¾›å•†"));
            }

            var healthData = new Dictionary<string, object>
            {
                ["availableProviders"] = availableProviders,
                ["providerCount"] = availableProviders.Count
            };

            return Task.FromResult(HealthCheckResult.Healthy("çŸ­ä¿¡æœåŠ¡æ­£å¸¸", healthData));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "çŸ­ä¿¡æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥");
            return Task.FromResult(HealthCheckResult.Unhealthy("çŸ­ä¿¡æœåŠ¡å¼‚å¸¸", ex));
        }
    }
}
```

### é…ç½®çƒ­é‡è½½

```csharp
// å¯ç”¨é…ç½®æ–‡ä»¶ç›‘å¬å’Œçƒ­é‡è½½
builder.Configuration.AddJsonFile("config/sms.json",
    optional: false,
    reloadOnChange: true);  // æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½

builder.Services.AddPolySms(builder.Configuration);

// ç›‘å¬é…ç½®å˜æ›´
builder.Services.Configure<SmsOptions>(
    builder.Configuration.GetSection("Sms"));

// æ·»åŠ é…ç½®å˜æ›´é€šçŸ¥
builder.Services.AddSingleton<IOptionsMonitor<SmsOptions>, OptionsMonitor<SmsOptions>>();
```

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„æä¾›å•†ï¼Ÿ

**A:** ä½¿ç”¨ç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼š

```json
// appsettings.Development.json - å¼€å‘ç¯å¢ƒç”¨é˜¿é‡Œäº‘
{
  "Sms": {
    "DefaultProvider": "Aliyun"
  }
}

// appsettings.Production.json - ç”Ÿäº§ç¯å¢ƒç”¨è…¾è®¯äº‘
{
  "Sms": {
    "DefaultProvider": "Tencent"
  }
}
```

### Q: é…ç½®æ›´æ–°åéœ€è¦é‡å¯åº”ç”¨å—ï¼Ÿ

**A:** ä¸éœ€è¦ã€‚PolySmsä½¿ç”¨`IOptionsSnapshot`ï¼Œæ”¯æŒé…ç½®çƒ­æ›´æ–°ï¼š

```csharp
// é…ç½®ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ï¼Œæ— éœ€é‡å¯åº”ç”¨
public class SmsController : ControllerBase
{
    private readonly IOptionsSnapshot<SmsOptions> _options;

    // æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè·å–æœ€æ–°é…ç½®
    public async Task<IActionResult> Send()
    {
        var currentConfig = _options.Value; // è·å–æœ€æ–°é…ç½®
        // ...
    }
}
```

### Q: å¦‚ä½•å®ç°A/Bæµ‹è¯•é…ç½®ï¼Ÿ

**A:** ä½¿ç”¨æ¡ä»¶é…ç½®æˆ–Feature Flagsï¼š

```csharp
// ä½¿ç”¨Feature Flags
builder.Services.AddFeatureManagement();

builder.Services.AddPolySms(sms =>
{
    var featureManager = builder.Services.BuildServiceProvider()
        .GetRequiredService<IFeatureManager>();

    sms.DefaultProvider = featureManager.IsEnabledAsync("UseTencentSms").Result
        ? "Tencent"
        : "Aliyun";
});
```

### Q: å¦‚ä½•å¤„ç†é…ç½®æ–‡ä»¶æƒé™é—®é¢˜ï¼Ÿ

**A:** è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™ï¼š

```bash
# Linux/macOS è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 config/sms.json           # åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chown app-user:app-group config/sms.json  # è®¾ç½®æ–‡ä»¶æ‰€æœ‰è€…
```

### Q: é…ç½®æ–‡ä»¶è·¯å¾„æ‰¾ä¸åˆ°æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™ï¼š

```csharp
// æ·»åŠ è°ƒè¯•è¾“å‡º
var configPath = "config/sms.json";
if (!File.Exists(configPath))
{
    throw new FileNotFoundException($"é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°: {configPath}");
}

builder.Services.AddPolySmsFromConfigFile(configPath);
```

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹é…ç½®é¡¹ï¼š

### âœ… åŸºç¡€é…ç½®
- [ ] `DefaultProvider` å·²è®¾ç½®ä¸”æœ‰æ•ˆ
- [ ] å¿…è¦çš„æä¾›å•†å¯†é’¥å·²é…ç½®
- [ ] `EnableFailover` æ ¹æ®ç¯å¢ƒéœ€æ±‚è®¾ç½®
- [ ] `ProviderPriority` é¡ºåºç¬¦åˆä¸šåŠ¡éœ€æ±‚

### âœ… å®‰å…¨é…ç½®
- [ ] ç”Ÿäº§ç¯å¢ƒæœªç¡¬ç¼–ç å¯†é’¥
- [ ] ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡å·²é…ç½®
- [ ] é…ç½®æ–‡ä»¶æœªåŒ…å«æ•æ„Ÿä¿¡æ¯
- [ ] é…ç½®æ–‡ä»¶æƒé™å·²æ­£ç¡®è®¾ç½®

### âœ… ç›‘æ§é…ç½®
- [ ] æ—¥å¿—çº§åˆ«é€‚åˆç¯å¢ƒ
- [ ] é…ç½®éªŒè¯å·²å¯ç”¨
- [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
- [ ] é”™è¯¯å¤„ç†ç­–ç•¥å·²è®¾ç½®

## âš¡ PolySms ä¼˜åŠ¿

### ğŸ“¦ è½»é‡çº§æ¶æ„
- **é›¶ç¬¬ä¸‰æ–¹SDKä¾èµ–**ï¼šæ— éœ€é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘çš„åšé‡SDKåŒ…
- **åŒ…ä½“ç§¯æå°**ï¼šä»ä¼ ç»Ÿçš„50MBå‡å°‘åˆ°çº¦20KBï¼ˆ99.96%å‡å°‘ï¼‰
- **é…ç½®æ›´ç®€å•**ï¼šç»Ÿä¸€çš„é…ç½®æ ¼å¼ï¼Œæ— éœ€åˆ†åˆ«é…ç½®å¤šä¸ªSDK

### ğŸš€ æ€§èƒ½ä¼˜åŠ¿
- **å¯åŠ¨æ›´å¿«**ï¼šæ— éœ€åŠ è½½å¤§å‹SDKç¨‹åºé›†
- **å†…å­˜å ç”¨æ›´å°‘**ï¼šHTTPç›´æ¥è°ƒç”¨ï¼Œå‡å°‘80%å†…å­˜å¼€é”€
- **éƒ¨ç½²ä½“ç§¯æ›´å°**ï¼šDockeré•œåƒå’Œéƒ¨ç½²åŒ…å¤§å¹…å‡å°

### ğŸ”§ æŠ€æœ¯å®ç°
- **HTTPç›´æ¥è°ƒç”¨**ï¼šç»•è¿‡SDKï¼Œç›´æ¥è°ƒç”¨äº‘æœåŠ¡API
- **è‡ªç ”ç­¾åç®—æ³•**ï¼šå†…ç½®é˜¿é‡Œäº‘RPCå’Œè…¾è®¯äº‘TC3-HMAC-SHA256ç­¾å
- **ç»Ÿä¸€æŠ½è±¡æ¥å£**ï¼šä¸ºä¸åŒäº‘å‚å•†æä¾›ä¸€è‡´çš„ä½¿ç”¨ä½“éªŒ
- **æ ‡å‡†åŒ–é”™è¯¯å¤„ç†**ï¼šErrorCodeMapperç»Ÿä¸€å¤„ç†ä¸åŒæä¾›å•†çš„é”™è¯¯ç 

### ğŸ›¡ï¸ å®‰å…¨ä¼˜åŠ¿
- **æ— ç¬¬ä¸‰æ–¹ä¾èµ–é£é™©**ï¼šé¿å…ç¬¬ä¸‰æ–¹SDKçš„å®‰å…¨æ¼æ´
- **è‡ªä¸»å¯æ§**ï¼šæ ¸å¿ƒé€»è¾‘å®Œå…¨è‡ªä¸»å®ç°
- **é€æ˜çš„å®‰å…¨å®ç°**ï¼šå¼€æºä»£ç ï¼Œå®‰å…¨å®ç°å®Œå…¨é€æ˜

ä½¿ç”¨æœ¬é…ç½®æŒ‡å—ï¼Œæ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚çµæ´»é…ç½®PolySmsï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚