# PolySms 配置说明

本文档详细介绍PolySms的所有配置选项和使用方式，帮助您根据不同场景选择最佳的配置方案。

## 🎛️ 配置方式概览

PolySms支持多种配置方式，您可以根据项目需求选择最合适的方案：

| 配置方式 | 适用场景 | 优点 | 缺点 |
|---------|----------|------|------|
| 配置文件 | 生产环境、企业级应用 | 易管理、支持多环境 | 需要配置文件 |
| 代码配置 | 简单应用、快速原型 | 代码即配置、类型安全 | 硬编码敏感信息 |
| 环境变量 | 容器化部署、CI/CD | 安全性高、部署灵活 | 配置分散 |
| 混合配置 | 复杂企业应用 | 灵活性最高 | 配置复杂 |

## 📁 配置文件方式

### 基础配置

在 `appsettings.json` 中配置：

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "您的应用"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing"
  }
}
```

然后在 `Program.cs` 中注册服务：

```csharp
builder.Services.AddPolySms(builder.Configuration);
```

### 多环境配置

#### 开发环境 (`appsettings.Development.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": false,
    "DefaultSignName": "测试应用"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Debug"
    }
  }
}
```

#### 测试环境 (`appsettings.Staging.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Tencent",
    "EnableFailover": true,
    "ProviderPriority": ["Tencent", "Aliyun"],
    "DefaultSignName": "预发布应用"
  }
}
```

#### 生产环境 (`appsettings.Production.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "生产应用"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Warning"
    }
  }
}
```

## 💻 代码配置方式

### 基础代码配置

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Aliyun";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Aliyun", "Tencent" };
        sms.DefaultSignName = "您的应用";
    },
    aliyun => {
        aliyun.AccessKeyId = "your-aliyun-access-key-id";
        aliyun.AccessKeySecret = "your-aliyun-access-key-secret";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "your-tencent-secret-id";
        tencent.SecretKey = "your-tencent-secret-key";
        tencent.SmsSdkAppId = "your-sms-sdk-app-id";
        tencent.Region = "ap-beijing";
    }
);
```

### 高级代码配置

```csharp
builder.Services.AddPolySms(
    sms => {
        // 基础配置
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;

        // 提供商优先级（故障转移顺序）
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };

        // 默认签名（可选，也可以在每次发送时指定）
        sms.DefaultSignName = "您的应用";
    },
    aliyun => {
        // 阿里云配置
        aliyun.AccessKeyId = GetSecret("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = GetSecret("ALIYUN_ACCESS_KEY_SECRET");
        aliyun.Endpoint = "dysmsapi.aliyuncs.com"; // 默认endpoint
    },
    tencent => {
        // 腾讯云配置
        tencent.SecretId = GetSecret("TENCENT_SECRET_ID");
        tencent.SecretKey = GetSecret("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = GetSecret("TENCENT_SMS_SDK_APP_ID");
        tencent.Region = "ap-beijing"; // 默认地域
    }
);

// 从安全存储获取密钥的示例方法
static string GetSecret(string key)
{
    // 可以从Azure Key Vault、AWS Secrets Manager等获取
    return Environment.GetEnvironmentVariable(key)
           ?? throw new InvalidOperationException($"Missing secret: {key}");
}
```

## 🌍 环境变量配置

### 环境变量命名规则

PolySms遵循.NET配置系统的标准命名约定：

```bash
# SMS基础配置
export Sms__DefaultProvider="Aliyun"
export Sms__EnableFailover="true"
export Sms__DefaultSignName="您的应用"

# 阿里云配置
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export AliyunSms__Endpoint="dysmsapi.aliyuncs.com"

# 腾讯云配置
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
export TencentSms__Region="ap-beijing"
```

### Docker环境变量配置

```dockerfile
# Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0
# ... 其他配置

# 设置环境变量
ENV Sms__DefaultProvider=Aliyun
ENV Sms__EnableFailover=true
ENV AliyunSms__AccessKeyId=${ALIYUN_ACCESS_KEY_ID}
ENV AliyunSms__AccessKeySecret=${ALIYUN_ACCESS_KEY_SECRET}
ENV TencentSms__SecretId=${TENCENT_SECRET_ID}
ENV TencentSms__SecretKey=${TENCENT_SECRET_KEY}
ENV TencentSms__SmsSdkAppId=${TENCENT_SMS_SDK_APP_ID}
```

### Docker Compose配置

```yaml
version: '3.8'
services:
  app:
    image: your-app
    environment:
      - Sms__DefaultProvider=Aliyun
      - Sms__EnableFailover=true
      - AliyunSms__AccessKeyId=${ALIYUN_ACCESS_KEY_ID}
      - AliyunSms__AccessKeySecret=${ALIYUN_ACCESS_KEY_SECRET}
      - TencentSms__SecretId=${TENCENT_SECRET_ID}
      - TencentSms__SecretKey=${TENCENT_SECRET_KEY}
      - TencentSms__SmsSdkAppId=${TENCENT_SMS_SDK_APP_ID}
    env_file:
      - .env
```

### Kubernetes ConfigMap和Secret

```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sms-config
data:
  Sms__DefaultProvider: "Aliyun"
  Sms__EnableFailover: "true"
  AliyunSms__Endpoint: "dysmsapi.aliyuncs.com"
  TencentSms__Region: "ap-beijing"

---
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: sms-secrets
type: Opaque
stringData:
  AliyunSms__AccessKeyId: "your-aliyun-access-key-id"
  AliyunSms__AccessKeySecret: "your-aliyun-access-key-secret"
  TencentSms__SecretId: "your-tencent-secret-id"
  TencentSms__SecretKey: "your-tencent-secret-key"
  TencentSms__SmsSdkAppId: "your-sms-sdk-app-id"

---
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: your-app
spec:
  template:
    spec:
      containers:
      - name: app
        image: your-app
        envFrom:
        - configMapRef:
            name: sms-config
        - secretRef:
            name: sms-secrets
```

## 🔀 混合配置方式

### 配置文件 + 环境变量

适用于基础配置使用文件，敏感信息使用环境变量的场景：

```json
// appsettings.json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "您的应用"
  },
  "AliyunSms": {
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "Region": "ap-beijing"
  }
}
```

```bash
# 敏感信息通过环境变量提供
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
```

### 代码配置 + 外部密钥管理

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = builder.Configuration["Sms:DefaultProvider"] ?? "Aliyun";
        sms.EnableFailover = builder.Configuration.GetValue<bool>("Sms:EnableFailover", true);
        sms.ProviderPriority = builder.Configuration.GetSection("Sms:ProviderPriority")
            .Get<List<string>>() ?? new List<string> { "Aliyun", "Tencent" };
    },
    aliyun => {
        // 从Azure Key Vault获取密钥
        aliyun.AccessKeyId = builder.Configuration["AliyunAccessKeyId"];
        aliyun.AccessKeySecret = builder.Configuration["AliyunAccessKeySecret"];
        aliyun.Endpoint = builder.Configuration["AliyunSms:Endpoint"] ?? "dysmsapi.aliyuncs.com";
    },
    tencent => {
        // 从AWS Secrets Manager获取密钥
        tencent.SecretId = builder.Configuration["TencentSecretId"];
        tencent.SecretKey = builder.Configuration["TencentSecretKey"];
        tencent.SmsSdkAppId = builder.Configuration["TencentSmsSdkAppId"];
        tencent.Region = builder.Configuration["TencentSms:Region"] ?? "ap-beijing";
    }
);
```

## ⚙️ 配置参数详解

### SMS核心配置 (SmsOptions)

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `DefaultProvider` | string | "Aliyun" | 默认短信提供商 |
| `EnableFailover` | bool | false | 是否启用故障转移 |
| `ProviderPriority` | List&lt;string&gt; | ["Aliyun", "Tencent"] | 提供商优先级（故障转移顺序） |
| `DefaultSignName` | string | null | 默认短信签名 |

```csharp
public class SmsOptions
{
    /// <summary>
    /// 默认提供商 ("Aliyun" 或 "Tencent")
    /// </summary>
    public string DefaultProvider { get; set; } = "Aliyun";

    /// <summary>
    /// 启用故障转移
    /// </summary>
    public bool EnableFailover { get; set; } = false;

    /// <summary>
    /// 提供商优先级（故障转移顺序）
    /// </summary>
    public List<string> ProviderPriority { get; set; } = new() { "Aliyun", "Tencent" };

    /// <summary>
    /// 默认签名名称（可选）
    /// </summary>
    public string? DefaultSignName { get; set; }
}
```

### 阿里云配置 (AliyunSmsOptions)

| 参数 | 类型 | 默认值 | 必填 | 说明 |
|------|------|--------|------|------|
| `AccessKeyId` | string | - | ✅ | 阿里云访问密钥ID |
| `AccessKeySecret` | string | - | ✅ | 阿里云访问密钥Secret |
| `Endpoint` | string | "dysmsapi.aliyuncs.com" | ❌ | API端点 |

```csharp
public class AliyunSmsOptions
{
    /// <summary>
    /// 阿里云AccessKey ID
    /// </summary>
    public string AccessKeyId { get; set; } = string.Empty;

    /// <summary>
    /// 阿里云AccessKey Secret
    /// </summary>
    public string AccessKeySecret { get; set; } = string.Empty;

    /// <summary>
    /// 短信服务API端点
    /// </summary>
    public string Endpoint { get; set; } = "dysmsapi.aliyuncs.com";
}
```

### 腾讯云配置 (TencentSmsOptions)

| 参数 | 类型 | 默认值 | 必填 | 说明 |
|------|------|--------|------|------|
| `SecretId` | string | - | ✅ | 腾讯云密钥ID |
| `SecretKey` | string | - | ✅ | 腾讯云密钥Key |
| `SmsSdkAppId` | string | - | ✅ | 短信应用ID |
| `Region` | string | "ap-beijing" | ❌ | 地域 |

```csharp
public class TencentSmsOptions
{
    /// <summary>
    /// 腾讯云SecretId
    /// </summary>
    public string SecretId { get; set; } = string.Empty;

    /// <summary>
    /// 腾讯云SecretKey
    /// </summary>
    public string SecretKey { get; set; } = string.Empty;

    /// <summary>
    /// 短信SdkAppId
    /// </summary>
    public string SmsSdkAppId { get; set; } = string.Empty;

    /// <summary>
    /// 腾讯云地域
    /// </summary>
    public string Region { get; set; } = "ap-beijing";
}
```

## 🔧 高级配置场景

### 多租户配置

```csharp
// 注册多个配置实例
builder.Services.Configure<SmsOptions>("tenant1", config =>
{
    config.DefaultProvider = "Aliyun";
    config.DefaultSignName = "租户1";
});

builder.Services.Configure<SmsOptions>("tenant2", config =>
{
    config.DefaultProvider = "Tencent";
    config.DefaultSignName = "租户2";
});

// 使用时通过IOptionsSnapshot获取特定租户配置
public class MultiTenantSmsService
{
    private readonly IOptionsSnapshot<SmsOptions> _options;
    private readonly ISmsService _smsService;

    public MultiTenantSmsService(IOptionsSnapshot<SmsOptions> options, ISmsService smsService)
    {
        _options = options;
        _smsService = smsService;
    }

    public async Task<SmsResponse> SendSmsForTenant(string tenantId, SmsRequest request)
    {
        var tenantOptions = _options.Get(tenantId);

        // 使用租户特定的配置
        if (!string.IsNullOrEmpty(tenantOptions.DefaultSignName))
        {
            request.SignName = tenantOptions.DefaultSignName;
        }

        return await _smsService.SendSmsAsync(request, tenantOptions.DefaultProvider);
    }
}
```

### 动态配置更新

```csharp
// 支持配置热更新
builder.Services.Configure<SmsOptions>(builder.Configuration.GetSection("Sms"));

// 使用IOptionsMonitor监听配置变化
public class ConfigurableSmsService
{
    private readonly IOptionsMonitor<SmsOptions> _options;
    private readonly ISmsService _smsService;
    private readonly ILogger<ConfigurableSmsService> _logger;

    public ConfigurableSmsService(
        IOptionsMonitor<SmsOptions> options,
        ISmsService smsService,
        ILogger<ConfigurableSmsService> logger)
    {
        _options = options;
        _smsService = smsService;
        _logger = logger;

        // 监听配置变化
        _options.OnChange(OnConfigurationChanged);
    }

    private void OnConfigurationChanged(SmsOptions newOptions)
    {
        _logger.LogInformation("SMS配置已更新: DefaultProvider={DefaultProvider}, EnableFailover={EnableFailover}",
            newOptions.DefaultProvider, newOptions.EnableFailover);
    }
}
```

### 条件配置

```csharp
// 根据环境动态配置
var isDevelopment = builder.Environment.IsDevelopment();

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = isDevelopment ? "Aliyun" : "Tencent";
        sms.EnableFailover = !isDevelopment; // 开发环境关闭故障转移
        sms.DefaultSignName = isDevelopment ? "测试应用" : "生产应用";
    },
    aliyun => {
        // 开发环境使用测试密钥，生产环境使用正式密钥
        aliyun.AccessKeyId = isDevelopment
            ? "test-access-key-id"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = isDevelopment
            ? "test-access-key-secret"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_SECRET");
    },
    tencent => {
        tencent.SecretId = isDevelopment
            ? "test-secret-id"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_ID");
        tencent.SecretKey = isDevelopment
            ? "test-secret-key"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = isDevelopment
            ? "test-sdk-app-id"
            : Environment.GetEnvironmentVariable("TENCENT_SMS_SDK_APP_ID");
    }
);
```

## 🛡️ 安全性最佳实践

### 1. 密钥管理

**❌ 不推荐：硬编码密钥**
```csharp
aliyun.AccessKeyId = "LTAI4FxxxxxxxxxxxxxxhFp4"; // 不安全！
```

**✅ 推荐：环境变量或密钥管理服务**
```csharp
aliyun.AccessKeyId = Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
// 或使用Azure Key Vault、AWS Secrets Manager等
```

### 2. 配置文件安全

```json
// ❌ 不要在appsettings.json中存储密钥
{
  "AliyunSms": {
    "AccessKeyId": "actual-key-id"  // 不安全！
  }
}

// ✅ 使用占位符，实际值通过环境变量提供
{
  "AliyunSms": {
    "AccessKeyId": "${ALIYUN_ACCESS_KEY_ID}",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

### 3. 访问权限控制

```csharp
// 配置最小权限原则
public class SecureConfiguration
{
    public static void ConfigureSms(WebApplicationBuilder builder)
    {
        // 只允许特定角色的用户访问SMS配置
        builder.Services.AddAuthorization(options =>
        {
            options.AddPolicy("SmsAdmin", policy =>
                policy.RequireRole("Administrator", "SmsOperator"));
        });

        // 注册SMS服务时添加安全检查
        builder.Services.AddPolySms(builder.Configuration);
    }
}
```

## 🔍 配置验证

### 启动时配置验证

```csharp
builder.Services.PostConfigure<SmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.DefaultProvider))
    {
        throw new InvalidOperationException("DefaultProvider must be specified");
    }

    if (!new[] { "Aliyun", "Tencent" }.Contains(options.DefaultProvider))
    {
        throw new InvalidOperationException($"Invalid DefaultProvider: {options.DefaultProvider}");
    }
});

builder.Services.PostConfigure<AliyunSmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.AccessKeyId) || string.IsNullOrEmpty(options.AccessKeySecret))
    {
        throw new InvalidOperationException("Aliyun AccessKeyId and AccessKeySecret must be provided");
    }
});
```

### 运行时配置诊断

```csharp
public class SmsConfigurationDiagnostics : IHostedService
{
    private readonly IOptionsMonitor<SmsOptions> _smsOptions;
    private readonly IOptionsMonitor<AliyunSmsOptions> _aliyunOptions;
    private readonly IOptionsMonitor<TencentSmsOptions> _tencentOptions;
    private readonly ILogger<SmsConfigurationDiagnostics> _logger;

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        var smsConfig = _smsOptions.CurrentValue;
        _logger.LogInformation("SMS配置诊断:");
        _logger.LogInformation("- 默认提供商: {DefaultProvider}", smsConfig.DefaultProvider);
        _logger.LogInformation("- 故障转移: {EnableFailover}", smsConfig.EnableFailover);
        _logger.LogInformation("- 提供商优先级: {Priority}", string.Join(", ", smsConfig.ProviderPriority));

        // 验证必要的配置项
        if (smsConfig.ProviderPriority.Contains("Aliyun"))
        {
            var aliyunConfig = _aliyunOptions.CurrentValue;
            var hasValidConfig = !string.IsNullOrEmpty(aliyunConfig.AccessKeyId) &&
                               !string.IsNullOrEmpty(aliyunConfig.AccessKeySecret);
            _logger.LogInformation("- 阿里云配置: {Status}", hasValidConfig ? "✅ 有效" : "❌ 无效");
        }

        if (smsConfig.ProviderPriority.Contains("Tencent"))
        {
            var tencentConfig = _tencentOptions.CurrentValue;
            var hasValidConfig = !string.IsNullOrEmpty(tencentConfig.SecretId) &&
                               !string.IsNullOrEmpty(tencentConfig.SecretKey) &&
                               !string.IsNullOrEmpty(tencentConfig.SmsSdkAppId);
            _logger.LogInformation("- 腾讯云配置: {Status}", hasValidConfig ? "✅ 有效" : "❌ 无效");
        }
    }

    public Task StopAsync(CancellationToken cancellationToken) => Task.CompletedTask;
}

// 注册诊断服务
builder.Services.AddHostedService<SmsConfigurationDiagnostics>();
```

## ❓ 常见配置问题

### Q: 如何在不同环境使用不同的提供商？

**A:** 使用环境特定的配置文件：

```json
// appsettings.Development.json - 开发环境用阿里云
{
  "Sms": {
    "DefaultProvider": "Aliyun"
  }
}

// appsettings.Production.json - 生产环境用腾讯云
{
  "Sms": {
    "DefaultProvider": "Tencent"
  }
}
```

### Q: 配置更新后需要重启应用吗？

**A:** 不需要。PolySms使用`IOptionsSnapshot`，支持配置热更新：

```csharp
// 配置会自动重新加载，无需重启应用
public class SmsController : ControllerBase
{
    private readonly IOptionsSnapshot<SmsOptions> _options;

    // 每次请求都会获取最新配置
    public async Task<IActionResult> Send()
    {
        var currentConfig = _options.Value; // 获取最新配置
        // ...
    }
}
```

### Q: 如何实现A/B测试配置？

**A:** 使用条件配置或Feature Flags：

```csharp
// 使用Feature Flags
builder.Services.AddFeatureManagement();

builder.Services.AddPolySms(sms =>
{
    var featureManager = builder.Services.BuildServiceProvider()
        .GetRequiredService<IFeatureManager>();

    sms.DefaultProvider = featureManager.IsEnabledAsync("UseTencentSms").Result
        ? "Tencent"
        : "Aliyun";
});
```

## 📋 配置检查清单

部署前请确认以下配置项：

### ✅ 基础配置
- [ ] `DefaultProvider` 已设置且有效
- [ ] 必要的提供商密钥已配置
- [ ] `EnableFailover` 根据环境需求设置
- [ ] `ProviderPriority` 顺序符合业务需求

### ✅ 安全配置
- [ ] 生产环境未硬编码密钥
- [ ] 环境变量或密钥管理服务已配置
- [ ] 配置文件未包含敏感信息
- [ ] 访问权限已正确设置

### ✅ 监控配置
- [ ] 日志级别适合环境
- [ ] 配置诊断已启用
- [ ] 健康检查已配置
- [ ] 错误处理策略已设置

使用此配置指南，您可以根据具体需求灵活配置PolySms，确保在不同环境下都能正常工作。