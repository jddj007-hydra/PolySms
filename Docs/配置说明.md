# PolySms 配置指南

本指南详细介绍PolySms的所有配置方式和最佳实践，帮助您快速配置和使用PolySms短信服务。

## 🚀 快速开始

### 方式一：配置文件（推荐）

在 `appsettings.json` 中配置：

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "您的应用"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing"
  }
}
```

在 `Program.cs` 中注册服务：

```csharp
builder.Services.AddPolySms(builder.Configuration);
```

### 方式二：代码配置

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = "Aliyun";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Aliyun", "Tencent" };
        sms.DefaultSignName = "您的应用";
    },
    aliyun => {
        aliyun.AccessKeyId = "your-aliyun-access-key-id";
        aliyun.AccessKeySecret = "your-aliyun-access-key-secret";
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = "your-tencent-secret-id";
        tencent.SecretKey = "your-tencent-secret-key";
        tencent.SmsSdkAppId = "your-sms-sdk-app-id";
        tencent.Region = "ap-beijing";
    }
);
```

### 基础使用示例

```csharp
[ApiController]
[Route("api/[controller]")]
public class SmsController : ControllerBase
{
    private readonly ISmsService _smsService;

    public SmsController(ISmsService smsService)
    {
        _smsService = smsService;
    }

    [HttpPost("send")]
    public async Task<IActionResult> SendSms([FromBody] SendSmsRequest request)
    {
        var smsRequest = new SmsRequest
        {
            PhoneNumber = request.PhoneNumber,
            TemplateId = request.TemplateId,
            SignName = request.SignName,
            TemplateParams = request.TemplateParams
        };

        var response = await _smsService.SendSmsAsync(smsRequest);

        if (response.IsSuccess)
        {
            return Ok(new
            {
                success = true,
                provider = response.Provider,
                requestId = response.RequestId,
                bizId = response.BizId
            });
        }
        else
        {
            return BadRequest(new
            {
                success = false,
                error = response.FriendlyErrorMessage,
                errorCode = response.StandardErrorCode.ToString()
            });
        }
    }
}
```

## 🎛️ 配置方式详解

PolySms支持多种配置方式，您可以根据项目需求选择最合适的方案：

| 配置方式 | 适用场景 | 优点 | 缺点 |
|---------|----------|------|------|
| 配置文件 | 生产环境、企业级应用 | 易管理、支持多环境 | 需要配置文件 |
| 代码配置 | 简单应用、快速原型 | 代码即配置、类型安全 | 硬编码敏感信息 |
| 环境变量 | 容器化部署、CI/CD | 安全性高、部署灵活 | 配置分散 |
| 混合配置 | 复杂企业应用 | 灵活性最高 | 配置复杂 |

### 📁 配置文件方式

#### 基础配置

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "您的应用"
  },
  "AliyunSms": {
    "AccessKeyId": "your-aliyun-access-key-id",
    "AccessKeySecret": "your-aliyun-access-key-secret",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "your-tencent-secret-id",
    "SecretKey": "your-tencent-secret-key",
    "SmsSdkAppId": "your-sms-sdk-app-id",
    "Region": "ap-beijing"
  }
}
```

#### 自定义配置文件

在项目根目录下创建 `config/sms.json` 文件：

```csharp
// 使用自定义配置文件
builder.Services.AddPolySmsFromConfigFile("config/sms.json");
```

### 💻 代码配置方式

```csharp
builder.Services.AddPolySms(
    sms => {
        // 基础配置
        sms.DefaultProvider = "Tencent";
        sms.EnableFailover = true;
        sms.ProviderPriority = new List<string> { "Tencent", "Aliyun" };
        sms.DefaultSignName = "您的应用";
    },
    aliyun => {
        // 阿里云配置（从安全存储获取）
        aliyun.AccessKeyId = GetSecret("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = GetSecret("ALIYUN_ACCESS_KEY_SECRET");
        aliyun.Endpoint = "dysmsapi.aliyuncs.com";
    },
    tencent => {
        // 腾讯云配置
        tencent.SecretId = GetSecret("TENCENT_SECRET_ID");
        tencent.SecretKey = GetSecret("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = GetSecret("TENCENT_SMS_SDK_APP_ID");
        tencent.Region = "ap-beijing";
    }
);

// 从安全存储获取密钥的示例方法
static string GetSecret(string key)
{
    return Environment.GetEnvironmentVariable(key)
           ?? throw new InvalidOperationException($"Missing secret: {key}");
}
```

### 🌍 环境变量配置

PolySms遵循.NET配置系统的标准命名约定：

```bash
# SMS基础配置
export Sms__DefaultProvider="Aliyun"
export Sms__EnableFailover="true"
export Sms__DefaultSignName="您的应用"

# 阿里云配置
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export AliyunSms__Endpoint="dysmsapi.aliyuncs.com"

# 腾讯云配置
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
export TencentSms__Region="ap-beijing"
```

### 🔀 混合配置方式

#### 配置文件 + 环境变量

适用于基础配置使用文件，敏感信息使用环境变量的场景：

```json
// appsettings.json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "您的应用"
  },
  "AliyunSms": {
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "Region": "ap-beijing"
  }
}
```

```bash
# 敏感信息通过环境变量提供
export AliyunSms__AccessKeyId="your-aliyun-access-key-id"
export AliyunSms__AccessKeySecret="your-aliyun-access-key-secret"
export TencentSms__SecretId="your-tencent-secret-id"
export TencentSms__SecretKey="your-tencent-secret-key"
export TencentSms__SmsSdkAppId="your-sms-sdk-app-id"
```

#### 代码配置 + 外部密钥管理

```csharp
builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = builder.Configuration["Sms:DefaultProvider"] ?? "Aliyun";
        sms.EnableFailover = builder.Configuration.GetValue<bool>("Sms:EnableFailover", true);
        sms.ProviderPriority = builder.Configuration.GetSection("Sms:ProviderPriority")
            .Get<List<string>>() ?? new List<string> { "Aliyun", "Tencent" };
    },
    aliyun => {
        // 从密钥管理服务获取
        aliyun.AccessKeyId = builder.Configuration["AliyunAccessKeyId"];
        aliyun.AccessKeySecret = builder.Configuration["AliyunAccessKeySecret"];
        aliyun.Endpoint = builder.Configuration["AliyunSms:Endpoint"] ?? "dysmsapi.aliyuncs.com";
    },
    tencent => {
        tencent.SecretId = builder.Configuration["TencentSecretId"];
        tencent.SecretKey = builder.Configuration["TencentSecretKey"];
        tencent.SmsSdkAppId = builder.Configuration["TencentSmsSdkAppId"];
        tencent.Region = builder.Configuration["TencentSms:Region"] ?? "ap-beijing";
    }
);
```

## ⚙️ 配置参数详解

### SMS核心配置 (SmsOptions)

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `DefaultProvider` | string | "Aliyun" | 默认短信提供商 |
| `EnableFailover` | bool | false | 是否启用故障转移 |
| `ProviderPriority` | List&lt;string&gt; | ["Aliyun", "Tencent"] | 提供商优先级（故障转移顺序） |
| `DefaultSignName` | string | null | 默认短信签名 |

```csharp
public class SmsOptions
{
    /// <summary>
    /// 默认提供商 ("Aliyun" 或 "Tencent")
    /// </summary>
    public string DefaultProvider { get; set; } = "Aliyun";

    /// <summary>
    /// 启用故障转移
    /// </summary>
    public bool EnableFailover { get; set; } = false;

    /// <summary>
    /// 提供商优先级（故障转移顺序）
    /// </summary>
    public List<string> ProviderPriority { get; set; } = new() { "Aliyun", "Tencent" };

    /// <summary>
    /// 默认签名名称（可选）
    /// </summary>
    public string? DefaultSignName { get; set; }
}
```

### 阿里云配置 (AliyunSmsOptions)

| 参数 | 类型 | 默认值 | 必填 | 说明 |
|------|------|--------|------|------|
| `AccessKeyId` | string | - | ✅ | 阿里云访问密钥ID |
| `AccessKeySecret` | string | - | ✅ | 阿里云访问密钥Secret |
| `Endpoint` | string | "dysmsapi.aliyuncs.com" | ❌ | API端点 |

```csharp
public class AliyunSmsOptions
{
    /// <summary>
    /// 阿里云AccessKey ID
    /// </summary>
    public string AccessKeyId { get; set; } = string.Empty;

    /// <summary>
    /// 阿里云AccessKey Secret
    /// </summary>
    public string AccessKeySecret { get; set; } = string.Empty;

    /// <summary>
    /// 短信服务API端点
    /// </summary>
    public string Endpoint { get; set; } = "dysmsapi.aliyuncs.com";
}
```

### 腾讯云配置 (TencentSmsOptions)

| 参数 | 类型 | 默认值 | 必填 | 说明 |
|------|------|--------|------|------|
| `SecretId` | string | - | ✅ | 腾讯云密钥ID |
| `SecretKey` | string | - | ✅ | 腾讯云密钥Key |
| `SmsSdkAppId` | string | - | ✅ | 短信应用ID |
| `Region` | string | "ap-beijing" | ❌ | 地域 |

```csharp
public class TencentSmsOptions
{
    /// <summary>
    /// 腾讯云SecretId
    /// </summary>
    public string SecretId { get; set; } = string.Empty;

    /// <summary>
    /// 腾讯云SecretKey
    /// </summary>
    public string SecretKey { get; set; } = string.Empty;

    /// <summary>
    /// 短信SdkAppId
    /// </summary>
    public string SmsSdkAppId { get; set; } = string.Empty;

    /// <summary>
    /// 腾讯云地域
    /// </summary>
    public string Region { get; set; } = "ap-beijing";
}
```

## 🌍 多环境配置

### 环境特定配置文件

#### 开发环境 (`appsettings.Development.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": false,
    "DefaultSignName": "测试应用"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Debug"
    }
  }
}
```

#### 测试环境 (`appsettings.Staging.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Tencent",
    "EnableFailover": true,
    "ProviderPriority": ["Tencent", "Aliyun"],
    "DefaultSignName": "预发布应用"
  }
}
```

#### 生产环境 (`appsettings.Production.json`)
```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"],
    "DefaultSignName": "生产应用"
  },
  "Logging": {
    "LogLevel": {
      "PolySms": "Warning"
    }
  }
}
```

### 动态环境配置

```csharp
var environment = builder.Environment.EnvironmentName.ToLower();
var configFile = $"config/sms.{environment}.json";

// 如果环境特定配置不存在，则使用默认配置
if (!File.Exists(configFile))
{
    configFile = "config/sms.json";
}

builder.Services.AddPolySmsFromConfigFile(configFile);
```

### 条件配置

```csharp
// 根据环境动态配置
var isDevelopment = builder.Environment.IsDevelopment();

builder.Services.AddPolySms(
    sms => {
        sms.DefaultProvider = isDevelopment ? "Aliyun" : "Tencent";
        sms.EnableFailover = !isDevelopment; // 开发环境关闭故障转移
        sms.DefaultSignName = isDevelopment ? "测试应用" : "生产应用";
    },
    aliyun => {
        // 开发环境使用测试密钥，生产环境使用正式密钥
        aliyun.AccessKeyId = isDevelopment
            ? "test-access-key-id"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
        aliyun.AccessKeySecret = isDevelopment
            ? "test-access-key-secret"
            : Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_SECRET");
    },
    tencent => {
        tencent.SecretId = isDevelopment
            ? "test-secret-id"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_ID");
        tencent.SecretKey = isDevelopment
            ? "test-secret-key"
            : Environment.GetEnvironmentVariable("TENCENT_SECRET_KEY");
        tencent.SmsSdkAppId = isDevelopment
            ? "test-sdk-app-id"
            : Environment.GetEnvironmentVariable("TENCENT_SMS_SDK_APP_ID");
    }
);
```

## 🛡️ 安全最佳实践

### 1. 密钥管理

**❌ 不推荐：硬编码密钥**
```csharp
aliyun.AccessKeyId = "LTAI4FxxxxxxxxxxxxxxhFp4"; // 不安全！
```

**✅ 推荐：环境变量或密钥管理服务**
```csharp
aliyun.AccessKeyId = Environment.GetEnvironmentVariable("ALIYUN_ACCESS_KEY_ID");
// 或使用Azure Key Vault、AWS Secrets Manager等
```

### 2. 配置文件安全

```json
// ❌ 不要在appsettings.json中存储密钥
{
  "AliyunSms": {
    "AccessKeyId": "actual-key-id"  // 不安全！
  }
}

// ✅ 使用占位符，实际值通过环境变量提供
{
  "AliyunSms": {
    "AccessKeyId": "${ALIYUN_ACCESS_KEY_ID}",
    "Endpoint": "dysmsapi.aliyuncs.com"
  }
}
```

### 3. 版本控制排除

**.gitignore**：
```gitignore
# SMS配置文件
config/sms.local.json
config/sms.production.json
config/**/secrets.json

# 或者排除所有敏感配置
config/sms*.json
!config/sms.template.json  # 保留模板文件
```

### 4. 配置模板文件

创建 `config/sms.template.json` 作为配置模板：

```json
{
  "Sms": {
    "DefaultProvider": "Aliyun",
    "EnableFailover": true,
    "ProviderPriority": ["Aliyun", "Tencent"]
  },
  "AliyunSms": {
    "AccessKeyId": "REPLACE_WITH_ALIYUN_ACCESS_KEY_ID",
    "AccessKeySecret": "REPLACE_WITH_ALIYUN_ACCESS_KEY_SECRET",
    "Endpoint": "dysmsapi.aliyuncs.com"
  },
  "TencentSms": {
    "SecretId": "REPLACE_WITH_TENCENT_SECRET_ID",
    "SecretKey": "REPLACE_WITH_TENCENT_SECRET_KEY",
    "Region": "ap-beijing",
    "SmsSdkAppId": "REPLACE_WITH_SMS_SDK_APP_ID"
  }
}
```

## 🔍 配置验证和监控

### 启动时配置验证

```csharp
builder.Services.PostConfigure<SmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.DefaultProvider))
    {
        throw new InvalidOperationException("DefaultProvider must be specified");
    }

    if (!new[] { "Aliyun", "Tencent" }.Contains(options.DefaultProvider))
    {
        throw new InvalidOperationException($"Invalid DefaultProvider: {options.DefaultProvider}");
    }
});

builder.Services.PostConfigure<AliyunSmsOptions>(options =>
{
    if (string.IsNullOrEmpty(options.AccessKeyId) || string.IsNullOrEmpty(options.AccessKeySecret))
    {
        throw new InvalidOperationException("Aliyun AccessKeyId and AccessKeySecret must be provided");
    }
});
```

### 配置验证服务

```csharp
public static class ConfigurationValidator
{
    public static async Task ValidateSmsConfiguration(IServiceProvider services)
    {
        var logger = services.GetRequiredService<ILogger<Program>>();
        var smsService = services.GetRequiredService<ISmsService>();

        try
        {
            logger.LogInformation("开始验证PolySms配置...");

            // 检查可用的提供商
            var availableProviders = smsService.GetAvailableProviders().ToList();
            logger.LogInformation("可用提供商: {Providers}", string.Join(", ", availableProviders));

            foreach (var provider in availableProviders)
            {
                var isAvailable = smsService.IsProviderAvailable(provider);
                logger.LogInformation("提供商 {Provider}: {Status}",
                    provider, isAvailable ? "✅ 可用" : "❌ 不可用");
            }

            logger.LogInformation("PolySms配置验证完成");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "PolySms配置验证失败");
            throw;
        }
    }
}

// 在Program.cs中使用
var app = builder.Build();

// 验证配置
using (var scope = app.Services.CreateScope())
{
    await ConfigurationValidator.ValidateSmsConfiguration(scope.ServiceProvider);
}

app.Run();
```

### 健康检查

```csharp
// 添加健康检查
builder.Services.AddHealthChecks()
    .AddCheck<SmsHealthCheck>("sms");

// 自定义健康检查
public class SmsHealthCheck : IHealthCheck
{
    private readonly ISmsService _smsService;
    private readonly ILogger<SmsHealthCheck> _logger;

    public SmsHealthCheck(ISmsService smsService, ILogger<SmsHealthCheck> logger)
    {
        _smsService = smsService;
        _logger = logger;
    }

    public Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var availableProviders = _smsService.GetAvailableProviders().ToList();

            if (!availableProviders.Any())
            {
                return Task.FromResult(HealthCheckResult.Unhealthy("没有可用的短信提供商"));
            }

            var healthData = new Dictionary<string, object>
            {
                ["availableProviders"] = availableProviders,
                ["providerCount"] = availableProviders.Count
            };

            return Task.FromResult(HealthCheckResult.Healthy("短信服务正常", healthData));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "短信服务健康检查失败");
            return Task.FromResult(HealthCheckResult.Unhealthy("短信服务异常", ex));
        }
    }
}
```

### 配置热重载

```csharp
// 启用配置文件监听和热重载
builder.Configuration.AddJsonFile("config/sms.json",
    optional: false,
    reloadOnChange: true);  // 文件变更时自动重新加载

builder.Services.AddPolySms(builder.Configuration);

// 监听配置变更
builder.Services.Configure<SmsOptions>(
    builder.Configuration.GetSection("Sms"));

// 添加配置变更通知
builder.Services.AddSingleton<IOptionsMonitor<SmsOptions>, OptionsMonitor<SmsOptions>>();
```

## ❓ 常见问题

### Q: 如何在不同环境使用不同的提供商？

**A:** 使用环境特定的配置文件：

```json
// appsettings.Development.json - 开发环境用阿里云
{
  "Sms": {
    "DefaultProvider": "Aliyun"
  }
}

// appsettings.Production.json - 生产环境用腾讯云
{
  "Sms": {
    "DefaultProvider": "Tencent"
  }
}
```

### Q: 配置更新后需要重启应用吗？

**A:** 不需要。PolySms使用`IOptionsSnapshot`，支持配置热更新：

```csharp
// 配置会自动重新加载，无需重启应用
public class SmsController : ControllerBase
{
    private readonly IOptionsSnapshot<SmsOptions> _options;

    // 每次请求都会获取最新配置
    public async Task<IActionResult> Send()
    {
        var currentConfig = _options.Value; // 获取最新配置
        // ...
    }
}
```

### Q: 如何实现A/B测试配置？

**A:** 使用条件配置或Feature Flags：

```csharp
// 使用Feature Flags
builder.Services.AddFeatureManagement();

builder.Services.AddPolySms(sms =>
{
    var featureManager = builder.Services.BuildServiceProvider()
        .GetRequiredService<IFeatureManager>();

    sms.DefaultProvider = featureManager.IsEnabledAsync("UseTencentSms").Result
        ? "Tencent"
        : "Aliyun";
});
```

### Q: 如何处理配置文件权限问题？

**A:** 设置适当的文件权限：

```bash
# Linux/macOS 设置文件权限
chmod 600 config/sms.json           # 只有所有者可读写
chown app-user:app-group config/sms.json  # 设置文件所有者
```

### Q: 配置文件路径找不到怎么办？

**A:** 检查文件路径和权限：

```csharp
// 添加调试输出
var configPath = "config/sms.json";
if (!File.Exists(configPath))
{
    throw new FileNotFoundException($"配置文件未找到: {configPath}");
}

builder.Services.AddPolySmsFromConfigFile(configPath);
```

## 📋 配置检查清单

部署前请确认以下配置项：

### ✅ 基础配置
- [ ] `DefaultProvider` 已设置且有效
- [ ] 必要的提供商密钥已配置
- [ ] `EnableFailover` 根据环境需求设置
- [ ] `ProviderPriority` 顺序符合业务需求

### ✅ 安全配置
- [ ] 生产环境未硬编码密钥
- [ ] 环境变量或密钥管理服务已配置
- [ ] 配置文件未包含敏感信息
- [ ] 配置文件权限已正确设置

### ✅ 监控配置
- [ ] 日志级别适合环境
- [ ] 配置验证已启用
- [ ] 健康检查已配置
- [ ] 错误处理策略已设置

## ⚡ PolySms 优势

### 📦 轻量级架构
- **零第三方SDK依赖**：无需阿里云和腾讯云的厚重SDK包
- **包体积极小**：从传统的50MB减少到约20KB（99.96%减少）
- **配置更简单**：统一的配置格式，无需分别配置多个SDK

### 🚀 性能优势
- **启动更快**：无需加载大型SDK程序集
- **内存占用更少**：HTTP直接调用，减少80%内存开销
- **部署体积更小**：Docker镜像和部署包大幅减小

### 🔧 技术实现
- **HTTP直接调用**：绕过SDK，直接调用云服务API
- **自研签名算法**：内置阿里云RPC和腾讯云TC3-HMAC-SHA256签名
- **统一抽象接口**：为不同云厂商提供一致的使用体验
- **标准化错误处理**：ErrorCodeMapper统一处理不同提供商的错误码

### 🛡️ 安全优势
- **无第三方依赖风险**：避免第三方SDK的安全漏洞
- **自主可控**：核心逻辑完全自主实现
- **透明的安全实现**：开源代码，安全实现完全透明

使用本配置指南，您可以根据具体需求灵活配置PolySms，确保在不同环境下都能正常工作。